{
  "name": "Analiz_PORFELAY",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// Calc: Invested Amount1 - УЛУЧШЕННАЯ ВЕРСИЯ\n// n8n версия 1.116.2\n// ============================================================================\n// Расчет инвестированных средств с учетом комиссий и налогов\n// ============================================================================\n\n// Получаем все операции из входных данных\nconst operations = $input.all();\n\n// Инициализируем объект для хранения инвестиций по валютам\nconst investments = {};\n\n// Обрабатываем каждую операцию\nfor (const item of operations) {\n  const event = item.json.Event;\n  const currency = item.json.Currency;\n  const quantity = parseFloat(item.json.Quantity) || 0;\n  const feeTax = parseFloat(item.json.FeeTax) || 0;\n  \n  // Инициализируем валюту, если её ещё нет\n  if (!investments[currency]) {\n    investments[currency] = {\n      cash_in: 0,           // Пополнения счета\n      cash_out: 0,          // Выводы со счета\n      commissions: 0,       // Сумма комиссий (FEE)\n      dividend_taxes: 0,    // Налоги из дивидендов\n      cash_expenses: 0,     // Прочие расходы (налоги на прирост капитала и т.д.)\n      cash_gains: 0,        // Возвраты налогов и прочие доходы\n      net: 0,\n      count_in: 0,\n      count_out: 0,\n      count_fees: 0,\n      count_div_taxes: 0,\n      count_expenses: 0,\n      count_gains: 0\n    };\n  }\n  \n  // Обрабатываем операции пополнения\n  if (event === 'CASH_IN') {\n    investments[currency].cash_in += quantity;\n    investments[currency].count_in += 1;\n  }\n  \n  // Обрабатываем операции вывода\n  else if (event === 'CASH_OUT') {\n    investments[currency].cash_out += quantity;\n    investments[currency].count_out += 1;\n  }\n  \n  // Обрабатываем комиссии - везде, где есть FEE\n  else if (event === 'FEE') {\n    investments[currency].commissions += feeTax;\n    investments[currency].count_fees += 1;\n  }\n  \n  // Обрабатываем налоги из дивидендов - поле FeeTax для DIVIDEND\n  else if (event === 'DIVIDEND') {\n    if (feeTax > 0) {\n      investments[currency].dividend_taxes += feeTax;\n      investments[currency].count_div_taxes += 1;\n    }\n  }\n  \n  // Обрабатываем комиссии и налоги при других операциях (BUY, SELL и т.д.)\n  else if (event === 'BUY' || event === 'SELL' || event === 'CASH_CONVERT') {\n    if (feeTax > 0) {\n      investments[currency].commissions += feeTax;\n      investments[currency].count_fees += 1;\n    }\n  }\n  \n  // Обрабатываем прочие расходы (налоги на прирост капитала и т.д.)\n  else if (event === 'CASH_EXPENSE') {\n    investments[currency].cash_expenses += quantity;\n    investments[currency].count_expenses += 1;\n  }\n  \n  // Обрабатываем возвраты налогов и прочие доходы\n  else if (event === 'CASH_GAIN') {\n    investments[currency].cash_gains += quantity;\n    investments[currency].count_gains += 1;\n  }\n}\n\n// ============================================================================\n// Вычисляем чистые инвестиции для каждой валюты по формуле:\n// net_investment = cash_in - cash_out - commissions - dividend_taxes - cash_expenses + cash_gains\n// ============================================================================\n\nfor (const currency in investments) {\n  const inv = investments[currency];\n  inv.net = \n    inv.cash_in                    // Добавляем пополнения\n    - inv.cash_out                 // Вычитаем выводы\n    - inv.commissions              // Вычитаем все комиссии\n    - inv.dividend_taxes           // Вычитаем налоги из дивидендов\n    - inv.cash_expenses            // Вычитаем прочие расходы/налоги\n    + inv.cash_gains;              // Добавляем возвраты и прочие доходы\n}\n\n// ============================================================================\n// Формируем результат для вывода\n// ============================================================================\n\nconst result = [];\n\nfor (const currency in investments) {\n  const inv = investments[currency];\n  \n  result.push({\n    json: {\n      currency: currency,\n      // Основные компоненты\n      cash_in: inv.cash_in.toFixed(2),\n      cash_out: inv.cash_out.toFixed(2),\n      commissions_total: inv.commissions.toFixed(2),\n      dividend_taxes_total: inv.dividend_taxes.toFixed(2),\n      cash_expenses_total: inv.cash_expenses.toFixed(2),\n      cash_gains_total: inv.cash_gains.toFixed(2),\n      // Итоговая чистая инвестиция\n      net_investment: inv.net.toFixed(2),\n      // Количество операций\n      operations_in: inv.count_in,\n      operations_out: inv.count_out,\n      operations_fees: inv.count_fees,\n      operations_div_taxes: inv.count_div_taxes,\n      operations_expenses: inv.count_expenses,\n      operations_gains: inv.count_gains\n    }\n  });\n}\n\n// Добавляем итоговую запись с общей информацией\nresult.push({\n  json: {\n    currency: 'TOTAL_CURRENCIES',\n    total_currencies: Object.keys(investments).length,\n    comment: 'Summary of all currencies with commissions and taxes'\n  }\n});\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        -176
      ],
      "id": "332bf717-1c50-4ecf-8699-37ba40be7d2e",
      "name": "Calc: Invested Amount1"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "Mx0Nyr0grDFK3SNy",
          "mode": "list",
          "cachedResultName": "Operation_Kopilka",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/Mx0Nyr0grDFK3SNy"
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -144,
        -16
      ],
      "id": "fc39bd96-7304-4511-83f9-bf6b425c4ab9",
      "name": "STANDART-Get rows"
    },
    {
      "parameters": {
        "jsCode": "// Получаем все операции\nconst operations = $input.all();\n\n// Словарь для хранения позиций\nconst positions = {};\n\n// Функция для форматирования даты (ДД/ММ/ГГГГ)\nfunction formatDateShort(dateString) {\n  if (!dateString) return null;\n  const date = new Date(dateString);\n  const day = String(date.getDate()).padStart(2, '0');\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const year = date.getFullYear();\n  return `${day}/${month}/${year}`;\n}\n\n// Обрабатываем операции в хронологическом порядке\nfor (const item of operations) {\n  const data = item.json;\n  const symbol = data.Symbol;\n  const event = data.Event;\n  const quantity = parseFloat(data.Quantity) || 0;\n  const price = parseFloat(data.Price) || 0;\n  const nkd = parseFloat(data.NKD) || 0;\n  const currency = data.Currency;\n  const date = data.Date;\n  \n  // Пропускаем операции без символа\n  if (!symbol) continue;\n  \n  // Пропускаем валютные операции\n  if (['CASH_IN', 'CASH_OUT', 'CASH_CONVERT', 'CASH_GAIN', 'CASH_EXPENSE'].includes(event)) {\n    continue;\n  }\n  \n  // Инициализируем позицию\n  if (!positions[symbol]) {\n    positions[symbol] = {\n      quantity: 0,\n      total_cost: 0,\n      currency: currency,\n      first_purchase: null,\n      last_operation: null\n    };\n  }\n  \n  const pos = positions[symbol];\n  \n  // Обрабатываем разные типы операций\n  switch(event) {\n    case 'BUY':\n      // Покупка\n      const buyCost = (price + nkd) * quantity;\n      pos.quantity += quantity;\n      pos.total_cost += buyCost;\n      if (!pos.first_purchase) {\n        pos.first_purchase = date;\n      }\n      pos.last_operation = date;\n      break;\n      \n    case 'SELL':\n      // Продажа\n      const sellCost = (price + nkd) * quantity;\n      pos.quantity -= quantity;\n      pos.total_cost -= sellCost;\n      pos.last_operation = date;\n      break;\n      \n    case 'REPAYMENT':\n      // Погашение облигации\n      pos.quantity -= quantity;\n      pos.last_operation = date;\n      break;\n      \n    case 'DIVIDEND':\n    case 'STOCK_AS_DIVIDEND':\n    case 'AMORTISATION':\n    case 'SPLIT':\n    case 'FEE':\n    case 'CUSTOM_HOLDING_PRICE':\n    case 'CUSTOM_HOLDING_SETTINGS':\n      // Обновляем только дату последней операции\n      pos.last_operation = date;\n      break;\n  }\n}\n\n// Формируем результат только для активных позиций\nconst result = [];\n\nfor (const symbol in positions) {\n  const pos = positions[symbol];\n  \n  // Пропускаем проданные/погашенные активы\n  if (pos.quantity <= 0.0001) continue;\n  \n  // Вычисляем среднюю цену покупки\n  const avgBuyPrice = pos.total_cost / pos.quantity;\n  \n  // Формируем объект позиции с требуемыми полями\n  result.push({\n    json: {\n      Symbol: symbol,\n      Currency: pos.currency,\n      Quantity: parseFloat(pos.quantity.toFixed(4)),\n      AvgBuyPrice: parseFloat(avgBuyPrice.toFixed(2)),\n      TotalInvested: parseFloat(pos.total_cost.toFixed(2)),\n      FirstPurchaseDate: formatDateShort(pos.first_purchase),\n      LastOperationDate: formatDateShort(pos.last_operation)\n    }\n  });\n}\n\n// Сортируем по TotalInvested (убывание)\nresult.sort((a, b) => b.json.TotalInvested - a.json.TotalInvested);\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        -16
      ],
      "id": "a8e4cce0-31c9-4e4e-b37f-875f38b7b3d4",
      "name": "Calc: Portfolio Composition"
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1152,
        208
      ],
      "id": "aa6df982-befc-4398-90f6-ba738610ae94",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities/{{ $json.Symbol }}.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "boards"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 5000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        624,
        256
      ],
      "id": "4fd0d548-aa67-4c3a-9824-88085736bf59",
      "name": "Find Board",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Приоритет boards для разных типов активов\nconst priorityBoards = ['TQBR', 'TQTF', 'TQCB', 'TQOB', 'TQOD', 'TQEU', 'TQCN', 'CETS'];\n\n// Обработка всех входящих элементов\nconst results = [];\n\nfor (const item of $input.all()) {\n  const data = item.json;\n  \n  try {\n    // ВАЖНО: Данные приходят в виде полного HTTP ответа\n    // Нам нужно достать Symbol из исходных данных ДО парсинга\n    // К сожалению, в Code узле его нет...\n    // Поэтому используем индекс из массива\n    const itemIndex = item._index || item.index;\n    \n    // Парсим JSON из поля body\n    let boardsResponse;\n    if (typeof data.body === 'string') {\n      boardsResponse = JSON.parse(data.body);\n    } else {\n      boardsResponse = data.body;\n    }\n    \n    // Получаем Symbol из первой строки данных (это ISIN/тикер)\n    const symbol = boardsResponse.boards?.data[0]?.[0] || 'UNKNOWN';\n    \n    const boardsData = boardsResponse.boards;\n    \n    if (!boardsData || !boardsData.data || boardsData.data.length === 0) {\n      results.push({\n        json: {\n          Symbol: symbol,\n          Board: null,\n          Engine: null,\n          Market: null,\n          Error: 'No boards found'\n        }\n      });\n      continue;\n    }\n    \n    // Создаем индекс для быстрого поиска колонок\n    const columnIndex = {};\n    boardsData.columns.forEach((col, idx) => {\n      columnIndex[col] = idx;\n    });\n    \n    // Ищем подходящий board по приоритету\n    let selectedBoard = null;\n    \n    for (const priorityBoard of priorityBoards) {\n      for (let i = 0; i < boardsData.data.length; i++) {\n        const boardId = boardsData.data[i][columnIndex['boardid']];\n        const isTraded = boardsData.data[i][columnIndex['is_traded']];\n        \n        if (boardId === priorityBoard && isTraded === 1) {\n          selectedBoard = {\n            boardid: boardId,\n            engine: boardsData.data[i][columnIndex['engine']],\n            market: boardsData.data[i][columnIndex['market']]\n          };\n          break;\n        }\n      }\n      if (selectedBoard) break;\n    }\n    \n    // Если не нашли по приоритету, берем первый активный\n    if (!selectedBoard) {\n      for (let i = 0; i < boardsData.data.length; i++) {\n        const isTraded = boardsData.data[i][columnIndex['is_traded']];\n        \n        if (isTraded === 1) {\n          selectedBoard = {\n            boardid: boardsData.data[i][columnIndex['boardid']],\n            engine: boardsData.data[i][columnIndex['engine']],\n            market: boardsData.data[i][columnIndex['market']]\n          };\n          break;\n        }\n      }\n    }\n    \n    if (!selectedBoard) {\n      results.push({\n        json: {\n          Symbol: symbol,\n          Board: null,\n          Engine: null,\n          Market: null,\n          Error: 'No active boards'\n        }\n      });\n      continue;\n    }\n    \n    // Возвращаем результат\n    results.push({\n      json: {\n        Symbol: symbol,\n        Board: selectedBoard.boardid,\n        Engine: selectedBoard.engine,\n        Market: selectedBoard.market\n      }\n    });\n    \n  } catch (error) {\n    console.log(`Ошибка: ${error.message}`);\n    results.push({\n      json: {\n        Symbol: 'ERROR',\n        Board: null,\n        Engine: null,\n        Market: null,\n        Error: error.message\n      }\n    });\n  }\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        256
      ],
      "id": "f7c94e82-3ef2-44b1-b4c7-26e474259b19",
      "name": "Parse Boards"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4e0fb2f8-e29b-45a4-9c58-eddd4dcec84b",
              "leftValue": "={{ $json.Board }}",
              "rightValue": "null",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        688,
        -128
      ],
      "id": "bb4b9e8a-8cb6-413f-a21b-808f6c8ffe5b",
      "name": "If"
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        400,
        80
      ],
      "id": "8fcfa311-520d-40d4-bc1c-0da9ee4e7f04",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "jsCode": "// Функция для форматирования даты\nfunction formatDate(dateString) {\n  if (!dateString || dateString === '0000-00-00' || dateString === null) {\n    return null;\n  }\n  \n  try {\n    const date = new Date(dateString);\n    // Проверяем, является ли дата валидной\n    if (isNaN(date.getTime())) {\n      return null;\n    }\n    \n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = date.getFullYear();\n    \n    return `${day}.${month}.${year}`;\n  } catch (error) {\n    return null;\n  }\n}\n\n// Основная логика парсинга\nconst items = $input.all();\n\nreturn items.map((item) => {\n  try {\n    // Получаем данные из тела ответа\n    const response = item.json?.body || item.json || {};\n    \n    // Извлекаем массивы securities и marketdata\n    const securitiesData = response.securities?.data?.[0] || [];\n    const securitiesColumns = response.securities?.columns || [];\n    \n    const marketdataData = response.marketdata?.data?.[0] || [];\n    const marketdataColumns = response.marketdata?.columns || [];\n    \n    // Функция для получения значения по названию колонки\n    function getValueFromArray(dataArray, columnsArray, columnName) {\n      const index = columnsArray.indexOf(columnName);\n      return index !== -1 ? dataArray[index] : null;\n    }\n    \n    // Извлекаем требуемые поля\n    const result = {\n      // Securities fields\n      SECID: getValueFromArray(securitiesData, securitiesColumns, 'SECID'),\n      BOARDID: getValueFromArray(securitiesData, securitiesColumns, 'BOARDID'),\n      SHORTNAME: getValueFromArray(securitiesData, securitiesColumns, 'SHORTNAME'),\n      PREVPRICE: getValueFromArray(securitiesData, securitiesColumns, 'PREVPRICE'),\n      FACEVALUE: getValueFromArray(securitiesData, securitiesColumns, 'FACEVALUE'),\n      STATUS: getValueFromArray(securitiesData, securitiesColumns, 'STATUS'),\n      ISIN: getValueFromArray(securitiesData, securitiesColumns, 'ISIN'),\n      PREVLEGALCLOSEPRICE: getValueFromArray(securitiesData, securitiesColumns, 'PREVLEGALCLOSEPRICE'),\n      SECTYPE: getValueFromArray(securitiesData, securitiesColumns, 'SECTYPE'),\n      COUPONPERCENT: getValueFromArray(securitiesData, securitiesColumns, 'COUPONPERCENT'),\n      COUPONVALUE: getValueFromArray(securitiesData, securitiesColumns, 'COUPONVALUE'),\n      MATDATE: getValueFromArray(securitiesData, securitiesColumns, 'MATDATE'),\n      OFFERDATE: getValueFromArray(securitiesData, securitiesColumns, 'OFFERDATE'),\n      ACCRUEDINT: getValueFromArray(securitiesData, securitiesColumns, 'ACCRUEDINT'),\n      CURRENCYID: getValueFromArray(securitiesData, securitiesColumns, 'CURRENCYID'),\n      \n      // Marketdata fields\n      LCURRENTPRICE: getValueFromArray(marketdataData, marketdataColumns, 'LCURRENTPRICE'),\n      YIELD: getValueFromArray(marketdataData, marketdataColumns, 'YIELD'),\n      DURATION: getValueFromArray(marketdataData, marketdataColumns, 'DURATION'),\n      YIELDATWAPRICE: getValueFromArray(marketdataData, marketdataColumns, 'YIELDATWAPRICE')\n    };\n    \n    // Обработка FACEUNIT: замена \"SUR\" на \"RUB\"\n    let faceUnit = getValueFromArray(securitiesData, securitiesColumns, 'FACEUNIT');\n    result.FACEUNIT = faceUnit === 'SUR' ? 'RUB' : faceUnit;\n        \n    // Форматирование дат\n    const nextCouponRaw = getValueFromArray(securitiesData, securitiesColumns, 'NEXTCOUPON');\n    result.NEXTCOUPON_FORMATTED = formatDate(nextCouponRaw);\n    \n    result.MATDATE_FORMATTED = formatDate(result.MATDATE);\n    result.OFFERDATE_FORMATTED = formatDate(result.OFFERDATE);\n    \n    return { json: result };\n    \n  } catch (error) {\n    // В случае ошибки возвращаем объект с информацией об ошибке\n    return {\n      json: {\n        error: true,\n        errorMessage: error.message,\n        originalData: item.json\n      }\n    };\n  }\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1696,
        272
      ],
      "id": "401bc1e3-0155-4c5b-8dc2-0f03384df26b",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/engines/{{ $json.Engine }}/markets/{{ $json.Market }}/boards/{{ $json.Board }}/securities/{{ $json.Symbol }}.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "securities,marketdata,description"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 2000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        272
      ],
      "id": "7330733e-4cbd-40d1-a975-742c11f81bf0",
      "name": "Fetch MOEX Data1",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities/{{ $json.Symbol }}.json\n",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "description"
            },
            {
              "name": "description.columns",
              "value": "name,title,value"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 2000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1344,
        -208
      ],
      "id": "489c0bad-4d5f-4f13-a6f3-ad3e55cad364",
      "name": "Find Board1",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Получаем входные данные\nconst items = $input.all();\nconst result = [];\n\n// Обработка каждого элемента входных данных\nfor (const item of items) {\n  const json = item.json;\n  \n  // Проверяем наличие описания\n  if (json.body && json.body.description) {\n    const description = json.body.description;\n    const data = description.data; // Массив массивов\n    \n    // Преобразуем массив [name, title, value] в объект\n    const parsed = {};\n    for (const row of data) {\n      if (Array.isArray(row) && row.length >= 3) {\n        const fieldName = row[0];  // \"SECID\", \"ISIN\" и т.д.\n        const fieldValue = row[2]; // Значение\n        parsed[fieldName] = fieldValue;\n      }\n    }\n    \n    // Нормализация валюты: SUR -> RUB\n    const faceUnit = parsed.FACEUNIT || 'RUB';\n    const normalizedFaceUnit = faceUnit === 'SUR' ? 'RUB' : faceUnit;\n    \n    // Форматируем выходные данные\n    const output = {\n      SECID: parsed.SECID || '',\n      SHORTNAME: parsed.SHORTNAME || '',\n      ISIN: parsed.ISIN || parsed.SECID || '',\n      MATDATE: parsed.MATDATE || '',\n      INITIALFACEVALUE: Number(parsed.INITIALFACEVALUE || 1000),\n      FACEUNIT: normalizedFaceUnit,\n      HASDEFAULT: parsed.HASDEFAULT === '1' || parsed.HASDEFAULT === 1,\n      HASTECHNICALDEFAULT: parsed.HASTECHNICALDEFAULT === '1' || parsed.HASTECHNICALDEFAULT === 1,\n      DAYSTOREDEMPTION: Number(parsed.DAYSTOREDEMPTION || 0),\n      FACEVALUE: Number(parsed.FACEVALUE || 1000),\n      COUPONFREQUENCY: Number(parsed.COUPONFREQUENCY || 0),\n      COUPONDATE: parsed.COUPONDATE || '',\n      COUPONPERCENT: Number(parsed.COUPONPERCENT || 0),\n      COUPONVALUE: Number(parsed.COUPONVALUE || 0),\n      TYPENAME: parsed.TYPENAME || '',\n      GROUP: parsed.GROUP || '',\n      TYPE: parsed.TYPE || '',\n      GROUPNAME: parsed.GROUPNAME || '',\n      EMITTER_ID: String(parsed.EMITTER_ID || '')\n    };\n    \n    result.push({ json: output });\n  }\n}\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1664,
        -208
      ],
      "id": "11e1712f-7500-4080-8296-89918eacbd59",
      "name": "Code in JavaScript1",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1120,
        -368
      ],
      "id": "95d33989-1ed4-441a-b359-74f2ed11029d",
      "name": "Loop Over Items2"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "SECID",
        "joinMode": "enrichInput1",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2016,
        -112
      ],
      "id": "2d327dab-c0ab-448a-abef-6f6875f72405",
      "name": "Merge"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "SECID",
              "field2": "Symbol"
            }
          ]
        },
        "joinMode": "enrichInput1",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2224,
        -32
      ],
      "id": "2c0eee75-6d89-41d9-83ed-ed418cb77871",
      "name": "Merge1"
    },
    {
      "parameters": {
        "url": "https://www.cbr-xml-daily.ru/latest.js",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json, text/javascript"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        144,
        464
      ],
      "id": "00b9f907-41db-459a-962b-6530dcec8305",
      "name": "Get Currency Rates from MOEX"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2528,
        -16
      ],
      "id": "3006b295-6a9d-4d68-8d0e-1ce63078a544",
      "name": "Merge2"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ПАРСИНГ КУРСОВ ВАЛЮТ ЦБ РФ - МИНИМАЛЬНЫЙ ФОРМАТ\n * n8n v1.116.2\n * \n * Возвращает только необходимые данные\n */\n\ntry {\n  const input = $input.item.json;\n  \n  if (!input.body || !input.body.rates) {\n    throw new Error('Invalid response: missing rates data');\n  }\n  \n  const data = input.body;\n  \n  // Основные валюты для портфеля\n  const currencyCodes = {\n    'USD': 2,   // 2 знака для отображения\n    'EUR': 2,\n    'CNY': 2\n  };\n  \n  // Инициализируем результат\n  const rates = {\n    'RUB': 1\n  };\n  \n  // Обрабатываем валюты\n  for (const [code, decimals] of Object.entries(currencyCodes)) {\n    if (data.rates[code]) {\n      const inverseRate = parseFloat(data.rates[code]);\n      const directRate = 1 / inverseRate;\n      \n      // Округляем до нужного количества знаков\n      rates[code] = Math.round(directRate * Math.pow(10, decimals)) / Math.pow(10, decimals);\n    }\n  }\n  \n  // Возвращаем только timestamp и rates\n  return [{\n    json: {\n      timestamp: new Date().toISOString(),\n      rates: rates\n    }\n  }];\n  \n} catch (error) {\n  console.error('Error:', error.message);\n  \n  return [{\n    json: {\n      timestamp: new Date().toISOString(),\n      rates: {\n        'RUB': 1,\n        'USD': 79.47,\n        'EUR': 92.25,\n        'CNY': 11.17,\n        'GBP': 105.52\n      }\n    }\n  }];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1920,
        464
      ],
      "id": "89b6237a-deb2-4e04-b007-3a7f465bcc64",
      "name": "Code Kurs"
    },
    {
      "parameters": {
        "jsCode": "// Получаем входные данные\nconst items = $input.all();\nconst result = [];\n\n// Обрабатываем каждый входной элемент\nfor (const item of items) {\n  const json = item.json;\n  \n  // Проверяем наличие структуры securities\n  if (json.securities && json.securities.columns && json.securities.data) {\n    const columns = json.securities.columns;\n    const dataRows = json.securities.data;\n    \n    // Находим индексы нужных полей\n    const secidIdx = columns.indexOf('secid');\n    const shortnameIdx = columns.indexOf('shortname');\n    const emitentIdIdx = columns.indexOf('emitent_id');\n    const emitentTitleIdx = columns.indexOf('emitent_title');\n    \n    // Проверяем, что все поля найдены\n    if (secidIdx !== -1 && shortnameIdx !== -1 && emitentIdIdx !== -1 && emitentTitleIdx !== -1) {\n      let bestRow = null;\n      \n      // Стратегия выбора строки:\n      // 1. Приоритет: строка со ВСЕМИ заполненными нужными полями (emitent_id и emitent_title не null)\n      // 2. Если таких нет: строка, где есть хотя бы один из них\n      // 3. Если ничего не заполнено: первая строка\n      \n      for (let i = 0; i < dataRows.length; i++) {\n        const row = dataRows[i];\n        const emitentId = row[emitentIdIdx];\n        const emitentTitle = row[emitentTitleIdx];\n        \n        if (bestRow === null) {\n          bestRow = row;\n        } else {\n          const bestEmitentId = bestRow[emitentIdIdx];\n          const bestEmitentTitle = bestRow[emitentTitleIdx];\n          \n          // Проверяем, полная ли текущая строка\n          const hasFullData = emitentId !== null && emitentTitle !== null;\n          const bestHasFullData = bestEmitentId !== null && bestEmitentTitle !== null;\n          \n          if (hasFullData && !bestHasFullData) {\n            // Текущая полная, лучшая - нет, берем текущую\n            bestRow = row;\n          } else if (!hasFullData && !bestHasFullData) {\n            // Обе неполные, но текущая может быть лучше\n            const hasAnyData = emitentId !== null || emitentTitle !== null;\n            const bestHasAnyData = bestEmitentId !== null || bestEmitentTitle !== null;\n            \n            if (hasAnyData && !bestHasAnyData) {\n              bestRow = row;\n            }\n          }\n        }\n      }\n      \n      // Формируем результат из лучшей строки\n      if (bestRow !== null) {\n        result.push({\n          json: {\n            secid: bestRow[secidIdx],\n            shortname: bestRow[shortnameIdx],\n            emitent_id: bestRow[emitentIdIdx],\n            emitent_title: bestRow[emitentTitleIdx]\n          }\n        });\n      }\n    }\n  }\n}\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5232,
        -1120
      ],
      "id": "c5ee0c5f-6ff2-42e9-81f2-a7d51c8fb4d9",
      "name": "Code_SECID&market"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities.json?iss.only=securities,boards,description",
        "allowUnauthorizedCerts": true,
        "options": {},
        "queryParametersUi": {
          "parameter": [
            {
              "name": "q",
              "value": "={{ $json.SECID }}"
            },
            {
              "name": "iss.meta",
              "value": "off"
            }
          ]
        }
      },
      "id": "3c6b0489-2a6d-46e7-bc31-3f98673902a4",
      "name": "SecID → Security Info1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        4976,
        -1120
      ],
      "retryOnFail": false
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4768,
        -1184
      ],
      "id": "0b78d851-428c-415e-b0e9-06664aa12201",
      "name": "Loop Over Items3"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "wrAvyTKEv5CPA0RM",
          "mode": "list",
          "cachedResultName": "SCEID_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/wrAvyTKEv5CPA0RM"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "SCEID": "={{ $json.secid }}",
            "SHORT_NAME": "={{ $json.shortname }}",
            "EMITER_ID": "={{ $json.emitent_id }}",
            "Name_EMITER": "={{ $json.emitent_title }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "SCEID",
              "displayName": "SCEID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "SHORT_NAME",
              "displayName": "SHORT_NAME",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "EMITER_ID",
              "displayName": "EMITER_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Name_EMITER",
              "displayName": "Name_EMITER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4976,
        -1280
      ],
      "id": "4c3bb61c-9cfd-4c66-93fb-2adcd503e038",
      "name": "Insert row SECID_Portfolio"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me",
      "typeVersion": 1,
      "position": [
        1520,
        192
      ],
      "id": "c8889e42-ead7-44b3-bedf-faa1b818baf0"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me1",
      "typeVersion": 1,
      "position": [
        1520,
        -384
      ],
      "id": "a86fb580-7533-4896-9cb3-89e7e620ac5c"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me2",
      "typeVersion": 1,
      "position": [
        1120,
        -544
      ],
      "id": "35641eeb-73a4-44d6-ac85-a31a106f96df"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me3",
      "typeVersion": 1,
      "position": [
        1280,
        768
      ],
      "id": "08c38ed7-60f7-441b-91b3-8983681daff4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3888,
        -32
      ],
      "id": "9a360c5e-0dbd-40cb-af8c-0b2f8d2d35c3",
      "name": "Merge3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me4",
      "typeVersion": 1,
      "position": [
        3200,
        -544
      ],
      "id": "0621ea79-08cc-442d-be7b-1e1638da76dc"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================================================\n * АНАЛИЗ ПОРТФЕЛЯ - УЗЕЛ CODE N8N (версия 1.116.2) - v10 ФИНАЛЬНАЯ\n * ============================================================================\n * \n * ДОБАВЛЕНО В v10:\n * \n * ✓ portfolio_absolute_profit_rub - абсолютная прибыль в рублях\n * ✓ portfolio_gain_percent - относительный рост в процентах\n * \n * Формулы:\n *   portfolio_absolute_profit_rub = portfolio_current_value - net_investment\n *   portfolio_gain_percent = (portfolio_absolute_profit / net_investment) × 100\n * \n * ============================================================================\n */\n\n// ============================================================================\n// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ\n// ============================================================================\n\nconst SECTYPE_MAP = {\n  '1': { name: 'Акция', group: 'stocks' },\n  '2': { name: 'Акция', group: 'stocks' },\n  '3': { name: 'ОФЗ', group: 'ofz' },\n  '4': { name: 'Муниципальная облигация', group: 'municipal_bonds' },\n  '5': { name: 'ОФЗ', group: 'ofz' },\n  '6': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '7': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '8': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '9': { name: 'ETF', group: 'etf' },\n  'A': { name: 'ETF', group: 'etf' },\n  'B': { name: 'ETF', group: 'etf' },\n  'C': { name: 'Ипотечные сертификаты участия', group: 'other' },\n  'D': { name: 'Депозитарные расписки', group: 'other' },\n  'E': { name: 'Варранты', group: 'other' },\n  'F': { name: 'Еврооблигации', group: 'eurobonds' },\n  'G': { name: 'Векселя', group: 'other' },\n  'H': { name: 'Залоговые расписки', group: 'other' },\n  'J': { name: 'ETF', group: 'etf' },\n  'K': { name: 'ETF', group: 'etf' },\n  'L': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  'M': { name: 'Деривативы, фьючерсы и т.д.', group: 'other' }\n};\n\n// ╔═══════════════════════════════════════════════════════════════════════════╗\n// ║ КОНСТАНТА: ДОХОДНОСТЬ ETF                                                ║\n// ║ Для всех ETF устанавливается фиксированное значение YIELDATWAPRICE       ║\n// ║ РЕДАКТИРУЙ ЗДЕСЬ, ЕСЛИ НУЖНО ИЗМЕНИТЬ ПРОЦЕНТ ДОХОДНОСТИ ETF            ║\n// ╚═══════════════════════════════════════════════════════════════════════════╝\nconst ETF_YIELD_ATWAPRICE = 15.3;  // Доходность ETF в процентах\n// ═══════════════════════════════════════════════════════════════════════════\n\nfunction isETFType(sectype) {\n  const etfCodes = ['9', 'A', 'B', 'J', 'K'];\n  return etfCodes.includes(sectype);\n}\n\nfunction getAssetTypeWithFaceUnit(sectype, faceUnit) {\n  const typeInfo = SECTYPE_MAP[sectype] || { name: 'Прочее', group: 'other' };\n  \n  const corpBondCodes = ['6', '7', '8', 'L'];\n  if (corpBondCodes.includes(sectype) && faceUnit && faceUnit !== 'RUB' && faceUnit !== 'SUR') {\n    return { name: 'Еврооблигации', group: 'eurobonds' };\n  }\n  \n  return typeInfo;\n}\n\nfunction toNumber(value, defaultValue = 0) {\n  if (value === null || value === undefined || value === '') return defaultValue;\n  const num = parseFloat(value);\n  return isNaN(num) ? defaultValue : num;\n}\n\nfunction roundTo(value, decimals = 2) {\n  return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);\n}\n\nfunction formatCurrency(value, decimals = 2) {\n  return new Intl.NumberFormat('ru-RU', {\n    minimumFractionDigits: decimals,\n    maximumFractionDigits: decimals\n  }).format(value);\n}\n\nfunction formatPercent(value, decimals = 2) {\n  return roundTo(value, decimals) + '%';\n}\n\nfunction getExchangeRate(currencyId, rates) {\n  const normalizedCurrency = (currencyId === 'SUR') ? 'RUB' : currencyId;\n  \n  if (normalizedCurrency === 'RUB') {\n    return 1;\n  }\n  \n  if (rates && rates[normalizedCurrency]) {\n    return rates[normalizedCurrency];\n  }\n  \n  console.warn(`Exchange rate for ${normalizedCurrency} not found. Using 1.0`);\n  return 1;\n}\n\nfunction calculateNKDInRUB(accruedInt, currencyId, rates) {\n  if (!accruedInt || accruedInt === 0 || accruedInt === null) {\n    return 0;\n  }\n  \n  const normalizedCurrency = (currencyId === 'SUR') ? 'RUB' : currencyId;\n  const exchangeRate = getExchangeRate(currencyId, rates);\n  const nkdInRUB = toNumber(accruedInt, 0) * exchangeRate;\n  \n  return nkdInRUB;\n}\n\nfunction calculateCurrentValueRUB(asset, rates) {\n  const quantity = toNumber(asset.Quantity, 0);\n  const lcurrentprice = toNumber(asset.LCURRENTPRICE, 0);\n  const facevalue = toNumber(asset.FACEVALUE, 0);\n  const initialfacevalue = toNumber(asset.INITIALFACEVALUE, 1000);\n  const faceUnit = asset.FACEUNIT || 'RUB';\n  const sectype = asset.SECTYPE || '';\n  \n  const faceUnitExchangeRate = getExchangeRate(faceUnit, rates);\n  \n  if (isETFType(sectype)) {\n    return quantity * lcurrentprice * faceUnitExchangeRate;\n  } else {\n    const nominality = facevalue > 0 ? facevalue : initialfacevalue;\n    const priceWithoutNKD = (lcurrentprice / 100) * nominality;\n    const nkdInRUB = calculateNKDInRUB(asset.ACCRUEDINT, asset.CURRENCYID, rates);\n    const priceWithNKDInRUB = (priceWithoutNKD * faceUnitExchangeRate) + nkdInRUB;\n    const valueInRUB = quantity * priceWithNKDInRUB;\n    \n    return valueInRUB;\n  }\n}\n\nfunction calculateCurrentPriceWithoutNKD(asset) {\n  const lcurrentprice = toNumber(asset.LCURRENTPRICE, 0);\n  const facevalue = toNumber(asset.FACEVALUE, 0);\n  const initialfacevalue = toNumber(asset.INITIALFACEVALUE, 1000);\n  const sectype = asset.SECTYPE || '';\n  \n  if (isETFType(sectype)) {\n    return lcurrentprice;\n  } else {\n    const nominality = facevalue > 0 ? facevalue : initialfacevalue;\n    const price = (lcurrentprice / 100) * nominality;\n    return price;\n  }\n}\n\nfunction getYieldValue(asset) {\n  const sectype = asset.SECTYPE || '';\n  \n  if (isETFType(sectype)) {\n    return ETF_YIELD_ATWAPRICE;\n  } else {\n    let yield_value = toNumber(asset.YIELDATWAPRICE, null);\n    if (yield_value === null || yield_value === 0) {\n      yield_value = toNumber(asset.YIELD, null);\n    }\n    return yield_value;\n  }\n}\n\nfunction isRealAsset(asset) {\n  return asset.SECID && typeof asset.SECID === 'string' && \n         asset.SECID.trim() !== '' &&\n         asset.Symbol !== undefined;\n}\n\n// ============================================================================\n// ОСНОВНАЯ ЛОГИКА АНАЛИЗА\n// ============================================================================\n\ntry {\n  const allItems = $input.all();\n  const allData = allItems.map(item => item.json).filter(json => json && typeof json === 'object');\n  \n  if (!allData || allData.length === 0) {\n    throw new Error('Входные данные пусты или неправильного формата');\n  }\n\n  let netInvestmentRUB = 0;\n  let exchangeRates = { RUB: 1, USD: 1, EUR: 1, CNY: 1 };\n  const assets = [];\n\n  allData.forEach(item => {\n    if (item.rates && typeof item.rates === 'object') {\n      exchangeRates = item.rates;\n    } else if (item.currency === 'RUB' && item.cash_in !== undefined) {\n      netInvestmentRUB = toNumber(item.net_investment, 0);\n    } else if (item.currency === 'TOTAL_CURRENCIES' || item.total_currencies !== undefined) {\n      return;\n    } else if (isRealAsset(item)) {\n      assets.push(item);\n    }\n  });\n\n  if (assets.length === 0) {\n    throw new Error('Не найдено ни одного актива в данных.');\n  }\n\n  const analysis = {\n    portfolio_name: 'KOPILKA',\n    analysis_timestamp: new Date().toISOString(),\n    total_assets_count: 0,\n    portfolio_current_value_rub: 0,\n    portfolio_absolute_profit_rub: 0,\n    portfolio_gain_percent: 0,\n    average_coupon_yield: 0,\n    portfolio_yield_by_current_value: 0,\n    portfolio_yield_roi: 0,\n    portfolio_yield_average: 0,\n    net_investment: netInvestmentRUB,\n    asset_distribution: {},\n    assets_with_default: [],\n    assets_with_technical_default: [],\n    top_profitable_rub: [],\n    top_profitable_foreign: [],\n    bottom_profitable_rub: [],\n    bottom_profitable_foreign: []\n  };\n\n  const assetTypeDistribution = {};\n  let totalCurrentValueRUB = 0;\n  let validAssetsCount = 0;\n\n  let totalWeightedYield = 0;\n  let totalQuantityForYield = 0;\n\n  let totalYieldCurrentWeighted = 0;\n  let totalCurrentValueForYield = 0;\n  \n  let totalYieldROIWeighted = 0;\n  let totalInvestedValueForYield = 0;\n\n  const profitableAssets = [];\n  const profitableAssetsByForeignCurrency = [];\n\n  // =========================================================================\n  // ОБРАБОТКА КАЖДОГО АКТИВА\n  // =========================================================================\n\n  assets.forEach(asset => {\n    const currentValueRUB = calculateCurrentValueRUB(asset, exchangeRates);\n    \n    if (currentValueRUB === 0 || !isFinite(currentValueRUB)) {\n      return;\n    }\n\n    validAssetsCount += 1;\n\n    const sectype = asset.SECTYPE || '';\n    const faceUnit = asset.FACEUNIT || 'RUB';\n    const shortName = asset.SHORTNAME || asset.SECID || 'Unknown';\n    const quantity = toNumber(asset.Quantity, 0);\n    const couponPercent = toNumber(asset.COUPONPERCENT, null);\n    const hasDefault = asset.HASDEFAULT ? true : false;\n    const hasTechDefault = asset.HASTECHNICALDEFAULT ? true : false;\n    \n    const assetTypeInfo = getAssetTypeWithFaceUnit(sectype, faceUnit);\n    const assetTypeName = assetTypeInfo.name;\n\n    if (!assetTypeDistribution[assetTypeName]) {\n      assetTypeDistribution[assetTypeName] = {\n        count: 0,\n        total_value_rub: 0,\n        percent: 0\n      };\n    }\n    \n    assetTypeDistribution[assetTypeName].count += 1;\n    assetTypeDistribution[assetTypeName].total_value_rub += currentValueRUB;\n    totalCurrentValueRUB += currentValueRUB;\n    \n    const yield_value = getYieldValue(asset);\n    \n    if (assetTypeName !== 'Еврооблигации' && couponPercent !== null && couponPercent > 0) {\n      totalWeightedYield += couponPercent * quantity;\n      totalQuantityForYield += quantity;\n    }\n    \n    if (yield_value !== null && yield_value !== 0) {\n      \n      const priceWithoutNKD = calculateCurrentPriceWithoutNKD(asset);\n      const currentValueInNativeCurrencyWithoutNKD = quantity * priceWithoutNKD;\n      \n      totalYieldCurrentWeighted += (yield_value / 100) * currentValueInNativeCurrencyWithoutNKD;\n      totalCurrentValueForYield += currentValueInNativeCurrencyWithoutNKD;\n      \n      const avgBuyPrice = toNumber(asset.AvgBuyPrice, 0);\n      const investedSum = quantity * avgBuyPrice;\n      \n      totalYieldROIWeighted += (yield_value / 100) * investedSum;\n      totalInvestedValueForYield += investedSum;\n    }\n    \n    if (hasDefault) {\n      analysis.assets_with_default.push({\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        current_value_rub: roundTo(currentValueRUB, 2)\n      });\n    }\n    \n    if (hasTechDefault) {\n      analysis.assets_with_technical_default.push({\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        current_value_rub: roundTo(currentValueRUB, 2)\n      });\n    }\n    \n    if (!hasDefault && yield_value !== null && yield_value !== 0) {\n      const assetRecord = {\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        yield: roundTo(yield_value, 2),\n        current_value_rub: roundTo(currentValueRUB, 2),\n        faceunit: faceUnit,\n        quantity: quantity,\n        coupon_percent: couponPercent !== null ? roundTo(couponPercent, 2) : 'N/A'\n      };\n      \n      if (faceUnit === 'RUB' || faceUnit === 'SUR') {\n        profitableAssets.push(assetRecord);\n      } else {\n        profitableAssetsByForeignCurrency.push(assetRecord);\n      }\n    }\n  });\n\n  // =========================================================================\n  // РАСЧЕТЫ ФИНАЛЬНЫХ МЕТРИК\n  // =========================================================================\n\n  if (totalQuantityForYield > 0) {\n    analysis.average_coupon_yield = roundTo(totalWeightedYield / totalQuantityForYield, 2);\n  }\n\n  if (totalCurrentValueForYield > 0) {\n    analysis.portfolio_yield_by_current_value = roundTo(\n      (totalYieldCurrentWeighted / totalCurrentValueForYield) * 100,\n      2\n    );\n  }\n\n  if (totalInvestedValueForYield > 0) {\n    analysis.portfolio_yield_roi = roundTo(\n      (totalYieldROIWeighted / totalInvestedValueForYield) * 100,\n      2\n    );\n  }\n\n  if (analysis.average_coupon_yield > 0 && analysis.portfolio_yield_roi > 0) {\n    analysis.portfolio_yield_average = roundTo(\n      (analysis.average_coupon_yield + analysis.portfolio_yield_roi) / 2,\n      2\n    );\n  }\n\n  Object.keys(assetTypeDistribution).forEach(assetType => {\n    const distribution = assetTypeDistribution[assetType];\n    distribution.percent = totalCurrentValueRUB > 0 \n      ? roundTo((distribution.total_value_rub / totalCurrentValueRUB) * 100, 2)\n      : 0;\n    \n    analysis.asset_distribution[assetType] = {\n      count: distribution.count,\n      percent: distribution.percent,\n      total_value_rub: roundTo(distribution.total_value_rub, 2)\n    };\n  });\n\n  analysis.total_assets_count = validAssetsCount;\n  analysis.portfolio_current_value_rub = roundTo(totalCurrentValueRUB, 2);\n  analysis.net_investment = roundTo(netInvestmentRUB, 2);\n\n  // ═════════════════════════════════════════════════════════════════════════\n  // РАСЧЕТ АБСОЛЮТНОЙ ПРИБЫЛИ И ПРОЦЕНТА РОСТА\n  // ═════════════════════════════════════════════════════════════════════════\n  \n  analysis.portfolio_absolute_profit_rub = roundTo(\n    analysis.portfolio_current_value_rub - analysis.net_investment,\n    2\n  );\n  \n  if (analysis.net_investment > 0) {\n    analysis.portfolio_gain_percent = roundTo(\n      (analysis.portfolio_absolute_profit_rub / analysis.net_investment) * 100,\n      2\n    );\n  }\n\n  profitableAssets.sort((a, b) => b.yield - a.yield);\n  analysis.top_profitable_rub = profitableAssets.slice(0, 5);\n\n  profitableAssetsByForeignCurrency.sort((a, b) => b.yield - a.yield);\n  analysis.top_profitable_foreign = profitableAssetsByForeignCurrency.slice(0, 2);\n\n  profitableAssets.sort((a, b) => a.yield - b.yield);\n  analysis.bottom_profitable_rub = profitableAssets.slice(0, 10);\n\n  profitableAssetsByForeignCurrency.sort((a, b) => a.yield - b.yield);\n  analysis.bottom_profitable_foreign = profitableAssetsByForeignCurrency.slice(0, 1);\n\n  // =========================================================================\n  // ФОРМАТИРОВАНИЕ И ВЫВОД\n  // =========================================================================\n\n  const formattedAnalysis = {\n    portfolio_name: analysis.portfolio_name,\n    analysis_date: new Date(analysis.analysis_timestamp).toLocaleDateString('ru-RU'),\n    exchange_rates_used: exchangeRates,\n    \n    portfolio_metrics: {\n      total_assets_count: analysis.total_assets_count,\n      portfolio_current_value_rub: formatCurrency(analysis.portfolio_current_value_rub),\n      portfolio_current_value_rub_number: analysis.portfolio_current_value_rub,\n      portfolio_absolute_profit_rub: formatCurrency(analysis.portfolio_absolute_profit_rub),\n      portfolio_absolute_profit_rub_number: analysis.portfolio_absolute_profit_rub,\n      portfolio_gain_percent: analysis.portfolio_gain_percent,\n      average_coupon_yield_percent: analysis.average_coupon_yield,\n      portfolio_yield_by_current_value_percent: analysis.portfolio_yield_by_current_value,\n      portfolio_yield_roi_percent: analysis.portfolio_yield_roi,\n      portfolio_yield_average_percent: analysis.portfolio_yield_average,\n      net_investment_rub: formatCurrency(analysis.net_investment),\n      net_investment_rub_number: analysis.net_investment\n    },\n    \n    asset_distribution_by_type: (() => {\n      const dist = {};\n      Object.keys(analysis.asset_distribution).forEach(assetType => {\n        const data = analysis.asset_distribution[assetType];\n        dist[assetType] = {\n          count: data.count,\n          percent: formatPercent(data.percent),\n          percent_number: data.percent,\n          total_value_rub: formatCurrency(data.total_value_rub),\n          total_value_rub_number: data.total_value_rub\n        };\n      });\n      return dist;\n    })(),\n    \n    assets_with_default: {\n      count: analysis.assets_with_default.length,\n      assets: analysis.assets_with_default\n    },\n    \n    assets_with_technical_default: {\n      count: analysis.assets_with_technical_default.length,\n      assets: analysis.assets_with_technical_default\n    },\n    \n    top_5_profitable_rub: {\n      count: analysis.top_profitable_rub.length,\n      assets: analysis.top_profitable_rub.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_2_profitable_foreign_currency: {\n      count: analysis.top_profitable_foreign.length,\n      assets: analysis.top_profitable_foreign.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        currency: a.faceunit,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_10_least_profitable_rub: {\n      count: analysis.bottom_profitable_rub.length,\n      assets: analysis.bottom_profitable_rub.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_1_least_profitable_foreign_currency: {\n      count: analysis.bottom_profitable_foreign.length,\n      assets: analysis.bottom_profitable_foreign.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        currency: a.faceunit,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    }\n  };\n\n  return { json: formattedAnalysis };\n\n} catch (error) {\n  return {\n    json: {\n      error: true,\n      error_message: error.message,\n      error_stack: error.stack,\n      timestamp: new Date().toISOString()\n    }\n  };\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4096,
        -32
      ],
      "id": "e0b5cb33-df07-4b1e-b3a7-b47803ef2006",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me5",
      "typeVersion": 1,
      "position": [
        -720,
        -16
      ],
      "id": "0809a7fb-dbbb-4058-baa9-be38ffacfef0"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1376,
        -1712
      ],
      "id": "ba4449ee-c365-4ebb-b54a-69c8a379e083",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me18",
      "typeVersion": 1,
      "position": [
        3120,
        -1296
      ],
      "id": "fec1feac-df1d-4398-a717-e58708ff70e7"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me19",
      "typeVersion": 1,
      "position": [
        2704,
        -1184
      ],
      "id": "7ca48e20-4049-4d0d-bae8-dfee378953d4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me20",
      "typeVersion": 1,
      "position": [
        2960,
        -928
      ],
      "id": "9f23d877-c536-4bbd-980c-985fd5b094c9"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3504,
        -1200
      ],
      "id": "eebb5b1f-d9a1-4122-9052-660f394413ce",
      "name": "Merge12"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4208,
        -1184
      ],
      "id": "b637c69d-ea8e-4c14-a99b-e948271a1d6d",
      "name": "Merge13"
    },
    {
      "parameters": {
        "jsCode": "// Извлечение уникальных значений SECID из входящих данных\nconst secids = items.map(item => item.json.SECID);\nconst uniqueSecids = [...new Set(secids)];\nreturn uniqueSecids.map(secid => ({ json: { SECID: secid } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4416,
        -1184
      ],
      "id": "d7e1f945-af34-4316-a4d5-f973198ae383",
      "name": "Unik_SCEID"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// Calc: Invested Amount1 - УЛУЧШЕННАЯ ВЕРСИЯ\n// n8n версия 1.116.2\n// ============================================================================\n// Расчет инвестированных средств с учетом комиссий и налогов\n// ============================================================================\n\n// Получаем все операции из входных данных\nconst operations = $input.all();\n\n// Инициализируем объект для хранения инвестиций по валютам\nconst investments = {};\n\n// Обрабатываем каждую операцию\nfor (const item of operations) {\n  const event = item.json.Event;\n  const currency = item.json.Currency;\n  const quantity = parseFloat(item.json.Quantity) || 0;\n  const feeTax = parseFloat(item.json.FeeTax) || 0;\n  \n  // Инициализируем валюту, если её ещё нет\n  if (!investments[currency]) {\n    investments[currency] = {\n      cash_in: 0,           // Пополнения счета\n      cash_out: 0,          // Выводы со счета\n      commissions: 0,       // Сумма комиссий (FEE)\n      dividend_taxes: 0,    // Налоги из дивидендов\n      cash_expenses: 0,     // Прочие расходы (налоги на прирост капитала и т.д.)\n      cash_gains: 0,        // Возвраты налогов и прочие доходы\n      net: 0,\n      count_in: 0,\n      count_out: 0,\n      count_fees: 0,\n      count_div_taxes: 0,\n      count_expenses: 0,\n      count_gains: 0\n    };\n  }\n  \n  // Обрабатываем операции пополнения\n  if (event === 'CASH_IN') {\n    investments[currency].cash_in += quantity;\n    investments[currency].count_in += 1;\n  }\n  \n  // Обрабатываем операции вывода\n  else if (event === 'CASH_OUT') {\n    investments[currency].cash_out += quantity;\n    investments[currency].count_out += 1;\n  }\n  \n  // Обрабатываем комиссии - везде, где есть FEE\n  else if (event === 'FEE') {\n    investments[currency].commissions += feeTax;\n    investments[currency].count_fees += 1;\n  }\n  \n  // Обрабатываем налоги из дивидендов - поле FeeTax для DIVIDEND\n  else if (event === 'DIVIDEND') {\n    if (feeTax > 0) {\n      investments[currency].dividend_taxes += feeTax;\n      investments[currency].count_div_taxes += 1;\n    }\n  }\n  \n  // Обрабатываем комиссии и налоги при других операциях (BUY, SELL и т.д.)\n  else if (event === 'BUY' || event === 'SELL' || event === 'CASH_CONVERT') {\n    if (feeTax > 0) {\n      investments[currency].commissions += feeTax;\n      investments[currency].count_fees += 1;\n    }\n  }\n  \n  // Обрабатываем прочие расходы (налоги на прирост капитала и т.д.)\n  else if (event === 'CASH_EXPENSE') {\n    investments[currency].cash_expenses += quantity;\n    investments[currency].count_expenses += 1;\n  }\n  \n  // Обрабатываем возвраты налогов и прочие доходы\n  else if (event === 'CASH_GAIN') {\n    investments[currency].cash_gains += quantity;\n    investments[currency].count_gains += 1;\n  }\n}\n\n// ============================================================================\n// Вычисляем чистые инвестиции для каждой валюты по формуле:\n// net_investment = cash_in - cash_out - commissions - dividend_taxes - cash_expenses + cash_gains\n// ============================================================================\n\nfor (const currency in investments) {\n  const inv = investments[currency];\n  inv.net = \n    inv.cash_in                    // Добавляем пополнения\n    - inv.cash_out                 // Вычитаем выводы\n    - inv.commissions              // Вычитаем все комиссии\n    - inv.dividend_taxes           // Вычитаем налоги из дивидендов\n    - inv.cash_expenses            // Вычитаем прочие расходы/налоги\n    + inv.cash_gains;              // Добавляем возвраты и прочие доходы\n}\n\n// ============================================================================\n// Формируем результат для вывода\n// ============================================================================\n\nconst result = [];\n\nfor (const currency in investments) {\n  const inv = investments[currency];\n  \n  result.push({\n    json: {\n      currency: currency,\n      // Основные компоненты\n      cash_in: inv.cash_in.toFixed(2),\n      cash_out: inv.cash_out.toFixed(2),\n      commissions_total: inv.commissions.toFixed(2),\n      dividend_taxes_total: inv.dividend_taxes.toFixed(2),\n      cash_expenses_total: inv.cash_expenses.toFixed(2),\n      cash_gains_total: inv.cash_gains.toFixed(2),\n      // Итоговая чистая инвестиция\n      net_investment: inv.net.toFixed(2),\n      // Количество операций\n      operations_in: inv.count_in,\n      operations_out: inv.count_out,\n      operations_fees: inv.count_fees,\n      operations_div_taxes: inv.count_div_taxes,\n      operations_expenses: inv.count_expenses,\n      operations_gains: inv.count_gains\n    }\n  });\n}\n\n// Добавляем итоговую запись с общей информацией\nresult.push({\n  json: {\n    currency: 'TOTAL_CURRENCIES',\n    total_currencies: Object.keys(investments).length,\n    comment: 'Summary of all currencies with commissions and taxes'\n  }\n});\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        -1872
      ],
      "id": "c7aa40ee-de22-4e47-a382-c05fb3557717",
      "name": "Calc: Invested Amount"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "Nj7uKy6tmZ2sSv0N",
          "mode": "list",
          "cachedResultName": "Operation_STANDART",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/Nj7uKy6tmZ2sSv0N"
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -144,
        -1712
      ],
      "id": "4a1de679-99ea-4a80-8c23-08c64302f5fc",
      "name": "STANDART-Get rows1"
    },
    {
      "parameters": {
        "jsCode": "// Получаем все операции\nconst operations = $input.all();\n\n// Словарь для хранения позиций\nconst positions = {};\n\n// Функция для форматирования даты (ДД/ММ/ГГГГ)\nfunction formatDateShort(dateString) {\n  if (!dateString) return null;\n  const date = new Date(dateString);\n  const day = String(date.getDate()).padStart(2, '0');\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const year = date.getFullYear();\n  return `${day}/${month}/${year}`;\n}\n\n// Обрабатываем операции в хронологическом порядке\nfor (const item of operations) {\n  const data = item.json;\n  const symbol = data.Symbol;\n  const event = data.Event;\n  const quantity = parseFloat(data.Quantity) || 0;\n  const price = parseFloat(data.Price) || 0;\n  const nkd = parseFloat(data.NKD) || 0;\n  const currency = data.Currency;\n  const date = data.Date;\n  \n  // Пропускаем операции без символа\n  if (!symbol) continue;\n  \n  // Пропускаем валютные операции\n  if (['CASH_IN', 'CASH_OUT', 'CASH_CONVERT', 'CASH_GAIN', 'CASH_EXPENSE'].includes(event)) {\n    continue;\n  }\n  \n  // Инициализируем позицию\n  if (!positions[symbol]) {\n    positions[symbol] = {\n      quantity: 0,\n      total_cost: 0,\n      currency: currency,\n      first_purchase: null,\n      last_operation: null\n    };\n  }\n  \n  const pos = positions[symbol];\n  \n  // Обрабатываем разные типы операций\n  switch(event) {\n    case 'BUY':\n      // Покупка\n      const buyCost = (price + nkd) * quantity;\n      pos.quantity += quantity;\n      pos.total_cost += buyCost;\n      if (!pos.first_purchase) {\n        pos.first_purchase = date;\n      }\n      pos.last_operation = date;\n      break;\n      \n    case 'SELL':\n      // Продажа\n      const sellCost = (price + nkd) * quantity;\n      pos.quantity -= quantity;\n      pos.total_cost -= sellCost;\n      pos.last_operation = date;\n      break;\n      \n    case 'REPAYMENT':\n      // Погашение облигации\n      pos.quantity -= quantity;\n      pos.last_operation = date;\n      break;\n      \n    case 'DIVIDEND':\n    case 'STOCK_AS_DIVIDEND':\n    case 'AMORTISATION':\n    case 'SPLIT':\n    case 'FEE':\n    case 'CUSTOM_HOLDING_PRICE':\n    case 'CUSTOM_HOLDING_SETTINGS':\n      // Обновляем только дату последней операции\n      pos.last_operation = date;\n      break;\n  }\n}\n\n// Формируем результат только для активных позиций\nconst result = [];\n\nfor (const symbol in positions) {\n  const pos = positions[symbol];\n  \n  // Пропускаем проданные/погашенные активы\n  if (pos.quantity <= 0.0001) continue;\n  \n  // Вычисляем среднюю цену покупки\n  const avgBuyPrice = pos.total_cost / pos.quantity;\n  \n  // Формируем объект позиции с требуемыми полями\n  result.push({\n    json: {\n      Symbol: symbol,\n      Currency: pos.currency,\n      Quantity: parseFloat(pos.quantity.toFixed(4)),\n      AvgBuyPrice: parseFloat(avgBuyPrice.toFixed(2)),\n      TotalInvested: parseFloat(pos.total_cost.toFixed(2)),\n      FirstPurchaseDate: formatDateShort(pos.first_purchase),\n      LastOperationDate: formatDateShort(pos.last_operation)\n    }\n  });\n}\n\n// Сортируем по TotalInvested (убывание)\nresult.sort((a, b) => b.json.TotalInvested - a.json.TotalInvested);\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        -1712
      ],
      "id": "40a96255-79d4-4bdf-9f24-be91f3fa2400",
      "name": "Calc: Portfolio Composition1"
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1152,
        -1488
      ],
      "id": "f662fe8d-470b-45c2-889e-f45ef4f2c032",
      "name": "Loop Over Items4"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities/{{ $json.Symbol }}.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "boards"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 5000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        624,
        -1440
      ],
      "id": "24df0371-9ff6-433e-bbae-0f8ed7561811",
      "name": "Find Board2",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Приоритет boards для разных типов активов\nconst priorityBoards = ['TQBR', 'TQTF', 'TQCB', 'TQOB', 'TQOD', 'TQEU', 'TQCN', 'CETS'];\n\n// Обработка всех входящих элементов\nconst results = [];\n\nfor (const item of $input.all()) {\n  const data = item.json;\n  \n  try {\n    // ВАЖНО: Данные приходят в виде полного HTTP ответа\n    // Нам нужно достать Symbol из исходных данных ДО парсинга\n    // К сожалению, в Code узле его нет...\n    // Поэтому используем индекс из массива\n    const itemIndex = item._index || item.index;\n    \n    // Парсим JSON из поля body\n    let boardsResponse;\n    if (typeof data.body === 'string') {\n      boardsResponse = JSON.parse(data.body);\n    } else {\n      boardsResponse = data.body;\n    }\n    \n    // Получаем Symbol из первой строки данных (это ISIN/тикер)\n    const symbol = boardsResponse.boards?.data[0]?.[0] || 'UNKNOWN';\n    \n    const boardsData = boardsResponse.boards;\n    \n    if (!boardsData || !boardsData.data || boardsData.data.length === 0) {\n      results.push({\n        json: {\n          Symbol: symbol,\n          Board: null,\n          Engine: null,\n          Market: null,\n          Error: 'No boards found'\n        }\n      });\n      continue;\n    }\n    \n    // Создаем индекс для быстрого поиска колонок\n    const columnIndex = {};\n    boardsData.columns.forEach((col, idx) => {\n      columnIndex[col] = idx;\n    });\n    \n    // Ищем подходящий board по приоритету\n    let selectedBoard = null;\n    \n    for (const priorityBoard of priorityBoards) {\n      for (let i = 0; i < boardsData.data.length; i++) {\n        const boardId = boardsData.data[i][columnIndex['boardid']];\n        const isTraded = boardsData.data[i][columnIndex['is_traded']];\n        \n        if (boardId === priorityBoard && isTraded === 1) {\n          selectedBoard = {\n            boardid: boardId,\n            engine: boardsData.data[i][columnIndex['engine']],\n            market: boardsData.data[i][columnIndex['market']]\n          };\n          break;\n        }\n      }\n      if (selectedBoard) break;\n    }\n    \n    // Если не нашли по приоритету, берем первый активный\n    if (!selectedBoard) {\n      for (let i = 0; i < boardsData.data.length; i++) {\n        const isTraded = boardsData.data[i][columnIndex['is_traded']];\n        \n        if (isTraded === 1) {\n          selectedBoard = {\n            boardid: boardsData.data[i][columnIndex['boardid']],\n            engine: boardsData.data[i][columnIndex['engine']],\n            market: boardsData.data[i][columnIndex['market']]\n          };\n          break;\n        }\n      }\n    }\n    \n    if (!selectedBoard) {\n      results.push({\n        json: {\n          Symbol: symbol,\n          Board: null,\n          Engine: null,\n          Market: null,\n          Error: 'No active boards'\n        }\n      });\n      continue;\n    }\n    \n    // Возвращаем результат\n    results.push({\n      json: {\n        Symbol: symbol,\n        Board: selectedBoard.boardid,\n        Engine: selectedBoard.engine,\n        Market: selectedBoard.market\n      }\n    });\n    \n  } catch (error) {\n    console.log(`Ошибка: ${error.message}`);\n    results.push({\n      json: {\n        Symbol: 'ERROR',\n        Board: null,\n        Engine: null,\n        Market: null,\n        Error: error.message\n      }\n    });\n  }\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        -1440
      ],
      "id": "c5cd7073-dde6-4a68-8a32-8cae2ed2e8dd",
      "name": "Parse Boards1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4e0fb2f8-e29b-45a4-9c58-eddd4dcec84b",
              "leftValue": "={{ $json.Board }}",
              "rightValue": "null",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        688,
        -1824
      ],
      "id": "8d87432f-280d-4716-bb13-2a9d6914cf12",
      "name": "If1"
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        400,
        -1616
      ],
      "id": "b1dc621c-35bd-415c-b1bb-836f0b325b5e",
      "name": "Loop Over Items5"
    },
    {
      "parameters": {
        "jsCode": "// Функция для форматирования даты\nfunction formatDate(dateString) {\n  if (!dateString || dateString === '0000-00-00' || dateString === null) {\n    return null;\n  }\n  \n  try {\n    const date = new Date(dateString);\n    // Проверяем, является ли дата валидной\n    if (isNaN(date.getTime())) {\n      return null;\n    }\n    \n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = date.getFullYear();\n    \n    return `${day}.${month}.${year}`;\n  } catch (error) {\n    return null;\n  }\n}\n\n// Основная логика парсинга\nconst items = $input.all();\n\nreturn items.map((item) => {\n  try {\n    // Получаем данные из тела ответа\n    const response = item.json?.body || item.json || {};\n    \n    // Извлекаем массивы securities и marketdata\n    const securitiesData = response.securities?.data?.[0] || [];\n    const securitiesColumns = response.securities?.columns || [];\n    \n    const marketdataData = response.marketdata?.data?.[0] || [];\n    const marketdataColumns = response.marketdata?.columns || [];\n    \n    // Функция для получения значения по названию колонки\n    function getValueFromArray(dataArray, columnsArray, columnName) {\n      const index = columnsArray.indexOf(columnName);\n      return index !== -1 ? dataArray[index] : null;\n    }\n    \n    // Извлекаем требуемые поля\n    const result = {\n      // Securities fields\n      SECID: getValueFromArray(securitiesData, securitiesColumns, 'SECID'),\n      BOARDID: getValueFromArray(securitiesData, securitiesColumns, 'BOARDID'),\n      SHORTNAME: getValueFromArray(securitiesData, securitiesColumns, 'SHORTNAME'),\n      PREVPRICE: getValueFromArray(securitiesData, securitiesColumns, 'PREVPRICE'),\n      FACEVALUE: getValueFromArray(securitiesData, securitiesColumns, 'FACEVALUE'),\n      STATUS: getValueFromArray(securitiesData, securitiesColumns, 'STATUS'),\n      ISIN: getValueFromArray(securitiesData, securitiesColumns, 'ISIN'),\n      PREVLEGALCLOSEPRICE: getValueFromArray(securitiesData, securitiesColumns, 'PREVLEGALCLOSEPRICE'),\n      SECTYPE: getValueFromArray(securitiesData, securitiesColumns, 'SECTYPE'),\n      COUPONPERCENT: getValueFromArray(securitiesData, securitiesColumns, 'COUPONPERCENT'),\n      COUPONVALUE: getValueFromArray(securitiesData, securitiesColumns, 'COUPONVALUE'),\n      MATDATE: getValueFromArray(securitiesData, securitiesColumns, 'MATDATE'),\n      OFFERDATE: getValueFromArray(securitiesData, securitiesColumns, 'OFFERDATE'),\n      ACCRUEDINT: getValueFromArray(securitiesData, securitiesColumns, 'ACCRUEDINT'),\n      CURRENCYID: getValueFromArray(securitiesData, securitiesColumns, 'CURRENCYID'),\n      \n      // Marketdata fields\n      LCURRENTPRICE: getValueFromArray(marketdataData, marketdataColumns, 'LCURRENTPRICE'),\n      YIELD: getValueFromArray(marketdataData, marketdataColumns, 'YIELD'),\n      DURATION: getValueFromArray(marketdataData, marketdataColumns, 'DURATION'),\n      YIELDATWAPRICE: getValueFromArray(marketdataData, marketdataColumns, 'YIELDATWAPRICE')\n    };\n    \n    // Обработка FACEUNIT: замена \"SUR\" на \"RUB\"\n    let faceUnit = getValueFromArray(securitiesData, securitiesColumns, 'FACEUNIT');\n    result.FACEUNIT = faceUnit === 'SUR' ? 'RUB' : faceUnit;\n        \n    // Форматирование дат\n    const nextCouponRaw = getValueFromArray(securitiesData, securitiesColumns, 'NEXTCOUPON');\n    result.NEXTCOUPON_FORMATTED = formatDate(nextCouponRaw);\n    \n    result.MATDATE_FORMATTED = formatDate(result.MATDATE);\n    result.OFFERDATE_FORMATTED = formatDate(result.OFFERDATE);\n    \n    return { json: result };\n    \n  } catch (error) {\n    // В случае ошибки возвращаем объект с информацией об ошибке\n    return {\n      json: {\n        error: true,\n        errorMessage: error.message,\n        originalData: item.json\n      }\n    };\n  }\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1696,
        -1424
      ],
      "id": "69d574f0-8fa3-48c3-8b9e-2ba22a344486",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/engines/{{ $json.Engine }}/markets/{{ $json.Market }}/boards/{{ $json.Board }}/securities/{{ $json.Symbol }}.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "securities,marketdata,description"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 2000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        -1424
      ],
      "id": "8adf4509-5315-4948-be26-3e84d2f5fd63",
      "name": "Fetch MOEX Data",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities/{{ $json.Symbol }}.json\n",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "description"
            },
            {
              "name": "description.columns",
              "value": "name,title,value"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 2000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1344,
        -1904
      ],
      "id": "1e4795a2-1d8c-44ff-889a-88fc25259a75",
      "name": "Find Board3",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Получаем входные данные\nconst items = $input.all();\nconst result = [];\n\n// Обработка каждого элемента входных данных\nfor (const item of items) {\n  const json = item.json;\n  \n  // Проверяем наличие описания\n  if (json.body && json.body.description) {\n    const description = json.body.description;\n    const data = description.data; // Массив массивов\n    \n    // Преобразуем массив [name, title, value] в объект\n    const parsed = {};\n    for (const row of data) {\n      if (Array.isArray(row) && row.length >= 3) {\n        const fieldName = row[0];  // \"SECID\", \"ISIN\" и т.д.\n        const fieldValue = row[2]; // Значение\n        parsed[fieldName] = fieldValue;\n      }\n    }\n    \n    // Нормализация валюты: SUR -> RUB\n    const faceUnit = parsed.FACEUNIT || 'RUB';\n    const normalizedFaceUnit = faceUnit === 'SUR' ? 'RUB' : faceUnit;\n    \n    // Форматируем выходные данные\n    const output = {\n      SECID: parsed.SECID || '',\n      SHORTNAME: parsed.SHORTNAME || '',\n      ISIN: parsed.ISIN || parsed.SECID || '',\n      MATDATE: parsed.MATDATE || '',\n      INITIALFACEVALUE: Number(parsed.INITIALFACEVALUE || 1000),\n      FACEUNIT: normalizedFaceUnit,\n      HASDEFAULT: parsed.HASDEFAULT === '1' || parsed.HASDEFAULT === 1,\n      HASTECHNICALDEFAULT: parsed.HASTECHNICALDEFAULT === '1' || parsed.HASTECHNICALDEFAULT === 1,\n      DAYSTOREDEMPTION: Number(parsed.DAYSTOREDEMPTION || 0),\n      FACEVALUE: Number(parsed.FACEVALUE || 1000),\n      COUPONFREQUENCY: Number(parsed.COUPONFREQUENCY || 0),\n      COUPONDATE: parsed.COUPONDATE || '',\n      COUPONPERCENT: Number(parsed.COUPONPERCENT || 0),\n      COUPONVALUE: Number(parsed.COUPONVALUE || 0),\n      TYPENAME: parsed.TYPENAME || '',\n      GROUP: parsed.GROUP || '',\n      TYPE: parsed.TYPE || '',\n      GROUPNAME: parsed.GROUPNAME || '',\n      EMITTER_ID: String(parsed.EMITTER_ID || '')\n    };\n    \n    result.push({ json: output });\n  }\n}\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1664,
        -1904
      ],
      "id": "5a4c929c-e160-419c-899a-f535b9867f0b",
      "name": "Code in JavaScript4",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1120,
        -2064
      ],
      "id": "4a5791d0-4699-4cc6-9d11-8206a3dd448d",
      "name": "Loop Over Items6"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "SECID",
        "joinMode": "enrichInput1",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2016,
        -1808
      ],
      "id": "bcad96eb-66b2-4949-9b13-4960752d404a",
      "name": "Merge4"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "SECID",
              "field2": "Symbol"
            }
          ]
        },
        "joinMode": "enrichInput1",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2224,
        -1728
      ],
      "id": "c420d66e-6fd3-4c32-a530-9d5b1d5d6177",
      "name": "Merge5"
    },
    {
      "parameters": {
        "url": "https://www.cbr-xml-daily.ru/latest.js",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json, text/javascript"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        144,
        -1232
      ],
      "id": "83dce4e1-65e1-447a-820d-6ec61d696d6c",
      "name": "Get Currency Rates from MOEX1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2528,
        -1712
      ],
      "id": "9b9830bb-f70a-4068-8001-2a161da5b55e",
      "name": "Merge6"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ПАРСИНГ КУРСОВ ВАЛЮТ ЦБ РФ - МИНИМАЛЬНЫЙ ФОРМАТ\n * n8n v1.116.2\n * \n * Возвращает только необходимые данные\n */\n\ntry {\n  const input = $input.item.json;\n  \n  if (!input.body || !input.body.rates) {\n    throw new Error('Invalid response: missing rates data');\n  }\n  \n  const data = input.body;\n  \n  // Основные валюты для портфеля\n  const currencyCodes = {\n    'USD': 2,   // 2 знака для отображения\n    'EUR': 2,\n    'CNY': 2\n  };\n  \n  // Инициализируем результат\n  const rates = {\n    'RUB': 1\n  };\n  \n  // Обрабатываем валюты\n  for (const [code, decimals] of Object.entries(currencyCodes)) {\n    if (data.rates[code]) {\n      const inverseRate = parseFloat(data.rates[code]);\n      const directRate = 1 / inverseRate;\n      \n      // Округляем до нужного количества знаков\n      rates[code] = Math.round(directRate * Math.pow(10, decimals)) / Math.pow(10, decimals);\n    }\n  }\n  \n  // Возвращаем только timestamp и rates\n  return [{\n    json: {\n      timestamp: new Date().toISOString(),\n      rates: rates\n    }\n  }];\n  \n} catch (error) {\n  console.error('Error:', error.message);\n  \n  return [{\n    json: {\n      timestamp: new Date().toISOString(),\n      rates: {\n        'RUB': 1,\n        'USD': 79.47,\n        'EUR': 92.25,\n        'CNY': 11.17,\n        'GBP': 105.52\n      }\n    }\n  }];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1920,
        -1232
      ],
      "id": "70b06230-ef7b-40b3-b1d5-55f5bd8491b4",
      "name": "Code Kurs1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me6",
      "typeVersion": 1,
      "position": [
        1520,
        -1504
      ],
      "id": "fa670610-3450-4ec1-975e-ac6ac4b148e2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me7",
      "typeVersion": 1,
      "position": [
        1520,
        -2080
      ],
      "id": "45517172-b1fc-4d0b-ade5-1223156e6fe8"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me8",
      "typeVersion": 1,
      "position": [
        1120,
        -2240
      ],
      "id": "5f1b2cbd-7c9a-400c-90ea-4e467819bf8c"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me9",
      "typeVersion": 1,
      "position": [
        1280,
        -928
      ],
      "id": "278a8972-eb55-4709-ac34-74b6f7638ddb"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3888,
        -1728
      ],
      "id": "f0291033-50b0-48ae-83f3-d5dcdd622b5b",
      "name": "Merge7"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me10",
      "typeVersion": 1,
      "position": [
        3200,
        -2240
      ],
      "id": "ed9d693a-1656-43f8-ab95-2a27b85db617"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================================================\n * АНАЛИЗ ПОРТФЕЛЯ - УЗЕЛ CODE N8N (версия 1.116.2) - v10 ФИНАЛЬНАЯ\n * ============================================================================\n * \n * ДОБАВЛЕНО В v10:\n * \n * ✓ portfolio_absolute_profit_rub - абсолютная прибыль в рублях\n * ✓ portfolio_gain_percent - относительный рост в процентах\n * \n * Формулы:\n *   portfolio_absolute_profit_rub = portfolio_current_value - net_investment\n *   portfolio_gain_percent = (portfolio_absolute_profit / net_investment) × 100\n * \n * ============================================================================\n */\n\n// ============================================================================\n// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ\n// ============================================================================\n\nconst SECTYPE_MAP = {\n  '1': { name: 'Акция', group: 'stocks' },\n  '2': { name: 'Акция', group: 'stocks' },\n  '3': { name: 'ОФЗ', group: 'ofz' },\n  '4': { name: 'Муниципальная облигация', group: 'municipal_bonds' },\n  '5': { name: 'ОФЗ', group: 'ofz' },\n  '6': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '7': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '8': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '9': { name: 'ETF', group: 'etf' },\n  'A': { name: 'ETF', group: 'etf' },\n  'B': { name: 'ETF', group: 'etf' },\n  'C': { name: 'Ипотечные сертификаты участия', group: 'other' },\n  'D': { name: 'Депозитарные расписки', group: 'other' },\n  'E': { name: 'Варранты', group: 'other' },\n  'F': { name: 'Еврооблигации', group: 'eurobonds' },\n  'G': { name: 'Векселя', group: 'other' },\n  'H': { name: 'Залоговые расписки', group: 'other' },\n  'J': { name: 'ETF', group: 'etf' },\n  'K': { name: 'ETF', group: 'etf' },\n  'L': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  'M': { name: 'Деривативы, фьючерсы и т.д.', group: 'other' }\n};\n\n// ╔═══════════════════════════════════════════════════════════════════════════╗\n// ║ КОНСТАНТА: ДОХОДНОСТЬ ETF                                                ║\n// ║ Для всех ETF устанавливается фиксированное значение YIELDATWAPRICE       ║\n// ║ РЕДАКТИРУЙ ЗДЕСЬ, ЕСЛИ НУЖНО ИЗМЕНИТЬ ПРОЦЕНТ ДОХОДНОСТИ ETF            ║\n// ╚═══════════════════════════════════════════════════════════════════════════╝\nconst ETF_YIELD_ATWAPRICE = 15.3;  // Доходность ETF в процентах\n// ═══════════════════════════════════════════════════════════════════════════\n\nfunction isETFType(sectype) {\n  const etfCodes = ['9', 'A', 'B', 'J', 'K'];\n  return etfCodes.includes(sectype);\n}\n\nfunction getAssetTypeWithFaceUnit(sectype, faceUnit) {\n  const typeInfo = SECTYPE_MAP[sectype] || { name: 'Прочее', group: 'other' };\n  \n  const corpBondCodes = ['6', '7', '8', 'L'];\n  if (corpBondCodes.includes(sectype) && faceUnit && faceUnit !== 'RUB' && faceUnit !== 'SUR') {\n    return { name: 'Еврооблигации', group: 'eurobonds' };\n  }\n  \n  return typeInfo;\n}\n\nfunction toNumber(value, defaultValue = 0) {\n  if (value === null || value === undefined || value === '') return defaultValue;\n  const num = parseFloat(value);\n  return isNaN(num) ? defaultValue : num;\n}\n\nfunction roundTo(value, decimals = 2) {\n  return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);\n}\n\nfunction formatCurrency(value, decimals = 2) {\n  return new Intl.NumberFormat('ru-RU', {\n    minimumFractionDigits: decimals,\n    maximumFractionDigits: decimals\n  }).format(value);\n}\n\nfunction formatPercent(value, decimals = 2) {\n  return roundTo(value, decimals) + '%';\n}\n\nfunction getExchangeRate(currencyId, rates) {\n  const normalizedCurrency = (currencyId === 'SUR') ? 'RUB' : currencyId;\n  \n  if (normalizedCurrency === 'RUB') {\n    return 1;\n  }\n  \n  if (rates && rates[normalizedCurrency]) {\n    return rates[normalizedCurrency];\n  }\n  \n  console.warn(`Exchange rate for ${normalizedCurrency} not found. Using 1.0`);\n  return 1;\n}\n\nfunction calculateNKDInRUB(accruedInt, currencyId, rates) {\n  if (!accruedInt || accruedInt === 0 || accruedInt === null) {\n    return 0;\n  }\n  \n  const normalizedCurrency = (currencyId === 'SUR') ? 'RUB' : currencyId;\n  const exchangeRate = getExchangeRate(currencyId, rates);\n  const nkdInRUB = toNumber(accruedInt, 0) * exchangeRate;\n  \n  return nkdInRUB;\n}\n\nfunction calculateCurrentValueRUB(asset, rates) {\n  const quantity = toNumber(asset.Quantity, 0);\n  const lcurrentprice = toNumber(asset.LCURRENTPRICE, 0);\n  const facevalue = toNumber(asset.FACEVALUE, 0);\n  const initialfacevalue = toNumber(asset.INITIALFACEVALUE, 1000);\n  const faceUnit = asset.FACEUNIT || 'RUB';\n  const sectype = asset.SECTYPE || '';\n  \n  const faceUnitExchangeRate = getExchangeRate(faceUnit, rates);\n  \n  if (isETFType(sectype)) {\n    return quantity * lcurrentprice * faceUnitExchangeRate;\n  } else {\n    const nominality = facevalue > 0 ? facevalue : initialfacevalue;\n    const priceWithoutNKD = (lcurrentprice / 100) * nominality;\n    const nkdInRUB = calculateNKDInRUB(asset.ACCRUEDINT, asset.CURRENCYID, rates);\n    const priceWithNKDInRUB = (priceWithoutNKD * faceUnitExchangeRate) + nkdInRUB;\n    const valueInRUB = quantity * priceWithNKDInRUB;\n    \n    return valueInRUB;\n  }\n}\n\nfunction calculateCurrentPriceWithoutNKD(asset) {\n  const lcurrentprice = toNumber(asset.LCURRENTPRICE, 0);\n  const facevalue = toNumber(asset.FACEVALUE, 0);\n  const initialfacevalue = toNumber(asset.INITIALFACEVALUE, 1000);\n  const sectype = asset.SECTYPE || '';\n  \n  if (isETFType(sectype)) {\n    return lcurrentprice;\n  } else {\n    const nominality = facevalue > 0 ? facevalue : initialfacevalue;\n    const price = (lcurrentprice / 100) * nominality;\n    return price;\n  }\n}\n\nfunction getYieldValue(asset) {\n  const sectype = asset.SECTYPE || '';\n  \n  if (isETFType(sectype)) {\n    return ETF_YIELD_ATWAPRICE;\n  } else {\n    let yield_value = toNumber(asset.YIELDATWAPRICE, null);\n    if (yield_value === null || yield_value === 0) {\n      yield_value = toNumber(asset.YIELD, null);\n    }\n    return yield_value;\n  }\n}\n\nfunction isRealAsset(asset) {\n  return asset.SECID && typeof asset.SECID === 'string' && \n         asset.SECID.trim() !== '' &&\n         asset.Symbol !== undefined;\n}\n\n// ============================================================================\n// ОСНОВНАЯ ЛОГИКА АНАЛИЗА\n// ============================================================================\n\ntry {\n  const allItems = $input.all();\n  const allData = allItems.map(item => item.json).filter(json => json && typeof json === 'object');\n  \n  if (!allData || allData.length === 0) {\n    throw new Error('Входные данные пусты или неправильного формата');\n  }\n\n  let netInvestmentRUB = 0;\n  let exchangeRates = { RUB: 1, USD: 1, EUR: 1, CNY: 1 };\n  const assets = [];\n\n  allData.forEach(item => {\n    if (item.rates && typeof item.rates === 'object') {\n      exchangeRates = item.rates;\n    } else if (item.currency === 'RUB' && item.cash_in !== undefined) {\n      netInvestmentRUB = toNumber(item.net_investment, 0);\n    } else if (item.currency === 'TOTAL_CURRENCIES' || item.total_currencies !== undefined) {\n      return;\n    } else if (isRealAsset(item)) {\n      assets.push(item);\n    }\n  });\n\n  if (assets.length === 0) {\n    throw new Error('Не найдено ни одного актива в данных.');\n  }\n\n  const analysis = {\n    portfolio_name: 'STANDART',\n    analysis_timestamp: new Date().toISOString(),\n    total_assets_count: 0,\n    portfolio_current_value_rub: 0,\n    portfolio_absolute_profit_rub: 0,\n    portfolio_gain_percent: 0,\n    average_coupon_yield: 0,\n    portfolio_yield_by_current_value: 0,\n    portfolio_yield_roi: 0,\n    portfolio_yield_average: 0,\n    net_investment: netInvestmentRUB,\n    asset_distribution: {},\n    assets_with_default: [],\n    assets_with_technical_default: [],\n    top_profitable_rub: [],\n    top_profitable_foreign: [],\n    bottom_profitable_rub: [],\n    bottom_profitable_foreign: []\n  };\n\n  const assetTypeDistribution = {};\n  let totalCurrentValueRUB = 0;\n  let validAssetsCount = 0;\n\n  let totalWeightedYield = 0;\n  let totalQuantityForYield = 0;\n\n  let totalYieldCurrentWeighted = 0;\n  let totalCurrentValueForYield = 0;\n  \n  let totalYieldROIWeighted = 0;\n  let totalInvestedValueForYield = 0;\n\n  const profitableAssets = [];\n  const profitableAssetsByForeignCurrency = [];\n\n  // =========================================================================\n  // ОБРАБОТКА КАЖДОГО АКТИВА\n  // =========================================================================\n\n  assets.forEach(asset => {\n    const currentValueRUB = calculateCurrentValueRUB(asset, exchangeRates);\n    \n    if (currentValueRUB === 0 || !isFinite(currentValueRUB)) {\n      return;\n    }\n\n    validAssetsCount += 1;\n\n    const sectype = asset.SECTYPE || '';\n    const faceUnit = asset.FACEUNIT || 'RUB';\n    const shortName = asset.SHORTNAME || asset.SECID || 'Unknown';\n    const quantity = toNumber(asset.Quantity, 0);\n    const couponPercent = toNumber(asset.COUPONPERCENT, null);\n    const hasDefault = asset.HASDEFAULT ? true : false;\n    const hasTechDefault = asset.HASTECHNICALDEFAULT ? true : false;\n    \n    const assetTypeInfo = getAssetTypeWithFaceUnit(sectype, faceUnit);\n    const assetTypeName = assetTypeInfo.name;\n\n    if (!assetTypeDistribution[assetTypeName]) {\n      assetTypeDistribution[assetTypeName] = {\n        count: 0,\n        total_value_rub: 0,\n        percent: 0\n      };\n    }\n    \n    assetTypeDistribution[assetTypeName].count += 1;\n    assetTypeDistribution[assetTypeName].total_value_rub += currentValueRUB;\n    totalCurrentValueRUB += currentValueRUB;\n    \n    const yield_value = getYieldValue(asset);\n    \n    if (assetTypeName !== 'Еврооблигации' && couponPercent !== null && couponPercent > 0) {\n      totalWeightedYield += couponPercent * quantity;\n      totalQuantityForYield += quantity;\n    }\n    \n    if (yield_value !== null && yield_value !== 0) {\n      \n      const priceWithoutNKD = calculateCurrentPriceWithoutNKD(asset);\n      const currentValueInNativeCurrencyWithoutNKD = quantity * priceWithoutNKD;\n      \n      totalYieldCurrentWeighted += (yield_value / 100) * currentValueInNativeCurrencyWithoutNKD;\n      totalCurrentValueForYield += currentValueInNativeCurrencyWithoutNKD;\n      \n      const avgBuyPrice = toNumber(asset.AvgBuyPrice, 0);\n      const investedSum = quantity * avgBuyPrice;\n      \n      totalYieldROIWeighted += (yield_value / 100) * investedSum;\n      totalInvestedValueForYield += investedSum;\n    }\n    \n    if (hasDefault) {\n      analysis.assets_with_default.push({\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        current_value_rub: roundTo(currentValueRUB, 2)\n      });\n    }\n    \n    if (hasTechDefault) {\n      analysis.assets_with_technical_default.push({\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        current_value_rub: roundTo(currentValueRUB, 2)\n      });\n    }\n    \n    if (!hasDefault && yield_value !== null && yield_value !== 0) {\n      const assetRecord = {\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        yield: roundTo(yield_value, 2),\n        current_value_rub: roundTo(currentValueRUB, 2),\n        faceunit: faceUnit,\n        quantity: quantity,\n        coupon_percent: couponPercent !== null ? roundTo(couponPercent, 2) : 'N/A'\n      };\n      \n      if (faceUnit === 'RUB' || faceUnit === 'SUR') {\n        profitableAssets.push(assetRecord);\n      } else {\n        profitableAssetsByForeignCurrency.push(assetRecord);\n      }\n    }\n  });\n\n  // =========================================================================\n  // РАСЧЕТЫ ФИНАЛЬНЫХ МЕТРИК\n  // =========================================================================\n\n  if (totalQuantityForYield > 0) {\n    analysis.average_coupon_yield = roundTo(totalWeightedYield / totalQuantityForYield, 2);\n  }\n\n  if (totalCurrentValueForYield > 0) {\n    analysis.portfolio_yield_by_current_value = roundTo(\n      (totalYieldCurrentWeighted / totalCurrentValueForYield) * 100,\n      2\n    );\n  }\n\n  if (totalInvestedValueForYield > 0) {\n    analysis.portfolio_yield_roi = roundTo(\n      (totalYieldROIWeighted / totalInvestedValueForYield) * 100,\n      2\n    );\n  }\n\n  if (analysis.average_coupon_yield > 0 && analysis.portfolio_yield_roi > 0) {\n    analysis.portfolio_yield_average = roundTo(\n      (analysis.average_coupon_yield + analysis.portfolio_yield_roi) / 2,\n      2\n    );\n  }\n\n  Object.keys(assetTypeDistribution).forEach(assetType => {\n    const distribution = assetTypeDistribution[assetType];\n    distribution.percent = totalCurrentValueRUB > 0 \n      ? roundTo((distribution.total_value_rub / totalCurrentValueRUB) * 100, 2)\n      : 0;\n    \n    analysis.asset_distribution[assetType] = {\n      count: distribution.count,\n      percent: distribution.percent,\n      total_value_rub: roundTo(distribution.total_value_rub, 2)\n    };\n  });\n\n  analysis.total_assets_count = validAssetsCount;\n  analysis.portfolio_current_value_rub = roundTo(totalCurrentValueRUB, 2);\n  analysis.net_investment = roundTo(netInvestmentRUB, 2);\n\n  // ═════════════════════════════════════════════════════════════════════════\n  // РАСЧЕТ АБСОЛЮТНОЙ ПРИБЫЛИ И ПРОЦЕНТА РОСТА\n  // ═════════════════════════════════════════════════════════════════════════\n  \n  analysis.portfolio_absolute_profit_rub = roundTo(\n    analysis.portfolio_current_value_rub - analysis.net_investment,\n    2\n  );\n  \n  if (analysis.net_investment > 0) {\n    analysis.portfolio_gain_percent = roundTo(\n      (analysis.portfolio_absolute_profit_rub / analysis.net_investment) * 100,\n      2\n    );\n  }\n\n  profitableAssets.sort((a, b) => b.yield - a.yield);\n  analysis.top_profitable_rub = profitableAssets.slice(0, 5);\n\n  profitableAssetsByForeignCurrency.sort((a, b) => b.yield - a.yield);\n  analysis.top_profitable_foreign = profitableAssetsByForeignCurrency.slice(0, 2);\n\n  profitableAssets.sort((a, b) => a.yield - b.yield);\n  analysis.bottom_profitable_rub = profitableAssets.slice(0, 10);\n\n  profitableAssetsByForeignCurrency.sort((a, b) => a.yield - b.yield);\n  analysis.bottom_profitable_foreign = profitableAssetsByForeignCurrency.slice(0, 1);\n\n  // =========================================================================\n  // ФОРМАТИРОВАНИЕ И ВЫВОД\n  // =========================================================================\n\n  const formattedAnalysis = {\n    portfolio_name: analysis.portfolio_name,\n    analysis_date: new Date(analysis.analysis_timestamp).toLocaleDateString('ru-RU'),\n    exchange_rates_used: exchangeRates,\n    \n    portfolio_metrics: {\n      total_assets_count: analysis.total_assets_count,\n      portfolio_current_value_rub: formatCurrency(analysis.portfolio_current_value_rub),\n      portfolio_current_value_rub_number: analysis.portfolio_current_value_rub,\n      portfolio_absolute_profit_rub: formatCurrency(analysis.portfolio_absolute_profit_rub),\n      portfolio_absolute_profit_rub_number: analysis.portfolio_absolute_profit_rub,\n      portfolio_gain_percent: analysis.portfolio_gain_percent,\n      average_coupon_yield_percent: analysis.average_coupon_yield,\n      portfolio_yield_by_current_value_percent: analysis.portfolio_yield_by_current_value,\n      portfolio_yield_roi_percent: analysis.portfolio_yield_roi,\n      portfolio_yield_average_percent: analysis.portfolio_yield_average,\n      net_investment_rub: formatCurrency(analysis.net_investment),\n      net_investment_rub_number: analysis.net_investment\n    },\n    \n    asset_distribution_by_type: (() => {\n      const dist = {};\n      Object.keys(analysis.asset_distribution).forEach(assetType => {\n        const data = analysis.asset_distribution[assetType];\n        dist[assetType] = {\n          count: data.count,\n          percent: formatPercent(data.percent),\n          percent_number: data.percent,\n          total_value_rub: formatCurrency(data.total_value_rub),\n          total_value_rub_number: data.total_value_rub\n        };\n      });\n      return dist;\n    })(),\n    \n    assets_with_default: {\n      count: analysis.assets_with_default.length,\n      assets: analysis.assets_with_default\n    },\n    \n    assets_with_technical_default: {\n      count: analysis.assets_with_technical_default.length,\n      assets: analysis.assets_with_technical_default\n    },\n    \n    top_5_profitable_rub: {\n      count: analysis.top_profitable_rub.length,\n      assets: analysis.top_profitable_rub.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_2_profitable_foreign_currency: {\n      count: analysis.top_profitable_foreign.length,\n      assets: analysis.top_profitable_foreign.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        currency: a.faceunit,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_10_least_profitable_rub: {\n      count: analysis.bottom_profitable_rub.length,\n      assets: analysis.bottom_profitable_rub.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_1_least_profitable_foreign_currency: {\n      count: analysis.bottom_profitable_foreign.length,\n      assets: analysis.bottom_profitable_foreign.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        currency: a.faceunit,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    }\n  };\n\n  return { json: formattedAnalysis };\n\n} catch (error) {\n  return {\n    json: {\n      error: true,\n      error_message: error.message,\n      error_stack: error.stack,\n      timestamp: new Date().toISOString()\n    }\n  };\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4096,
        -1728
      ],
      "id": "40b1be89-d7f2-4e4b-a865-81bccf60ddff",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me11",
      "typeVersion": 1,
      "position": [
        -720,
        -1712
      ],
      "id": "1ad7b615-626c-41d5-99a2-dd580cabca28"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// Calc: Invested Amount1 - УЛУЧШЕННАЯ ВЕРСИЯ\n// n8n версия 1.116.2\n// ============================================================================\n// Расчет инвестированных средств с учетом комиссий и налогов\n// ============================================================================\n\n// Получаем все операции из входных данных\nconst operations = $input.all();\n\n// Инициализируем объект для хранения инвестиций по валютам\nconst investments = {};\n\n// Обрабатываем каждую операцию\nfor (const item of operations) {\n  const event = item.json.Event;\n  const currency = item.json.Currency;\n  const quantity = parseFloat(item.json.Quantity) || 0;\n  const feeTax = parseFloat(item.json.FeeTax) || 0;\n  \n  // Инициализируем валюту, если её ещё нет\n  if (!investments[currency]) {\n    investments[currency] = {\n      cash_in: 0,           // Пополнения счета\n      cash_out: 0,          // Выводы со счета\n      commissions: 0,       // Сумма комиссий (FEE)\n      dividend_taxes: 0,    // Налоги из дивидендов\n      cash_expenses: 0,     // Прочие расходы (налоги на прирост капитала и т.д.)\n      cash_gains: 0,        // Возвраты налогов и прочие доходы\n      net: 0,\n      count_in: 0,\n      count_out: 0,\n      count_fees: 0,\n      count_div_taxes: 0,\n      count_expenses: 0,\n      count_gains: 0\n    };\n  }\n  \n  // Обрабатываем операции пополнения\n  if (event === 'CASH_IN') {\n    investments[currency].cash_in += quantity;\n    investments[currency].count_in += 1;\n  }\n  \n  // Обрабатываем операции вывода\n  else if (event === 'CASH_OUT') {\n    investments[currency].cash_out += quantity;\n    investments[currency].count_out += 1;\n  }\n  \n  // Обрабатываем комиссии - везде, где есть FEE\n  else if (event === 'FEE') {\n    investments[currency].commissions += feeTax;\n    investments[currency].count_fees += 1;\n  }\n  \n  // Обрабатываем налоги из дивидендов - поле FeeTax для DIVIDEND\n  else if (event === 'DIVIDEND') {\n    if (feeTax > 0) {\n      investments[currency].dividend_taxes += feeTax;\n      investments[currency].count_div_taxes += 1;\n    }\n  }\n  \n  // Обрабатываем комиссии и налоги при других операциях (BUY, SELL и т.д.)\n  else if (event === 'BUY' || event === 'SELL' || event === 'CASH_CONVERT') {\n    if (feeTax > 0) {\n      investments[currency].commissions += feeTax;\n      investments[currency].count_fees += 1;\n    }\n  }\n  \n  // Обрабатываем прочие расходы (налоги на прирост капитала и т.д.)\n  else if (event === 'CASH_EXPENSE') {\n    investments[currency].cash_expenses += quantity;\n    investments[currency].count_expenses += 1;\n  }\n  \n  // Обрабатываем возвраты налогов и прочие доходы\n  else if (event === 'CASH_GAIN') {\n    investments[currency].cash_gains += quantity;\n    investments[currency].count_gains += 1;\n  }\n}\n\n// ============================================================================\n// Вычисляем чистые инвестиции для каждой валюты по формуле:\n// net_investment = cash_in - cash_out - commissions - dividend_taxes - cash_expenses + cash_gains\n// ============================================================================\n\nfor (const currency in investments) {\n  const inv = investments[currency];\n  inv.net = \n    inv.cash_in                    // Добавляем пополнения\n    - inv.cash_out                 // Вычитаем выводы\n    - inv.commissions              // Вычитаем все комиссии\n    - inv.dividend_taxes           // Вычитаем налоги из дивидендов\n    - inv.cash_expenses            // Вычитаем прочие расходы/налоги\n    + inv.cash_gains;              // Добавляем возвраты и прочие доходы\n}\n\n// ============================================================================\n// Формируем результат для вывода\n// ============================================================================\n\nconst result = [];\n\nfor (const currency in investments) {\n  const inv = investments[currency];\n  \n  result.push({\n    json: {\n      currency: currency,\n      // Основные компоненты\n      cash_in: inv.cash_in.toFixed(2),\n      cash_out: inv.cash_out.toFixed(2),\n      commissions_total: inv.commissions.toFixed(2),\n      dividend_taxes_total: inv.dividend_taxes.toFixed(2),\n      cash_expenses_total: inv.cash_expenses.toFixed(2),\n      cash_gains_total: inv.cash_gains.toFixed(2),\n      // Итоговая чистая инвестиция\n      net_investment: inv.net.toFixed(2),\n      // Количество операций\n      operations_in: inv.count_in,\n      operations_out: inv.count_out,\n      operations_fees: inv.count_fees,\n      operations_div_taxes: inv.count_div_taxes,\n      operations_expenses: inv.count_expenses,\n      operations_gains: inv.count_gains\n    }\n  });\n}\n\n// Добавляем итоговую запись с общей информацией\nresult.push({\n  json: {\n    currency: 'TOTAL_CURRENCIES',\n    total_currencies: Object.keys(investments).length,\n    comment: 'Summary of all currencies with commissions and taxes'\n  }\n});\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        -3552
      ],
      "id": "17045d91-041c-42ed-9b41-7073598ff87c",
      "name": "Calc: Invested Amount2"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "VtkRBwAPL3DAoCg4",
          "mode": "list",
          "cachedResultName": "Operation_IIS",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/VtkRBwAPL3DAoCg4"
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -144,
        -3392
      ],
      "id": "3ae9cdb5-d085-453a-965e-1a04b2cf4420",
      "name": "STANDART-Get rows2"
    },
    {
      "parameters": {
        "jsCode": "// Получаем все операции\nconst operations = $input.all();\n\n// Словарь для хранения позиций\nconst positions = {};\n\n// Функция для форматирования даты (ДД/ММ/ГГГГ)\nfunction formatDateShort(dateString) {\n  if (!dateString) return null;\n  const date = new Date(dateString);\n  const day = String(date.getDate()).padStart(2, '0');\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const year = date.getFullYear();\n  return `${day}/${month}/${year}`;\n}\n\n// Обрабатываем операции в хронологическом порядке\nfor (const item of operations) {\n  const data = item.json;\n  const symbol = data.Symbol;\n  const event = data.Event;\n  const quantity = parseFloat(data.Quantity) || 0;\n  const price = parseFloat(data.Price) || 0;\n  const nkd = parseFloat(data.NKD) || 0;\n  const currency = data.Currency;\n  const date = data.Date;\n  \n  // Пропускаем операции без символа\n  if (!symbol) continue;\n  \n  // Пропускаем валютные операции\n  if (['CASH_IN', 'CASH_OUT', 'CASH_CONVERT', 'CASH_GAIN', 'CASH_EXPENSE'].includes(event)) {\n    continue;\n  }\n  \n  // Инициализируем позицию\n  if (!positions[symbol]) {\n    positions[symbol] = {\n      quantity: 0,\n      total_cost: 0,\n      currency: currency,\n      first_purchase: null,\n      last_operation: null\n    };\n  }\n  \n  const pos = positions[symbol];\n  \n  // Обрабатываем разные типы операций\n  switch(event) {\n    case 'BUY':\n      // Покупка\n      const buyCost = (price + nkd) * quantity;\n      pos.quantity += quantity;\n      pos.total_cost += buyCost;\n      if (!pos.first_purchase) {\n        pos.first_purchase = date;\n      }\n      pos.last_operation = date;\n      break;\n      \n    case 'SELL':\n      // Продажа\n      const sellCost = (price + nkd) * quantity;\n      pos.quantity -= quantity;\n      pos.total_cost -= sellCost;\n      pos.last_operation = date;\n      break;\n      \n    case 'REPAYMENT':\n      // Погашение облигации\n      pos.quantity -= quantity;\n      pos.last_operation = date;\n      break;\n      \n    case 'DIVIDEND':\n    case 'STOCK_AS_DIVIDEND':\n    case 'AMORTISATION':\n    case 'SPLIT':\n    case 'FEE':\n    case 'CUSTOM_HOLDING_PRICE':\n    case 'CUSTOM_HOLDING_SETTINGS':\n      // Обновляем только дату последней операции\n      pos.last_operation = date;\n      break;\n  }\n}\n\n// Формируем результат только для активных позиций\nconst result = [];\n\nfor (const symbol in positions) {\n  const pos = positions[symbol];\n  \n  // Пропускаем проданные/погашенные активы\n  if (pos.quantity <= 0.0001) continue;\n  \n  // Вычисляем среднюю цену покупки\n  const avgBuyPrice = pos.total_cost / pos.quantity;\n  \n  // Формируем объект позиции с требуемыми полями\n  result.push({\n    json: {\n      Symbol: symbol,\n      Currency: pos.currency,\n      Quantity: parseFloat(pos.quantity.toFixed(4)),\n      AvgBuyPrice: parseFloat(avgBuyPrice.toFixed(2)),\n      TotalInvested: parseFloat(pos.total_cost.toFixed(2)),\n      FirstPurchaseDate: formatDateShort(pos.first_purchase),\n      LastOperationDate: formatDateShort(pos.last_operation)\n    }\n  });\n}\n\n// Сортируем по TotalInvested (убывание)\nresult.sort((a, b) => b.json.TotalInvested - a.json.TotalInvested);\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        -3392
      ],
      "id": "75962c18-7b6b-496e-ba8e-57fe0f651edd",
      "name": "Calc: Portfolio Composition2"
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1152,
        -3168
      ],
      "id": "fb8c6510-7c9c-4764-a598-4f04b9843d51",
      "name": "Loop Over Items7"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities/{{ $json.Symbol }}.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "boards"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 5000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        624,
        -3120
      ],
      "id": "a6b58071-6f80-4f22-817b-9775b019fa29",
      "name": "Find Board4",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Приоритет boards для разных типов активов\nconst priorityBoards = ['TQBR', 'TQTF', 'TQCB', 'TQOB', 'TQOD', 'TQEU', 'TQCN', 'CETS'];\n\n// Обработка всех входящих элементов\nconst results = [];\n\nfor (const item of $input.all()) {\n  const data = item.json;\n  \n  try {\n    // ВАЖНО: Данные приходят в виде полного HTTP ответа\n    // Нам нужно достать Symbol из исходных данных ДО парсинга\n    // К сожалению, в Code узле его нет...\n    // Поэтому используем индекс из массива\n    const itemIndex = item._index || item.index;\n    \n    // Парсим JSON из поля body\n    let boardsResponse;\n    if (typeof data.body === 'string') {\n      boardsResponse = JSON.parse(data.body);\n    } else {\n      boardsResponse = data.body;\n    }\n    \n    // Получаем Symbol из первой строки данных (это ISIN/тикер)\n    const symbol = boardsResponse.boards?.data[0]?.[0] || 'UNKNOWN';\n    \n    const boardsData = boardsResponse.boards;\n    \n    if (!boardsData || !boardsData.data || boardsData.data.length === 0) {\n      results.push({\n        json: {\n          Symbol: symbol,\n          Board: null,\n          Engine: null,\n          Market: null,\n          Error: 'No boards found'\n        }\n      });\n      continue;\n    }\n    \n    // Создаем индекс для быстрого поиска колонок\n    const columnIndex = {};\n    boardsData.columns.forEach((col, idx) => {\n      columnIndex[col] = idx;\n    });\n    \n    // Ищем подходящий board по приоритету\n    let selectedBoard = null;\n    \n    for (const priorityBoard of priorityBoards) {\n      for (let i = 0; i < boardsData.data.length; i++) {\n        const boardId = boardsData.data[i][columnIndex['boardid']];\n        const isTraded = boardsData.data[i][columnIndex['is_traded']];\n        \n        if (boardId === priorityBoard && isTraded === 1) {\n          selectedBoard = {\n            boardid: boardId,\n            engine: boardsData.data[i][columnIndex['engine']],\n            market: boardsData.data[i][columnIndex['market']]\n          };\n          break;\n        }\n      }\n      if (selectedBoard) break;\n    }\n    \n    // Если не нашли по приоритету, берем первый активный\n    if (!selectedBoard) {\n      for (let i = 0; i < boardsData.data.length; i++) {\n        const isTraded = boardsData.data[i][columnIndex['is_traded']];\n        \n        if (isTraded === 1) {\n          selectedBoard = {\n            boardid: boardsData.data[i][columnIndex['boardid']],\n            engine: boardsData.data[i][columnIndex['engine']],\n            market: boardsData.data[i][columnIndex['market']]\n          };\n          break;\n        }\n      }\n    }\n    \n    if (!selectedBoard) {\n      results.push({\n        json: {\n          Symbol: symbol,\n          Board: null,\n          Engine: null,\n          Market: null,\n          Error: 'No active boards'\n        }\n      });\n      continue;\n    }\n    \n    // Возвращаем результат\n    results.push({\n      json: {\n        Symbol: symbol,\n        Board: selectedBoard.boardid,\n        Engine: selectedBoard.engine,\n        Market: selectedBoard.market\n      }\n    });\n    \n  } catch (error) {\n    console.log(`Ошибка: ${error.message}`);\n    results.push({\n      json: {\n        Symbol: 'ERROR',\n        Board: null,\n        Engine: null,\n        Market: null,\n        Error: error.message\n      }\n    });\n  }\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        -3120
      ],
      "id": "ebaab858-9d89-4ff6-a94b-5c416bb8b540",
      "name": "Parse Boards2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4e0fb2f8-e29b-45a4-9c58-eddd4dcec84b",
              "leftValue": "={{ $json.Board }}",
              "rightValue": "null",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        688,
        -3504
      ],
      "id": "a65c11b0-c30b-41c1-ab1c-93b8c1e77d4f",
      "name": "If2"
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        400,
        -3296
      ],
      "id": "6bbeeb55-cdd0-498d-ba65-3ca8b4ef2a54",
      "name": "Loop Over Items8"
    },
    {
      "parameters": {
        "jsCode": "// Функция для форматирования даты\nfunction formatDate(dateString) {\n  if (!dateString || dateString === '0000-00-00' || dateString === null) {\n    return null;\n  }\n  \n  try {\n    const date = new Date(dateString);\n    // Проверяем, является ли дата валидной\n    if (isNaN(date.getTime())) {\n      return null;\n    }\n    \n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = date.getFullYear();\n    \n    return `${day}.${month}.${year}`;\n  } catch (error) {\n    return null;\n  }\n}\n\n// Основная логика парсинга\nconst items = $input.all();\n\nreturn items.map((item) => {\n  try {\n    // Получаем данные из тела ответа\n    const response = item.json?.body || item.json || {};\n    \n    // Извлекаем массивы securities и marketdata\n    const securitiesData = response.securities?.data?.[0] || [];\n    const securitiesColumns = response.securities?.columns || [];\n    \n    const marketdataData = response.marketdata?.data?.[0] || [];\n    const marketdataColumns = response.marketdata?.columns || [];\n    \n    // Функция для получения значения по названию колонки\n    function getValueFromArray(dataArray, columnsArray, columnName) {\n      const index = columnsArray.indexOf(columnName);\n      return index !== -1 ? dataArray[index] : null;\n    }\n    \n    // Извлекаем требуемые поля\n    const result = {\n      // Securities fields\n      SECID: getValueFromArray(securitiesData, securitiesColumns, 'SECID'),\n      BOARDID: getValueFromArray(securitiesData, securitiesColumns, 'BOARDID'),\n      SHORTNAME: getValueFromArray(securitiesData, securitiesColumns, 'SHORTNAME'),\n      PREVPRICE: getValueFromArray(securitiesData, securitiesColumns, 'PREVPRICE'),\n      FACEVALUE: getValueFromArray(securitiesData, securitiesColumns, 'FACEVALUE'),\n      STATUS: getValueFromArray(securitiesData, securitiesColumns, 'STATUS'),\n      ISIN: getValueFromArray(securitiesData, securitiesColumns, 'ISIN'),\n      PREVLEGALCLOSEPRICE: getValueFromArray(securitiesData, securitiesColumns, 'PREVLEGALCLOSEPRICE'),\n      SECTYPE: getValueFromArray(securitiesData, securitiesColumns, 'SECTYPE'),\n      COUPONPERCENT: getValueFromArray(securitiesData, securitiesColumns, 'COUPONPERCENT'),\n      COUPONVALUE: getValueFromArray(securitiesData, securitiesColumns, 'COUPONVALUE'),\n      MATDATE: getValueFromArray(securitiesData, securitiesColumns, 'MATDATE'),\n      OFFERDATE: getValueFromArray(securitiesData, securitiesColumns, 'OFFERDATE'),\n      ACCRUEDINT: getValueFromArray(securitiesData, securitiesColumns, 'ACCRUEDINT'),\n      CURRENCYID: getValueFromArray(securitiesData, securitiesColumns, 'CURRENCYID'),\n      \n      // Marketdata fields\n      LCURRENTPRICE: getValueFromArray(marketdataData, marketdataColumns, 'LCURRENTPRICE'),\n      YIELD: getValueFromArray(marketdataData, marketdataColumns, 'YIELD'),\n      DURATION: getValueFromArray(marketdataData, marketdataColumns, 'DURATION'),\n      YIELDATWAPRICE: getValueFromArray(marketdataData, marketdataColumns, 'YIELDATWAPRICE')\n    };\n    \n    // Обработка FACEUNIT: замена \"SUR\" на \"RUB\"\n    let faceUnit = getValueFromArray(securitiesData, securitiesColumns, 'FACEUNIT');\n    result.FACEUNIT = faceUnit === 'SUR' ? 'RUB' : faceUnit;\n        \n    // Форматирование дат\n    const nextCouponRaw = getValueFromArray(securitiesData, securitiesColumns, 'NEXTCOUPON');\n    result.NEXTCOUPON_FORMATTED = formatDate(nextCouponRaw);\n    \n    result.MATDATE_FORMATTED = formatDate(result.MATDATE);\n    result.OFFERDATE_FORMATTED = formatDate(result.OFFERDATE);\n    \n    return { json: result };\n    \n  } catch (error) {\n    // В случае ошибки возвращаем объект с информацией об ошибке\n    return {\n      json: {\n        error: true,\n        errorMessage: error.message,\n        originalData: item.json\n      }\n    };\n  }\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1696,
        -3104
      ],
      "id": "623cc6d5-fe6c-4495-a8be-b2bff0affce8",
      "name": "Code in JavaScript6"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/engines/{{ $json.Engine }}/markets/{{ $json.Market }}/boards/{{ $json.Board }}/securities/{{ $json.Symbol }}.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "securities,marketdata,description"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 2000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        -3104
      ],
      "id": "8a7ebe32-9531-4602-bfaf-4c2783153142",
      "name": "Fetch MOEX Data2",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities/{{ $json.Symbol }}.json\n",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iss.meta",
              "value": "off"
            },
            {
              "name": "iss.only",
              "value": "description"
            },
            {
              "name": "description.columns",
              "value": "name,title,value"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          },
          "timeout": 2000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1344,
        -3584
      ],
      "id": "2a7ea4f7-fb27-44b3-a379-1767356fa454",
      "name": "Find Board5",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Получаем входные данные\nconst items = $input.all();\nconst result = [];\n\n// Обработка каждого элемента входных данных\nfor (const item of items) {\n  const json = item.json;\n  \n  // Проверяем наличие описания\n  if (json.body && json.body.description) {\n    const description = json.body.description;\n    const data = description.data; // Массив массивов\n    \n    // Преобразуем массив [name, title, value] в объект\n    const parsed = {};\n    for (const row of data) {\n      if (Array.isArray(row) && row.length >= 3) {\n        const fieldName = row[0];  // \"SECID\", \"ISIN\" и т.д.\n        const fieldValue = row[2]; // Значение\n        parsed[fieldName] = fieldValue;\n      }\n    }\n    \n    // Нормализация валюты: SUR -> RUB\n    const faceUnit = parsed.FACEUNIT || 'RUB';\n    const normalizedFaceUnit = faceUnit === 'SUR' ? 'RUB' : faceUnit;\n    \n    // Форматируем выходные данные\n    const output = {\n      SECID: parsed.SECID || '',\n      SHORTNAME: parsed.SHORTNAME || '',\n      ISIN: parsed.ISIN || parsed.SECID || '',\n      MATDATE: parsed.MATDATE || '',\n      INITIALFACEVALUE: Number(parsed.INITIALFACEVALUE || 1000),\n      FACEUNIT: normalizedFaceUnit,\n      HASDEFAULT: parsed.HASDEFAULT === '1' || parsed.HASDEFAULT === 1,\n      HASTECHNICALDEFAULT: parsed.HASTECHNICALDEFAULT === '1' || parsed.HASTECHNICALDEFAULT === 1,\n      DAYSTOREDEMPTION: Number(parsed.DAYSTOREDEMPTION || 0),\n      FACEVALUE: Number(parsed.FACEVALUE || 1000),\n      COUPONFREQUENCY: Number(parsed.COUPONFREQUENCY || 0),\n      COUPONDATE: parsed.COUPONDATE || '',\n      COUPONPERCENT: Number(parsed.COUPONPERCENT || 0),\n      COUPONVALUE: Number(parsed.COUPONVALUE || 0),\n      TYPENAME: parsed.TYPENAME || '',\n      GROUP: parsed.GROUP || '',\n      TYPE: parsed.TYPE || '',\n      GROUPNAME: parsed.GROUPNAME || '',\n      EMITTER_ID: String(parsed.EMITTER_ID || '')\n    };\n    \n    result.push({ json: output });\n  }\n}\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1664,
        -3584
      ],
      "id": "7e71801b-95e5-416b-90fc-61c0b93dc548",
      "name": "Code in JavaScript7",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "batchSize": 2,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1120,
        -3744
      ],
      "id": "f35b4a55-f337-4951-842a-81b1b75a9b9b",
      "name": "Loop Over Items9"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "SECID",
        "joinMode": "enrichInput1",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2016,
        -3488
      ],
      "id": "4ee91ea9-0156-4a0c-9e31-4007b710054d",
      "name": "Merge8"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "SECID",
              "field2": "Symbol"
            }
          ]
        },
        "joinMode": "enrichInput1",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2224,
        -3408
      ],
      "id": "6b6ba568-ae18-4e69-8d6e-91b5d7578f52",
      "name": "Merge9"
    },
    {
      "parameters": {
        "url": "https://www.cbr-xml-daily.ru/latest.js",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json, text/javascript"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        144,
        -2912
      ],
      "id": "7e6fd8bd-df7b-43b1-8194-d8cf75f08299",
      "name": "Get Currency Rates from MOEX2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2528,
        -3392
      ],
      "id": "4023eb92-afb6-4d08-bc05-eb6cf98a4fe5",
      "name": "Merge10"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ПАРСИНГ КУРСОВ ВАЛЮТ ЦБ РФ - МИНИМАЛЬНЫЙ ФОРМАТ\n * n8n v1.116.2\n * \n * Возвращает только необходимые данные\n */\n\ntry {\n  const input = $input.item.json;\n  \n  if (!input.body || !input.body.rates) {\n    throw new Error('Invalid response: missing rates data');\n  }\n  \n  const data = input.body;\n  \n  // Основные валюты для портфеля\n  const currencyCodes = {\n    'USD': 2,   // 2 знака для отображения\n    'EUR': 2,\n    'CNY': 2\n  };\n  \n  // Инициализируем результат\n  const rates = {\n    'RUB': 1\n  };\n  \n  // Обрабатываем валюты\n  for (const [code, decimals] of Object.entries(currencyCodes)) {\n    if (data.rates[code]) {\n      const inverseRate = parseFloat(data.rates[code]);\n      const directRate = 1 / inverseRate;\n      \n      // Округляем до нужного количества знаков\n      rates[code] = Math.round(directRate * Math.pow(10, decimals)) / Math.pow(10, decimals);\n    }\n  }\n  \n  // Возвращаем только timestamp и rates\n  return [{\n    json: {\n      timestamp: new Date().toISOString(),\n      rates: rates\n    }\n  }];\n  \n} catch (error) {\n  console.error('Error:', error.message);\n  \n  return [{\n    json: {\n      timestamp: new Date().toISOString(),\n      rates: {\n        'RUB': 1,\n        'USD': 79.47,\n        'EUR': 92.25,\n        'CNY': 11.17,\n        'GBP': 105.52\n      }\n    }\n  }];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1920,
        -2912
      ],
      "id": "29e4a16c-2204-4d1e-b273-928298058005",
      "name": "Code Kurs2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me12",
      "typeVersion": 1,
      "position": [
        1520,
        -3184
      ],
      "id": "da6ec6df-05e5-4941-a6f5-1798ec31a196"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me13",
      "typeVersion": 1,
      "position": [
        1520,
        -3760
      ],
      "id": "ebc6ca9c-7740-4a84-966d-b4d6938992b3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me14",
      "typeVersion": 1,
      "position": [
        1120,
        -3920
      ],
      "id": "4f835294-9dd7-497d-a999-f91109153aee"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me15",
      "typeVersion": 1,
      "position": [
        1280,
        -2608
      ],
      "id": "415f2a37-4475-4a97-90fb-f2d2227ca5eb"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3888,
        -3408
      ],
      "id": "95d8f388-ad92-47d5-8a11-14fd978f8de3",
      "name": "Merge11"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me16",
      "typeVersion": 1,
      "position": [
        3200,
        -3920
      ],
      "id": "a9df8475-c5d6-448a-89df-4529a1f3f895"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================================================\n * АНАЛИЗ ПОРТФЕЛЯ - УЗЕЛ CODE N8N (версия 1.116.2) - v10 ФИНАЛЬНАЯ\n * ============================================================================\n * \n * ДОБАВЛЕНО В v10:\n * \n * ✓ portfolio_absolute_profit_rub - абсолютная прибыль в рублях\n * ✓ portfolio_gain_percent - относительный рост в процентах\n * \n * Формулы:\n *   portfolio_absolute_profit_rub = portfolio_current_value - net_investment\n *   portfolio_gain_percent = (portfolio_absolute_profit / net_investment) × 100\n * \n * ============================================================================\n */\n\n// ============================================================================\n// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ\n// ============================================================================\n\nconst SECTYPE_MAP = {\n  '1': { name: 'Акция', group: 'stocks' },\n  '2': { name: 'Акция', group: 'stocks' },\n  '3': { name: 'ОФЗ', group: 'ofz' },\n  '4': { name: 'Муниципальная облигация', group: 'municipal_bonds' },\n  '5': { name: 'ОФЗ', group: 'ofz' },\n  '6': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '7': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '8': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  '9': { name: 'ETF', group: 'etf' },\n  'A': { name: 'ETF', group: 'etf' },\n  'B': { name: 'ETF', group: 'etf' },\n  'C': { name: 'Ипотечные сертификаты участия', group: 'other' },\n  'D': { name: 'Депозитарные расписки', group: 'other' },\n  'E': { name: 'Варранты', group: 'other' },\n  'F': { name: 'Еврооблигации', group: 'eurobonds' },\n  'G': { name: 'Векселя', group: 'other' },\n  'H': { name: 'Залоговые расписки', group: 'other' },\n  'J': { name: 'ETF', group: 'etf' },\n  'K': { name: 'ETF', group: 'etf' },\n  'L': { name: 'Корпоративная облигация', group: 'corporate_bonds' },\n  'M': { name: 'Деривативы, фьючерсы и т.д.', group: 'other' }\n};\n\n// ╔═══════════════════════════════════════════════════════════════════════════╗\n// ║ КОНСТАНТА: ДОХОДНОСТЬ ETF                                                ║\n// ║ Для всех ETF устанавливается фиксированное значение YIELDATWAPRICE       ║\n// ║ РЕДАКТИРУЙ ЗДЕСЬ, ЕСЛИ НУЖНО ИЗМЕНИТЬ ПРОЦЕНТ ДОХОДНОСТИ ETF            ║\n// ╚═══════════════════════════════════════════════════════════════════════════╝\nconst ETF_YIELD_ATWAPRICE = 15.3;  // Доходность ETF в процентах\n// ═══════════════════════════════════════════════════════════════════════════\n\nfunction isETFType(sectype) {\n  const etfCodes = ['9', 'A', 'B', 'J', 'K'];\n  return etfCodes.includes(sectype);\n}\n\nfunction getAssetTypeWithFaceUnit(sectype, faceUnit) {\n  const typeInfo = SECTYPE_MAP[sectype] || { name: 'Прочее', group: 'other' };\n  \n  const corpBondCodes = ['6', '7', '8', 'L'];\n  if (corpBondCodes.includes(sectype) && faceUnit && faceUnit !== 'RUB' && faceUnit !== 'SUR') {\n    return { name: 'Еврооблигации', group: 'eurobonds' };\n  }\n  \n  return typeInfo;\n}\n\nfunction toNumber(value, defaultValue = 0) {\n  if (value === null || value === undefined || value === '') return defaultValue;\n  const num = parseFloat(value);\n  return isNaN(num) ? defaultValue : num;\n}\n\nfunction roundTo(value, decimals = 2) {\n  return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);\n}\n\nfunction formatCurrency(value, decimals = 2) {\n  return new Intl.NumberFormat('ru-RU', {\n    minimumFractionDigits: decimals,\n    maximumFractionDigits: decimals\n  }).format(value);\n}\n\nfunction formatPercent(value, decimals = 2) {\n  return roundTo(value, decimals) + '%';\n}\n\nfunction getExchangeRate(currencyId, rates) {\n  const normalizedCurrency = (currencyId === 'SUR') ? 'RUB' : currencyId;\n  \n  if (normalizedCurrency === 'RUB') {\n    return 1;\n  }\n  \n  if (rates && rates[normalizedCurrency]) {\n    return rates[normalizedCurrency];\n  }\n  \n  console.warn(`Exchange rate for ${normalizedCurrency} not found. Using 1.0`);\n  return 1;\n}\n\nfunction calculateNKDInRUB(accruedInt, currencyId, rates) {\n  if (!accruedInt || accruedInt === 0 || accruedInt === null) {\n    return 0;\n  }\n  \n  const normalizedCurrency = (currencyId === 'SUR') ? 'RUB' : currencyId;\n  const exchangeRate = getExchangeRate(currencyId, rates);\n  const nkdInRUB = toNumber(accruedInt, 0) * exchangeRate;\n  \n  return nkdInRUB;\n}\n\nfunction calculateCurrentValueRUB(asset, rates) {\n  const quantity = toNumber(asset.Quantity, 0);\n  const lcurrentprice = toNumber(asset.LCURRENTPRICE, 0);\n  const facevalue = toNumber(asset.FACEVALUE, 0);\n  const initialfacevalue = toNumber(asset.INITIALFACEVALUE, 1000);\n  const faceUnit = asset.FACEUNIT || 'RUB';\n  const sectype = asset.SECTYPE || '';\n  \n  const faceUnitExchangeRate = getExchangeRate(faceUnit, rates);\n  \n  if (isETFType(sectype)) {\n    return quantity * lcurrentprice * faceUnitExchangeRate;\n  } else {\n    const nominality = facevalue > 0 ? facevalue : initialfacevalue;\n    const priceWithoutNKD = (lcurrentprice / 100) * nominality;\n    const nkdInRUB = calculateNKDInRUB(asset.ACCRUEDINT, asset.CURRENCYID, rates);\n    const priceWithNKDInRUB = (priceWithoutNKD * faceUnitExchangeRate) + nkdInRUB;\n    const valueInRUB = quantity * priceWithNKDInRUB;\n    \n    return valueInRUB;\n  }\n}\n\nfunction calculateCurrentPriceWithoutNKD(asset) {\n  const lcurrentprice = toNumber(asset.LCURRENTPRICE, 0);\n  const facevalue = toNumber(asset.FACEVALUE, 0);\n  const initialfacevalue = toNumber(asset.INITIALFACEVALUE, 1000);\n  const sectype = asset.SECTYPE || '';\n  \n  if (isETFType(sectype)) {\n    return lcurrentprice;\n  } else {\n    const nominality = facevalue > 0 ? facevalue : initialfacevalue;\n    const price = (lcurrentprice / 100) * nominality;\n    return price;\n  }\n}\n\nfunction getYieldValue(asset) {\n  const sectype = asset.SECTYPE || '';\n  \n  if (isETFType(sectype)) {\n    return ETF_YIELD_ATWAPRICE;\n  } else {\n    let yield_value = toNumber(asset.YIELDATWAPRICE, null);\n    if (yield_value === null || yield_value === 0) {\n      yield_value = toNumber(asset.YIELD, null);\n    }\n    return yield_value;\n  }\n}\n\nfunction isRealAsset(asset) {\n  return asset.SECID && typeof asset.SECID === 'string' && \n         asset.SECID.trim() !== '' &&\n         asset.Symbol !== undefined;\n}\n\n// ============================================================================\n// ОСНОВНАЯ ЛОГИКА АНАЛИЗА\n// ============================================================================\n\ntry {\n  const allItems = $input.all();\n  const allData = allItems.map(item => item.json).filter(json => json && typeof json === 'object');\n  \n  if (!allData || allData.length === 0) {\n    throw new Error('Входные данные пусты или неправильного формата');\n  }\n\n  let netInvestmentRUB = 0;\n  let exchangeRates = { RUB: 1, USD: 1, EUR: 1, CNY: 1 };\n  const assets = [];\n\n  allData.forEach(item => {\n    if (item.rates && typeof item.rates === 'object') {\n      exchangeRates = item.rates;\n    } else if (item.currency === 'RUB' && item.cash_in !== undefined) {\n      netInvestmentRUB = toNumber(item.net_investment, 0);\n    } else if (item.currency === 'TOTAL_CURRENCIES' || item.total_currencies !== undefined) {\n      return;\n    } else if (isRealAsset(item)) {\n      assets.push(item);\n    }\n  });\n\n  if (assets.length === 0) {\n    throw new Error('Не найдено ни одного актива в данных.');\n  }\n\n  const analysis = {\n    portfolio_name: 'IIS-3',\n    analysis_timestamp: new Date().toISOString(),\n    total_assets_count: 0,\n    portfolio_current_value_rub: 0,\n    portfolio_absolute_profit_rub: 0,\n    portfolio_gain_percent: 0,\n    average_coupon_yield: 0,\n    portfolio_yield_by_current_value: 0,\n    portfolio_yield_roi: 0,\n    portfolio_yield_average: 0,\n    net_investment: netInvestmentRUB,\n    asset_distribution: {},\n    assets_with_default: [],\n    assets_with_technical_default: [],\n    top_profitable_rub: [],\n    top_profitable_foreign: [],\n    bottom_profitable_rub: [],\n    bottom_profitable_foreign: []\n  };\n\n  const assetTypeDistribution = {};\n  let totalCurrentValueRUB = 0;\n  let validAssetsCount = 0;\n\n  let totalWeightedYield = 0;\n  let totalQuantityForYield = 0;\n\n  let totalYieldCurrentWeighted = 0;\n  let totalCurrentValueForYield = 0;\n  \n  let totalYieldROIWeighted = 0;\n  let totalInvestedValueForYield = 0;\n\n  const profitableAssets = [];\n  const profitableAssetsByForeignCurrency = [];\n\n  // =========================================================================\n  // ОБРАБОТКА КАЖДОГО АКТИВА\n  // =========================================================================\n\n  assets.forEach(asset => {\n    const currentValueRUB = calculateCurrentValueRUB(asset, exchangeRates);\n    \n    if (currentValueRUB === 0 || !isFinite(currentValueRUB)) {\n      return;\n    }\n\n    validAssetsCount += 1;\n\n    const sectype = asset.SECTYPE || '';\n    const faceUnit = asset.FACEUNIT || 'RUB';\n    const shortName = asset.SHORTNAME || asset.SECID || 'Unknown';\n    const quantity = toNumber(asset.Quantity, 0);\n    const couponPercent = toNumber(asset.COUPONPERCENT, null);\n    const hasDefault = asset.HASDEFAULT ? true : false;\n    const hasTechDefault = asset.HASTECHNICALDEFAULT ? true : false;\n    \n    const assetTypeInfo = getAssetTypeWithFaceUnit(sectype, faceUnit);\n    const assetTypeName = assetTypeInfo.name;\n\n    if (!assetTypeDistribution[assetTypeName]) {\n      assetTypeDistribution[assetTypeName] = {\n        count: 0,\n        total_value_rub: 0,\n        percent: 0\n      };\n    }\n    \n    assetTypeDistribution[assetTypeName].count += 1;\n    assetTypeDistribution[assetTypeName].total_value_rub += currentValueRUB;\n    totalCurrentValueRUB += currentValueRUB;\n    \n    const yield_value = getYieldValue(asset);\n    \n    if (assetTypeName !== 'Еврооблигации' && couponPercent !== null && couponPercent > 0) {\n      totalWeightedYield += couponPercent * quantity;\n      totalQuantityForYield += quantity;\n    }\n    \n    if (yield_value !== null && yield_value !== 0) {\n      \n      const priceWithoutNKD = calculateCurrentPriceWithoutNKD(asset);\n      const currentValueInNativeCurrencyWithoutNKD = quantity * priceWithoutNKD;\n      \n      totalYieldCurrentWeighted += (yield_value / 100) * currentValueInNativeCurrencyWithoutNKD;\n      totalCurrentValueForYield += currentValueInNativeCurrencyWithoutNKD;\n      \n      const avgBuyPrice = toNumber(asset.AvgBuyPrice, 0);\n      const investedSum = quantity * avgBuyPrice;\n      \n      totalYieldROIWeighted += (yield_value / 100) * investedSum;\n      totalInvestedValueForYield += investedSum;\n    }\n    \n    if (hasDefault) {\n      analysis.assets_with_default.push({\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        current_value_rub: roundTo(currentValueRUB, 2)\n      });\n    }\n    \n    if (hasTechDefault) {\n      analysis.assets_with_technical_default.push({\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        current_value_rub: roundTo(currentValueRUB, 2)\n      });\n    }\n    \n    if (!hasDefault && yield_value !== null && yield_value !== 0) {\n      const assetRecord = {\n        shortname: shortName,\n        secid: asset.SECID || asset.Symbol,\n        sectype_name: assetTypeName,\n        yield: roundTo(yield_value, 2),\n        current_value_rub: roundTo(currentValueRUB, 2),\n        faceunit: faceUnit,\n        quantity: quantity,\n        coupon_percent: couponPercent !== null ? roundTo(couponPercent, 2) : 'N/A'\n      };\n      \n      if (faceUnit === 'RUB' || faceUnit === 'SUR') {\n        profitableAssets.push(assetRecord);\n      } else {\n        profitableAssetsByForeignCurrency.push(assetRecord);\n      }\n    }\n  });\n\n  // =========================================================================\n  // РАСЧЕТЫ ФИНАЛЬНЫХ МЕТРИК\n  // =========================================================================\n\n  if (totalQuantityForYield > 0) {\n    analysis.average_coupon_yield = roundTo(totalWeightedYield / totalQuantityForYield, 2);\n  }\n\n  if (totalCurrentValueForYield > 0) {\n    analysis.portfolio_yield_by_current_value = roundTo(\n      (totalYieldCurrentWeighted / totalCurrentValueForYield) * 100,\n      2\n    );\n  }\n\n  if (totalInvestedValueForYield > 0) {\n    analysis.portfolio_yield_roi = roundTo(\n      (totalYieldROIWeighted / totalInvestedValueForYield) * 100,\n      2\n    );\n  }\n\n  if (analysis.average_coupon_yield > 0 && analysis.portfolio_yield_roi > 0) {\n    analysis.portfolio_yield_average = roundTo(\n      (analysis.average_coupon_yield + analysis.portfolio_yield_roi) / 2,\n      2\n    );\n  }\n\n  Object.keys(assetTypeDistribution).forEach(assetType => {\n    const distribution = assetTypeDistribution[assetType];\n    distribution.percent = totalCurrentValueRUB > 0 \n      ? roundTo((distribution.total_value_rub / totalCurrentValueRUB) * 100, 2)\n      : 0;\n    \n    analysis.asset_distribution[assetType] = {\n      count: distribution.count,\n      percent: distribution.percent,\n      total_value_rub: roundTo(distribution.total_value_rub, 2)\n    };\n  });\n\n  analysis.total_assets_count = validAssetsCount;\n  analysis.portfolio_current_value_rub = roundTo(totalCurrentValueRUB, 2);\n  analysis.net_investment = roundTo(netInvestmentRUB, 2);\n\n  // ═════════════════════════════════════════════════════════════════════════\n  // РАСЧЕТ АБСОЛЮТНОЙ ПРИБЫЛИ И ПРОЦЕНТА РОСТА\n  // ═════════════════════════════════════════════════════════════════════════\n  \n  analysis.portfolio_absolute_profit_rub = roundTo(\n    analysis.portfolio_current_value_rub - analysis.net_investment,\n    2\n  );\n  \n  if (analysis.net_investment > 0) {\n    analysis.portfolio_gain_percent = roundTo(\n      (analysis.portfolio_absolute_profit_rub / analysis.net_investment) * 100,\n      2\n    );\n  }\n\n  profitableAssets.sort((a, b) => b.yield - a.yield);\n  analysis.top_profitable_rub = profitableAssets.slice(0, 5);\n\n  profitableAssetsByForeignCurrency.sort((a, b) => b.yield - a.yield);\n  analysis.top_profitable_foreign = profitableAssetsByForeignCurrency.slice(0, 2);\n\n  profitableAssets.sort((a, b) => a.yield - b.yield);\n  analysis.bottom_profitable_rub = profitableAssets.slice(0, 10);\n\n  profitableAssetsByForeignCurrency.sort((a, b) => a.yield - b.yield);\n  analysis.bottom_profitable_foreign = profitableAssetsByForeignCurrency.slice(0, 1);\n\n  // =========================================================================\n  // ФОРМАТИРОВАНИЕ И ВЫВОД\n  // =========================================================================\n\n  const formattedAnalysis = {\n    portfolio_name: analysis.portfolio_name,\n    analysis_date: new Date(analysis.analysis_timestamp).toLocaleDateString('ru-RU'),\n    exchange_rates_used: exchangeRates,\n    \n    portfolio_metrics: {\n      total_assets_count: analysis.total_assets_count,\n      portfolio_current_value_rub: formatCurrency(analysis.portfolio_current_value_rub),\n      portfolio_current_value_rub_number: analysis.portfolio_current_value_rub,\n      portfolio_absolute_profit_rub: formatCurrency(analysis.portfolio_absolute_profit_rub),\n      portfolio_absolute_profit_rub_number: analysis.portfolio_absolute_profit_rub,\n      portfolio_gain_percent: analysis.portfolio_gain_percent,\n      average_coupon_yield_percent: analysis.average_coupon_yield,\n      portfolio_yield_by_current_value_percent: analysis.portfolio_yield_by_current_value,\n      portfolio_yield_roi_percent: analysis.portfolio_yield_roi,\n      portfolio_yield_average_percent: analysis.portfolio_yield_average,\n      net_investment_rub: formatCurrency(analysis.net_investment),\n      net_investment_rub_number: analysis.net_investment\n    },\n    \n    asset_distribution_by_type: (() => {\n      const dist = {};\n      Object.keys(analysis.asset_distribution).forEach(assetType => {\n        const data = analysis.asset_distribution[assetType];\n        dist[assetType] = {\n          count: data.count,\n          percent: formatPercent(data.percent),\n          percent_number: data.percent,\n          total_value_rub: formatCurrency(data.total_value_rub),\n          total_value_rub_number: data.total_value_rub\n        };\n      });\n      return dist;\n    })(),\n    \n    assets_with_default: {\n      count: analysis.assets_with_default.length,\n      assets: analysis.assets_with_default\n    },\n    \n    assets_with_technical_default: {\n      count: analysis.assets_with_technical_default.length,\n      assets: analysis.assets_with_technical_default\n    },\n    \n    top_5_profitable_rub: {\n      count: analysis.top_profitable_rub.length,\n      assets: analysis.top_profitable_rub.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_2_profitable_foreign_currency: {\n      count: analysis.top_profitable_foreign.length,\n      assets: analysis.top_profitable_foreign.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        currency: a.faceunit,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_10_least_profitable_rub: {\n      count: analysis.bottom_profitable_rub.length,\n      assets: analysis.bottom_profitable_rub.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    },\n    \n    top_1_least_profitable_foreign_currency: {\n      count: analysis.bottom_profitable_foreign.length,\n      assets: analysis.bottom_profitable_foreign.map((a, idx) => ({\n        rank: idx + 1,\n        shortname: a.shortname,\n        secid: a.secid,\n        sectype: a.sectype_name,\n        currency: a.faceunit,\n        yield_percent: a.yield,\n        current_value_rub: a.current_value_rub,\n        quantity: a.quantity,\n        coupon_percent: a.coupon_percent\n      }))\n    }\n  };\n\n  return { json: formattedAnalysis };\n\n} catch (error) {\n  return {\n    json: {\n      error: true,\n      error_message: error.message,\n      error_stack: error.stack,\n      timestamp: new Date().toISOString()\n    }\n  };\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4096,
        -3408
      ],
      "id": "f2070041-eea3-4099-92e6-917ef3fe1bb7",
      "name": "Code in JavaScript8"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me17",
      "typeVersion": 1,
      "position": [
        -720,
        -3392
      ],
      "id": "103d8c0c-3924-4698-9713-6f70f389e2c4"
    },
    {
      "parameters": {
        "operation": "deleteRows",
        "dataTableId": {
          "__rl": true,
          "value": "wrAvyTKEv5CPA0RM",
          "mode": "list",
          "cachedResultName": "SCEID_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/wrAvyTKEv5CPA0RM"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "condition": "gte",
              "keyValue": "0"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -464,
        -3632
      ],
      "id": "bd60d4b2-3f9a-4274-84d6-413f4b40f70e",
      "name": "Delete row(s)"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "PhI20HSNBd3CJyz4",
          "mode": "list",
          "cachedResultName": "ANALIZ_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/PhI20HSNBd3CJyz4"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "assets_with_technical_default": "={{ $json.assets_with_technical_default.count }}",
            "assets_with_default": "={{ $json.assets_with_default.count }}",
            "total_value_rub_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].total_value_rub_number }}",
            "percent_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].percent_number }}",
            "count_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].count }}",
            "total_value_rub_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].total_value_rub_number }}",
            "percent_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].percent_number }}",
            "count_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].count }}",
            "total_value_rub_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].total_value_rub_number }}",
            "percent_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].percent_number }}",
            "count_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].count }}",
            "total_value_rub_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].total_value_rub_number }}",
            "percent_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].percent_number }}",
            "count_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].count }}",
            "total_value_rub_ETF": "={{ $json.asset_distribution_by_type.ETF.total_value_rub_number }}",
            "percent_ETF": "={{ $json.asset_distribution_by_type.ETF.percent_number }}",
            "count_ETF": "={{ $json.asset_distribution_by_type.ETF.count }}",
            "net_investment_rub": "={{ $json.portfolio_metrics.net_investment_rub_number }}",
            "portfolio_yield_average_percent": "={{ $json.portfolio_metrics.portfolio_yield_average_percent }}",
            "portfolio_yield_roi_percent": "={{ $json.portfolio_metrics.portfolio_yield_roi_percent }}",
            "portfolio_yield_by_current_value_percent": "={{ $json.portfolio_metrics.portfolio_yield_by_current_value_percent }}",
            "average_coupon_yield_percent": "={{ $json.portfolio_metrics.average_coupon_yield_percent }}",
            "portfolio_gain_percent": "={{ $json.portfolio_metrics.portfolio_gain_percent }}",
            "portfolio_absolute_profit_rub": "={{ $json.portfolio_metrics.portfolio_absolute_profit_rub_number }}",
            "portfolio_current_value_rub": "={{ $json.portfolio_metrics.portfolio_current_value_rub_number }}",
            "total_assets_count": "={{ $json.portfolio_metrics.total_assets_count }}",
            "NAME_PORTF": "={{ $json.portfolio_name }}",
            "DATE": "={{ $json.analysis_date }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "DATE",
              "displayName": "DATE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "NAME_PORTF",
              "displayName": "NAME_PORTF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_assets_count",
              "displayName": "total_assets_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_current_value_rub",
              "displayName": "portfolio_current_value_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_absolute_profit_rub",
              "displayName": "portfolio_absolute_profit_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_gain_percent",
              "displayName": "portfolio_gain_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "average_coupon_yield_percent",
              "displayName": "average_coupon_yield_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_by_current_value_percent",
              "displayName": "portfolio_yield_by_current_value_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_roi_percent",
              "displayName": "portfolio_yield_roi_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_average_percent",
              "displayName": "portfolio_yield_average_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "net_investment_rub",
              "displayName": "net_investment_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_ETF",
              "displayName": "count_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_ETF",
              "displayName": "percent_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_ETF",
              "displayName": "total_value_rub_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_EURObonds",
              "displayName": "count_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_EURObonds",
              "displayName": "percent_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_EURObonds",
              "displayName": "total_value_rub_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_OFZ",
              "displayName": "count_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_OFZ",
              "displayName": "percent_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_OFZ",
              "displayName": "total_value_rub_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_KORPbonds",
              "displayName": "count_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_KORPbonds",
              "displayName": "percent_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_KORPbonds",
              "displayName": "total_value_rub_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_MUNUCbonds",
              "displayName": "count_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_MUNUCbonds",
              "displayName": "percent_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_MUNUCbonds",
              "displayName": "total_value_rub_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "assets_with_default",
              "displayName": "assets_with_default",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "assets_with_technical_default",
              "displayName": "assets_with_technical_default",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4512,
        -3792
      ],
      "id": "a271aa70-44ef-498c-8723-530e78bd1ff9",
      "name": "Insert row ANALIZ_Portfolio1"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "PhI20HSNBd3CJyz4",
          "mode": "list",
          "cachedResultName": "ANALIZ_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/PhI20HSNBd3CJyz4"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "assets_with_technical_default": "={{ $json.assets_with_technical_default.count }}",
            "assets_with_default": "={{ $json.assets_with_default.count }}",
            "total_value_rub_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].total_value_rub_number }}",
            "percent_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].percent_number }}",
            "count_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].count }}",
            "total_value_rub_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].total_value_rub_number }}",
            "percent_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].percent_number }}",
            "count_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].count }}",
            "total_value_rub_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].total_value_rub_number }}",
            "percent_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].percent_number }}",
            "count_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].count }}",
            "total_value_rub_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].total_value_rub_number }}",
            "percent_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].percent_number }}",
            "count_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].count }}",
            "total_value_rub_ETF": "={{ $json.asset_distribution_by_type.ETF.total_value_rub_number }}",
            "percent_ETF": "={{ $json.asset_distribution_by_type.ETF.percent_number }}",
            "count_ETF": "={{ $json.asset_distribution_by_type.ETF.count }}",
            "net_investment_rub": "={{ $json.portfolio_metrics.net_investment_rub_number }}",
            "portfolio_yield_average_percent": "={{ $json.portfolio_metrics.portfolio_yield_average_percent }}",
            "portfolio_yield_roi_percent": "={{ $json.portfolio_metrics.portfolio_yield_roi_percent }}",
            "portfolio_yield_by_current_value_percent": "={{ $json.portfolio_metrics.portfolio_yield_by_current_value_percent }}",
            "average_coupon_yield_percent": "={{ $json.portfolio_metrics.average_coupon_yield_percent }}",
            "portfolio_gain_percent": "={{ $json.portfolio_metrics.portfolio_gain_percent }}",
            "portfolio_absolute_profit_rub": "={{ $json.portfolio_metrics.portfolio_absolute_profit_rub_number }}",
            "portfolio_current_value_rub": "={{ $json.portfolio_metrics.portfolio_current_value_rub_number }}",
            "total_assets_count": "={{ $json.portfolio_metrics.total_assets_count }}",
            "NAME_PORTF": "={{ $json.portfolio_name }}",
            "DATE": "={{ $json.analysis_date }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "DATE",
              "displayName": "DATE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "NAME_PORTF",
              "displayName": "NAME_PORTF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_assets_count",
              "displayName": "total_assets_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_current_value_rub",
              "displayName": "portfolio_current_value_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_absolute_profit_rub",
              "displayName": "portfolio_absolute_profit_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_gain_percent",
              "displayName": "portfolio_gain_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "average_coupon_yield_percent",
              "displayName": "average_coupon_yield_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_by_current_value_percent",
              "displayName": "portfolio_yield_by_current_value_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_roi_percent",
              "displayName": "portfolio_yield_roi_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_average_percent",
              "displayName": "portfolio_yield_average_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "net_investment_rub",
              "displayName": "net_investment_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_ETF",
              "displayName": "count_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_ETF",
              "displayName": "percent_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_ETF",
              "displayName": "total_value_rub_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_EURObonds",
              "displayName": "count_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_EURObonds",
              "displayName": "percent_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_EURObonds",
              "displayName": "total_value_rub_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_OFZ",
              "displayName": "count_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_OFZ",
              "displayName": "percent_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_OFZ",
              "displayName": "total_value_rub_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_KORPbonds",
              "displayName": "count_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_KORPbonds",
              "displayName": "percent_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_KORPbonds",
              "displayName": "total_value_rub_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_MUNUCbonds",
              "displayName": "count_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_MUNUCbonds",
              "displayName": "percent_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_MUNUCbonds",
              "displayName": "total_value_rub_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "assets_with_default",
              "displayName": "assets_with_default",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "assets_with_technical_default",
              "displayName": "assets_with_technical_default",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4528,
        -2000
      ],
      "id": "f98441e1-24fc-42e8-8ef9-abd9f602fd3b",
      "name": "Insert row ANALIZ_Portfolio"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "PhI20HSNBd3CJyz4",
          "mode": "list",
          "cachedResultName": "ANALIZ_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/PhI20HSNBd3CJyz4"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "assets_with_technical_default": "={{ $json.assets_with_technical_default.count }}",
            "assets_with_default": "={{ $json.assets_with_default.count }}",
            "total_value_rub_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].total_value_rub_number }}",
            "percent_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].percent_number }}",
            "count_MUNUCbonds": "={{ $json.asset_distribution_by_type[\"Муниципальная облигация\"].count }}",
            "total_value_rub_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].total_value_rub_number }}",
            "percent_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].percent_number }}",
            "count_KORPbonds": "={{ $json.asset_distribution_by_type[\"Корпоративная облигация\"].count }}",
            "total_value_rub_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].total_value_rub_number }}",
            "percent_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].percent_number }}",
            "count_OFZ": "={{ $json.asset_distribution_by_type[\"ОФЗ\"].count }}",
            "total_value_rub_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].total_value_rub_number }}",
            "percent_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].percent_number }}",
            "count_EURObonds": "={{ $json.asset_distribution_by_type[\"Еврооблигации\"].count }}",
            "total_value_rub_ETF": "={{ $json.asset_distribution_by_type.ETF.total_value_rub_number }}",
            "percent_ETF": "={{ $json.asset_distribution_by_type.ETF.percent_number }}",
            "count_ETF": "={{ $json.asset_distribution_by_type.ETF.count }}",
            "net_investment_rub": "={{ $json.portfolio_metrics.net_investment_rub_number }}",
            "portfolio_yield_average_percent": "={{ $json.portfolio_metrics.portfolio_yield_average_percent }}",
            "portfolio_yield_roi_percent": "={{ $json.portfolio_metrics.portfolio_yield_roi_percent }}",
            "portfolio_yield_by_current_value_percent": "={{ $json.portfolio_metrics.portfolio_yield_by_current_value_percent }}",
            "average_coupon_yield_percent": "={{ $json.portfolio_metrics.average_coupon_yield_percent }}",
            "portfolio_gain_percent": "={{ $json.portfolio_metrics.portfolio_gain_percent }}",
            "portfolio_absolute_profit_rub": "={{ $json.portfolio_metrics.portfolio_absolute_profit_rub_number }}",
            "portfolio_current_value_rub": "={{ $json.portfolio_metrics.portfolio_current_value_rub_number }}",
            "total_assets_count": "={{ $json.portfolio_metrics.total_assets_count }}",
            "NAME_PORTF": "={{ $json.portfolio_name }}",
            "DATE": "={{ $json.analysis_date }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "DATE",
              "displayName": "DATE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "NAME_PORTF",
              "displayName": "NAME_PORTF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_assets_count",
              "displayName": "total_assets_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_current_value_rub",
              "displayName": "portfolio_current_value_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_absolute_profit_rub",
              "displayName": "portfolio_absolute_profit_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_gain_percent",
              "displayName": "portfolio_gain_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "average_coupon_yield_percent",
              "displayName": "average_coupon_yield_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_by_current_value_percent",
              "displayName": "portfolio_yield_by_current_value_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_roi_percent",
              "displayName": "portfolio_yield_roi_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "portfolio_yield_average_percent",
              "displayName": "portfolio_yield_average_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "net_investment_rub",
              "displayName": "net_investment_rub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_ETF",
              "displayName": "count_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_ETF",
              "displayName": "percent_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_ETF",
              "displayName": "total_value_rub_ETF",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_EURObonds",
              "displayName": "count_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_EURObonds",
              "displayName": "percent_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_EURObonds",
              "displayName": "total_value_rub_EURObonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_OFZ",
              "displayName": "count_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_OFZ",
              "displayName": "percent_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_OFZ",
              "displayName": "total_value_rub_OFZ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_KORPbonds",
              "displayName": "count_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_KORPbonds",
              "displayName": "percent_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_KORPbonds",
              "displayName": "total_value_rub_KORPbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "count_MUNUCbonds",
              "displayName": "count_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "percent_MUNUCbonds",
              "displayName": "percent_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_value_rub_MUNUCbonds",
              "displayName": "total_value_rub_MUNUCbonds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "assets_with_default",
              "displayName": "assets_with_default",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "assets_with_technical_default",
              "displayName": "assets_with_technical_default",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4528,
        448
      ],
      "id": "f66f7966-74fa-42a0-9659-ce69b803c2ab",
      "name": "Insert row ANALIZ_Portfolio2"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Скрипт для узла Code в n8n v1.116.2\n// Обработка данных инвестиционных портфелей\n// ОПТИМИЗИРОВАННАЯ ВЕРСИЯ - возвращает 1 item вместо 7\n// ============================================\n\n// ============================================\n// РАЗДЕЛ НАСТРОЕК\n// ============================================\nconst TARGET_ALLOCATION = {\n  \"ETF\": 15,\n  \"Еврооблигации\": 15,\n  \"ОФЗ\": 20,\n  \"Корпоративная облигация\": 35,\n  \"Муниципальная облигация\": 15\n};\n// ============================================\n// ФУНКЦИЯ ДЛЯ ПОЛУЧЕНИЯ ТЕКУЩЕЙ ДАТЫ\n// ============================================\nfunction getCurrentDate() {\n  const today = new Date();\n  const day = String(today.getDate()).padStart(2, '0');\n  const month = String(today.getMonth() + 1).padStart(2, '0');\n  const year = today.getFullYear();\n  return `${day}.${month}.${year}`;\n}\n\nconst currentDate = getCurrentDate();\n// ============================================\n// ПОЛУЧЕНИЕ ВХОДНЫХ ДАННЫХ\n// ============================================\nlet portfolios = [];\nconst allItems = $input.all();\n\nif (Array.isArray(allItems) && allItems.length > 0) {\n  if (allItems[0].json && Array.isArray(allItems[0].json)) {\n    portfolios = allItems[0].json;\n  } \n  else if (allItems[0].json && allItems[0].json.portfolio_name) {\n    portfolios = allItems.map(item => item.json);\n  }\n  else if (allItems[0].portfolio_name) {\n    portfolios = allItems;\n  }\n  else if (typeof allItems[0] === 'string') {\n    try {\n      portfolios = JSON.parse(allItems[0]);\n      if (!Array.isArray(portfolios)) {\n        portfolios = [portfolios];\n      }\n    } catch (e) {\n      throw new Error('Не удалось распарсить входные данные. Проверьте формат данных.');\n    }\n  }\n}\n\nif (!portfolios || portfolios.length === 0) {\n  throw new Error('Входные данные не содержат портфелей. Проверьте подключение предыдущего узла.');\n}\n\n// ============================================\n// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ\n// ============================================\n\nfunction formatNumber(num) {\n  return num.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, \" \").replace('.', ',');\n}\n\nfunction calculateDeviations(portfolio, targetAllocation) {\n  const deviations = {};\n\n  if (!portfolio.asset_distribution_by_type) {\n    return deviations;\n  }\n\n  for (const assetType in targetAllocation) {\n    const targetPercent = targetAllocation[assetType];\n    const currentPercent = portfolio.asset_distribution_by_type[assetType]?.percent_number || 0;\n    const deviation = currentPercent - targetPercent;\n\n    deviations[assetType] = {\n      \"target_percent\": targetPercent,\n      \"current_percent\": currentPercent,\n      \"deviation_percent\": parseFloat(deviation.toFixed(2)),\n      \"deviation_status\": deviation > 0 ? \"выше нормы\" : (deviation < 0 ? \"ниже нормы\" : \"в норме\")\n    };\n  }\n\n  return deviations;\n}\n\n// ============================================\n// ПОИСК ЦЕЛЕВЫХ ПОРТФЕЛЕЙ\n// ============================================\nconst standardPortfolio = portfolios.find(p => p.portfolio_name === \"STANDART\");\nconst iis3Portfolio = portfolios.find(p => p.portfolio_name === \"IIS-3\");\nconst targetPortfolios = [standardPortfolio, iis3Portfolio].filter(p => p !== undefined);\n\n// ============================================\n// РАСЧЕТ ОБОБЩЕННЫХ МЕТРИК (БЛОК ITOG)\n// ============================================\nlet totalAssetsCount = 0;\nlet portfolioCurrentValueSum = 0;\nlet portfolioAbsoluteProfitSum = 0;\nlet portfolioGainPercentSum = 0;\nlet averageCouponYieldPercentSum = 0;\nlet portfolioYieldByCurrentValuePercentSum = 0;\nlet portfolioYieldRoiPercentSum = 0;\nlet portfolioYieldAveragePercentSum = 0;\nlet netInvestmentSum = 0;\nlet targetPortfoliosCount = targetPortfolios.length;\n\ntargetPortfolios.forEach(portfolio => {\n  const metrics = portfolio.portfolio_metrics;\n  totalAssetsCount += metrics.total_assets_count || 0;\n  portfolioCurrentValueSum += metrics.portfolio_current_value_rub_number || 0;\n  portfolioAbsoluteProfitSum += metrics.portfolio_absolute_profit_rub_number || 0;\n  portfolioGainPercentSum += metrics.portfolio_gain_percent || 0;\n  averageCouponYieldPercentSum += metrics.average_coupon_yield_percent || 0;\n  portfolioYieldByCurrentValuePercentSum += metrics.portfolio_yield_by_current_value_percent || 0;\n  portfolioYieldRoiPercentSum += metrics.portfolio_yield_roi_percent || 0;\n  portfolioYieldAveragePercentSum += metrics.portfolio_yield_average_percent || 0;\n  netInvestmentSum += metrics.net_investment_rub_number || 0;\n});\n\nconst itogBlock = {\n  \"portfolio_name\": \"ITOG\",\n  \"analysis_date\": currentDate,\n  \"portfolio_metrics\": {\n    \"total_assets_count\": totalAssetsCount,\n    \"portfolio_current_value_rub\": formatNumber(portfolioCurrentValueSum),\n    \"portfolio_current_value_rub_number\": portfolioCurrentValueSum,\n    \"portfolio_absolute_profit_rub\": formatNumber(portfolioAbsoluteProfitSum),\n    \"portfolio_absolute_profit_rub_number\": portfolioAbsoluteProfitSum,\n    \"portfolio_gain_percent\": targetPortfoliosCount > 0 ? \n      parseFloat((portfolioGainPercentSum / targetPortfoliosCount).toFixed(2)) : 0,\n    \"average_coupon_yield_percent\": targetPortfoliosCount > 0 ? \n      parseFloat((averageCouponYieldPercentSum / targetPortfoliosCount).toFixed(2)) : 0,\n    \"portfolio_yield_by_current_value_percent\": targetPortfoliosCount > 0 ? \n      parseFloat((portfolioYieldByCurrentValuePercentSum / targetPortfoliosCount).toFixed(2)) : 0,\n    \"portfolio_yield_roi_percent\": targetPortfoliosCount > 0 ? \n      parseFloat((portfolioYieldRoiPercentSum / targetPortfoliosCount).toFixed(2)) : 0,\n    \"portfolio_yield_average_percent\": targetPortfoliosCount > 0 ? \n      parseFloat((portfolioYieldAveragePercentSum / targetPortfoliosCount).toFixed(2)) : 0,\n    \"net_investment_rub\": formatNumber(netInvestmentSum),\n    \"net_investment_rub_number\": netInvestmentSum\n  }\n};\n\n// ============================================\n// СОЗДАНИЕ БЛОКОВ ОТКЛОНЕНИЙ\n// ============================================\nconst deviationBlocks = [];\n\nif (standardPortfolio) {\n  deviationBlocks.push({\n    \"portfolio_name\": \"STANDART\",\n    \"analysis_date\": currentDate,\n    \"asset_allocation_analysis\": {\n      \"description\": \"Отклонения от эталонного распределения активов\",\n      \"deviations\": calculateDeviations(standardPortfolio, TARGET_ALLOCATION)\n    }\n  });\n}\n\nif (iis3Portfolio) {\n  deviationBlocks.push({\n    \"portfolio_name\": \"IIS-3\",\n    \"analysis_date\": currentDate,\n    \"asset_allocation_analysis\": {\n      \"description\": \"Отклонения от эталонного распределения активов\",\n      \"deviations\": calculateDeviations(iis3Portfolio, TARGET_ALLOCATION)\n    }\n  });\n}\n\n// ============================================\n// РАСЧЕТ ИТОГОВОЙ СВОДКИ ПО ВСЕМ ПОРТФЕЛЯМ\n// ============================================\nlet totalNetInvestmentAllPortfolios = 0;\nlet totalYieldRoiAllPortfolios = 0;\nlet allPortfoliosCount = portfolios.length;\n\nportfolios.forEach(portfolio => {\n  const metrics = portfolio.portfolio_metrics;\n  totalNetInvestmentAllPortfolios += metrics.net_investment_rub_number || 0;\n  totalYieldRoiAllPortfolios += metrics.portfolio_yield_roi_percent || 0;\n});\n\nconst summaryBlock = {\n  \"summary_all_portfolios\": {\n    \"total_net_investment_rub\": formatNumber(totalNetInvestmentAllPortfolios),\n    \"total_net_investment_rub_number\": totalNetInvestmentAllPortfolios,\n    \"average_portfolio_yield_roi_percent\": allPortfoliosCount > 0 ? \n      parseFloat((totalYieldRoiAllPortfolios / allPortfoliosCount).toFixed(2)) : 0\n  }\n};\n\n// ============================================\n// ФОРМИРОВАНИЕ ВЫХОДНЫХ ДАННЫХ\n// ============================================\n// КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: Вместо возврата 7 items, возвращаем 1 item с массивом данных\nconst outputData = {\n  \"itog_summary\": itogBlock,\n  \"deviations\": deviationBlocks,\n  \"all_portfolios\": portfolios,\n  \"total_summary\": summaryBlock\n};\n\n// Возвращаем ОДИН item вместо массива items\nreturn [{ json: outputData }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6832,
        -1696
      ],
      "id": "82135a32-6ddb-4758-9851-14891f93072a",
      "name": "Final Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        6304,
        -1744
      ],
      "id": "d905ef30-8e1d-40b6-989b-aadb56c434cd",
      "name": "Merge14"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        6560,
        -1696
      ],
      "id": "d4cbbe0d-317e-4ee0-98b9-5dfea3f5a922",
      "name": "Merge15"
    },
    {
      "parameters": {
        "chatId": "7732944652",
        "text": "=📊 Анализ Инвестиционных Портфелей на {{ $json.itog_summary.analysis_date }}\n\n**Общий объем инвестиций:**\n{{ $json.itog_summary.portfolio_metrics.portfolio_current_value_rub }} + {{ $json.all_portfolios[2].portfolio_metrics.portfolio_current_value_rub }} ₽\n\n**Средняя доходность на ВЛОЖЕННЫЕ СРЕДСТВА (ROI):** {{ $json.total_summary.summary_all_portfolios.average_portfolio_yield_roi_percent }}%\n\n- 💰 **Работающие деньги:** {{ $json.itog_summary.portfolio_metrics.net_investment_rub }} ₽\n- 📊 **Количество активов:** {{ $json.itog_summary.portfolio_metrics.total_assets_count }}\n- ✅ **Абсолютная прибыль:** {{ $json.itog_summary.portfolio_metrics.portfolio_absolute_profit_rub }} ₽\n- 💸 **Прирост капитала:** {{ $json.itog_summary.portfolio_metrics.portfolio_gain_percent }}%\n- 🏆 **Доходность (ROI):** {{ $json.itog_summary.portfolio_metrics.portfolio_yield_roi_percent }}%\n- 💵 **Средняя купонная доходность:** {{ $json.itog_summary.portfolio_metrics.average_coupon_yield_percent }}%\n- 📈 **Доходность по текущей стоимости:** {{ $json.itog_summary.portfolio_metrics.portfolio_yield_by_current_value_percent }}%\n-----------------------------------------------------------------\n ⛔️ ДЕФОЛТНЫЕ АКТИВЫ📛 Портфель \"IIS-3\"\n❌ Дефолт\nПортфель \"IIS-3\": {{ $json.all_portfolios[0].assets_with_default.count }} {{ $json.all_portfolios[0].assets_with_default.assets }}\nПортфель \"STANDART\": {{ $json.all_portfolios[1].assets_with_default.count }} {{ $json.all_portfolios[1].assets_with_default.assets }}\n⁉️ Тех.Дефолт\nПортфель \"STANDART\": {{ $json.all_portfolios[1].assets_with_technical_default.count }} {{ $json.all_portfolios[1].assets_with_technical_default.assets }}\nПортфель \"IIS-3\": {{ $json.all_portfolios[0].assets_with_technical_default.count }} {{ $json.all_portfolios[0].assets_with_technical_default.assets }}\n-----------------------------------------------------------------\n🔹🔹🔹 Портфель \"KOPILKA\" 🔹🔹🔹\n  💰 **Текущая стоимость:** {{ $json.all_portfolios[2].portfolio_metrics.portfolio_current_value_rub }} ₽\n  📊 **Количество активов:** {{ $json.all_portfolios[2].portfolio_metrics.total_assets_count }}\n  ✅ **Абсолютная прибыль:** {{ $json.all_portfolios[2].portfolio_metrics.portfolio_absolute_profit_rub }} ₽\n  📉 **Прирост:** {{ $json.all_portfolios[2].portfolio_metrics.portfolio_gain_percent }}%\n  💵 **Средняя купонная доходность:** {{ $json.all_portfolios[2].portfolio_metrics.average_coupon_yield_percent }}%\n\n🧮🧮🧮 Распределение по типам активов:\n1️⃣**ETF**\n♦️ {{ $json.all_portfolios[2].asset_distribution_by_type.ETF.count }} ♦️ {{ $json.all_portfolios[2].asset_distribution_by_type.ETF.percent }} ♦️ {{ $json.all_portfolios[2].asset_distribution_by_type.ETF.total_value_rub }} ₽\n-----------------------------------------------------------------\n  **Котировки валют на дату анализа**\n🇺🇸 USD: {{ $json.all_portfolios[0].exchange_rates_used.USD }} ₽\n🇪🇺 EUR: {{ $json.all_portfolios[0].exchange_rates_used.EUR }} ₽\n🇨🇳 CNY: {{ $json.all_portfolios[0].exchange_rates_used.CNY }} ₽\n-----------------------------------------------------------------",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        7440,
        -1856
      ],
      "id": "9ae876c9-3ccc-46d5-9722-cb9994b6cb4e",
      "name": "Send a text message",
      "webhookId": "b4ee06f5-f1b4-4c9f-8eb1-ab9b8f7854fb",
      "credentials": {
        "telegramApi": {
          "id": "NV6qSdB3UEcUDjxB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "7732944652",
        "text": "=🔹🔹🔹 Портфель \"IIS-3\" 🔹🔹🔹\n  💰 **Текущая стоимость:** {{ $json.all_portfolios[0].portfolio_metrics.portfolio_current_value_rub }} ₽\n  📊 **Количество активов:** {{ $json.all_portfolios[0].portfolio_metrics.total_assets_count }}\n  ✅ **Абсолютная прибыль:** {{ $json.all_portfolios[0].portfolio_metrics.portfolio_absolute_profit_rub }} ₽\n  📉 **Прирост капитала:** {{ $json.all_portfolios[0].portfolio_metrics.portfolio_gain_percent }}%\n  🏆 **Доходность (ROI):** {{ $json.all_portfolios[0].portfolio_metrics.portfolio_yield_roi_percent }}%\n  💵 **Средняя купонная доходность:** {{ $json.all_portfolios[0].portfolio_metrics.average_coupon_yield_percent }}%\n\n🧮🧮🧮 Распределение по типам активов и отклонения от эталонного распределения активов:\n1️⃣**Корпоративные облигации**\n♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Корпоративная облигация'].count }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Корпоративная облигация'].percent }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Корпоративная облигация'].total_value_rub }} ₽ ♦️ \n{{ $json.deviations[1].asset_allocation_analysis.deviations['Корпоративная облигация'].deviation_status }} {{ $json.deviations[1].asset_allocation_analysis.deviations['Корпоративная облигация'].deviation_percent }}%\n2️⃣**Еврооблигации**\n♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Еврооблигации'].count }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Еврооблигации'].percent }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Еврооблигации'].total_value_rub }} ₽ ♦️ \n{{ $json.deviations[1].asset_allocation_analysis.deviations['Еврооблигации'].deviation_status }} {{ $json.deviations[1].asset_allocation_analysis.deviations['Еврооблигации'].deviation_percent }}%\n3️⃣**Муниципальные облигации**\n♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Муниципальная облигация'].count }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Муниципальная облигация'].percent }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['Муниципальная облигация'].total_value_rub }} ₽ ♦️ \n{{ $json.deviations[1].asset_allocation_analysis.deviations['Муниципальная облигация'].deviation_status }} {{ $json.deviations[1].asset_allocation_analysis.deviations['Муниципальная облигация'].deviation_percent }}%\n4️⃣**ОФЗ**\n♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['ОФЗ'].count }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['ОФЗ'].percent }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type['ОФЗ'].total_value_rub }} ₽ ♦️ \n{{ $json.deviations[1].asset_allocation_analysis.deviations['ОФЗ'].deviation_status }} {{ $json.deviations[1].asset_allocation_analysis.deviations['ОФЗ'].deviation_percent }}%\n5️⃣**ETF**\n♦️ {{ $json.all_portfolios[0].asset_distribution_by_type.ETF.count }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type.ETF.percent }} ♦️ {{ $json.all_portfolios[0].asset_distribution_by_type.ETF.total_value_rub }} ₽ ♦️\n{{ $json.deviations[1].asset_allocation_analysis.deviations.ETF.deviation_status }} {{ $json.deviations[1].asset_allocation_analysis.deviations.ETF.deviation_percent }}%\n\n🌟🌟🌟 Топ-5 наиболее прибыльных активов:\n1⃣ **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[0].shortname }}** ({{ $json.all_portfolios[0].top_5_profitable_rub.assets[0].secid }}) — **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[0].yield_percent }}%** \n2⃣ **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[1].shortname }}** ({{ $json.all_portfolios[0].top_5_profitable_rub.assets[1].secid }}) — **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[1].yield_percent }}%**\n3⃣ **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[2].shortname }}** ({{ $json.all_portfolios[0].top_5_profitable_rub.assets[2].secid }}) — **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[2].yield_percent }}%**\n4⃣ **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[3].shortname }}** ({{ $json.all_portfolios[0].top_5_profitable_rub.assets[3].secid }}) — **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[3].yield_percent }}%**\n5⃣ **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[4].shortname }}** ({{ $json.all_portfolios[0].top_5_profitable_rub.assets[4].secid }}) — **{{ $json.all_portfolios[0].top_5_profitable_rub.assets[4].yield_percent }}%**\n\n💹💹💹 Топ-2 прибыльные активы в иностранной валюте:\n1⃣ **{{ $json.all_portfolios[0].top_2_profitable_foreign_currency.assets[0].shortname }}** (Еврооблигация в {{ $json.all_portfolios[0].top_2_profitable_foreign_currency.assets[0].currency }}) — **{{ $json.all_portfolios[0].top_2_profitable_foreign_currency.assets[0].yield_percent }}%**\n2⃣ **{{ $json.all_portfolios[0].top_2_profitable_foreign_currency.assets[1].shortname }}** (Еврооблигация в {{ $json.all_portfolios[0].top_2_profitable_foreign_currency.assets[1].currency }}) — **{{ $json.all_portfolios[0].top_2_profitable_foreign_currency.assets[1].yield_percent }}%**\n\n‼️‼️‼️ Топ-10 НАИМЕНЕЕ прибыльных активов:\n1⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[0].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[0].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[0].yield_percent }}%**\n2⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[1].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[1].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[1].yield_percent }}%**\n3⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[2].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[2].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[2].yield_percent }}%**\n4⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[3].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[3].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[3].yield_percent }}%**\n5⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[4].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[4].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[4].yield_percent }}%**\n6⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[5].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[5].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[5].yield_percent }}%**\n7⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[6].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[6].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[6].yield_percent }}%**\n8⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[7].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[7].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[7].yield_percent }}%**\n9⃣  **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[8].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[8].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[8].yield_percent }}%**\n🔟 **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[9].shortname }}** ({{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[9].secid }}) — **{{ $json.all_portfolios[0].top_10_least_profitable_rub.assets[9].yield_percent }}%**\n\n🧮🧮🧮 НАИМЕНЕЕ прибыльный актив в иностранной валюте:\n1⃣  **{{ $json.all_portfolios[0].top_1_least_profitable_foreign_currency.assets[0].shortname }}** (Еврооблигация в {{ $json.all_portfolios[0].top_1_least_profitable_foreign_currency.assets[0].currency }}) — **{{ $json.all_portfolios[0].top_1_least_profitable_foreign_currency.assets[0].yield_percent }}%**\n-----------------------------------------------------------------",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        7440,
        -1696
      ],
      "id": "b66b9381-64db-434f-953d-39be58e7d29a",
      "name": "Send a text message1",
      "webhookId": "b4ee06f5-f1b4-4c9f-8eb1-ab9b8f7854fb",
      "credentials": {
        "telegramApi": {
          "id": "NV6qSdB3UEcUDjxB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "7732944652",
        "text": "=🔹🔹🔹 Портфель \"STANDART\" 🔹🔹🔹\n  💰 **Текущая стоимость:** {{ $json.all_portfolios[1].portfolio_metrics.portfolio_current_value_rub }} ₽\n  📊 **Количество активов:** {{ $json.all_portfolios[1].portfolio_metrics.total_assets_count }}\n  ✅ **Абсолютная прибыль:** {{ $json.all_portfolios[1].portfolio_metrics.portfolio_absolute_profit_rub }} ₽\n  💸 **Прирост капитала:** {{ $json.all_portfolios[1].portfolio_metrics.portfolio_gain_percent }}%\n  🏆 **Доходность (ROI):** {{ $json.all_portfolios[1].portfolio_metrics.portfolio_yield_roi_percent }}%\n  💵 **Средняя купонная доходность:** {{ $json.all_portfolios[1].portfolio_metrics.average_coupon_yield_percent }}%\n\n🧮🧮🧮 Распределение по типам активов и отклонения от эталонного распределения активов:\n1️⃣**Корпоративные облигации**\n♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Корпоративная облигация'].count }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Корпоративная облигация'].percent }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Корпоративная облигация'].total_value_rub }} ₽ ♦️ \n{{ $json.deviations[0].asset_allocation_analysis.deviations['Корпоративная облигация'].deviation_status }} {{ $json.deviations[0].asset_allocation_analysis.deviations['Корпоративная облигация'].deviation_percent }}%\n2️⃣**Еврооблигации**\n♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Еврооблигации'].count }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Еврооблигации'].percent }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Еврооблигации'].total_value_rub }} ₽ ♦️ \n{{ $json.deviations[0].asset_allocation_analysis.deviations['Еврооблигации'].deviation_status }} {{ $json.deviations[0].asset_allocation_analysis.deviations['Еврооблигации'].deviation_percent }}%\n3️⃣**Муниципальные облигации**\n♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Муниципальная облигация'].count }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Муниципальная облигация'].percent }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['Муниципальная облигация'].total_value_rub }} ₽ ♦️ \n{{ $json.deviations[0].asset_allocation_analysis.deviations['Муниципальная облигация'].deviation_status }} {{ $json.deviations[0].asset_allocation_analysis.deviations['Муниципальная облигация'].deviation_percent }}%\n4️⃣**ОФЗ**\n♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['ОФЗ'].count }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['ОФЗ'].percent }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type['ОФЗ'].total_value_rub }} ₽ ♦️ \n{{ $json.deviations[0].asset_allocation_analysis.deviations['ОФЗ'].deviation_status }} {{ $json.deviations[0].asset_allocation_analysis.deviations['ОФЗ'].deviation_percent }}%\n5️⃣**ETF**\n♦️ {{ $json.all_portfolios[1].asset_distribution_by_type.ETF.count }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type.ETF.percent }} ♦️ {{ $json.all_portfolios[1].asset_distribution_by_type.ETF.total_value_rub }} ₽ ♦️ \n{{ $json.deviations[0].asset_allocation_analysis.deviations.ETF.deviation_status }} {{ $json.deviations[0].asset_allocation_analysis.deviations.ETF.deviation_percent }}%\n\n🌟🌟🌟 Топ-5 наиболее прибыльных активов:\n1⃣ **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[0].shortname }}** ({{ $json.all_portfolios[1].top_5_profitable_rub.assets[0].secid }}) — **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[0].yield_percent }}%** \n2⃣ **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[1].shortname }}** ({{ $json.all_portfolios[1].top_5_profitable_rub.assets[1].secid }}) — **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[1].yield_percent }}%**\n3⃣ **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[2].shortname }}** ({{ $json.all_portfolios[1].top_5_profitable_rub.assets[2].secid }}) — **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[2].yield_percent }}%**\n4⃣ **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[3].shortname }}** ({{ $json.all_portfolios[1].top_5_profitable_rub.assets[3].secid }}) — **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[3].yield_percent }}%**\n5⃣ **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[4].shortname }}** ({{ $json.all_portfolios[1].top_5_profitable_rub.assets[4].secid }}) — **{{ $json.all_portfolios[1].top_5_profitable_rub.assets[4].yield_percent }}%**\n\n💹💹💹 Топ-2 прибыльные активы в иностранной валюте:\n1. **{{ $json.all_portfolios[1].top_2_profitable_foreign_currency.assets[0].shortname }}** (Еврооблигация в {{ $json.all_portfolios[1].top_2_profitable_foreign_currency.assets[0].currency }}) — **{{ $json.all_portfolios[1].top_2_profitable_foreign_currency.assets[0].yield_percent }}%**\n2. **{{ $json.all_portfolios[1].top_2_profitable_foreign_currency.assets[1].shortname }}** (Еврооблигация в {{ $json.all_portfolios[1].top_2_profitable_foreign_currency.assets[1].currency }}) — **{{ $json.all_portfolios[1].top_2_profitable_foreign_currency.assets[1].yield_percent }}%**\n\n‼️‼️‼️ Топ-10 НАИМЕНЕЕ прибыльных активов:\n1⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[0].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[0].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[0].yield_percent }}%**\n2⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[1].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[1].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[1].yield_percent }}%**\n3⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[2].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[2].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[2].yield_percent }}%**\n4⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[3].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[3].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[3].yield_percent }}%**\n5⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[4].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[4].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[4].yield_percent }}%**\n6⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[5].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[5].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[5].yield_percent }}%**\n7⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[6].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[6].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[6].yield_percent }}%**\n8⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[7].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[7].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[7].yield_percent }}%**\n9⃣  **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[8].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[8].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[8].yield_percent }}%**\n🔟 **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[9].shortname }}** ({{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[9].secid }}) — **{{ $json.all_portfolios[1].top_10_least_profitable_rub.assets[9].yield_percent }}%**\n\n🧮🧮🧮 НАИМЕНЕЕ прибыльный актив в иностранной валюте:\n1⃣  **{{ $json.all_portfolios[1].top_1_least_profitable_foreign_currency.assets[0].shortname }}** (Еврооблигация в {{ $json.all_portfolios[1].top_1_least_profitable_foreign_currency.assets[0].currency }}) — **{{ $json.all_portfolios[1].top_1_least_profitable_foreign_currency.assets[0].yield_percent }}%**\n",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        7440,
        -1536
      ],
      "id": "6aff4ff0-7311-4db2-80ad-79d75f7ed274",
      "name": "Send a text message2",
      "webhookId": "b4ee06f5-f1b4-4c9f-8eb1-ab9b8f7854fb",
      "credentials": {
        "telegramApi": {
          "id": "NV6qSdB3UEcUDjxB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteRows",
        "dataTableId": {
          "__rl": true,
          "value": "PhI20HSNBd3CJyz4",
          "mode": "list",
          "cachedResultName": "ANALIZ_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/PhI20HSNBd3CJyz4"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "DATE",
              "keyValue": "={{ $json.analysis_date }}"
            },
            {
              "keyName": "NAME_PORTF",
              "keyValue": "={{ $json.portfolio_name }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4624,
        256
      ],
      "id": "fb64190a-5c9b-4d00-90d9-60e887d9056a",
      "name": "Delete row(s)2"
    },
    {
      "parameters": {
        "operation": "deleteRows",
        "dataTableId": {
          "__rl": true,
          "value": "PhI20HSNBd3CJyz4",
          "mode": "list",
          "cachedResultName": "ANALIZ_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/PhI20HSNBd3CJyz4"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "DATE",
              "keyValue": "={{ $json.analysis_date }}"
            },
            {
              "keyName": "NAME_PORTF",
              "keyValue": "={{ $json.portfolio_name }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4528,
        -2240
      ],
      "id": "8c613b57-c823-407a-9139-837931ccc6b3",
      "name": "Delete row(s)3"
    },
    {
      "parameters": {
        "operation": "deleteRows",
        "dataTableId": {
          "__rl": true,
          "value": "PhI20HSNBd3CJyz4",
          "mode": "list",
          "cachedResultName": "ANALIZ_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/PhI20HSNBd3CJyz4"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "DATE",
              "keyValue": "={{ $json.analysis_date }}"
            },
            {
              "keyName": "NAME_PORTF",
              "keyValue": "={{ $json.portfolio_name }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4512,
        -3984
      ],
      "id": "d62d6495-1242-437e-9f5c-a9fb71ab68b0",
      "name": "Delete row(s)4"
    }
  ],
  "pinData": {},
  "connections": {
    "STANDART-Get rows": {
      "main": [
        [
          {
            "node": "Calc: Invested Amount1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Calc: Portfolio Composition",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calc: Portfolio Composition": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Replace Me",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch MOEX Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Board": {
      "main": [
        [
          {
            "node": "Parse Boards",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Boards": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find Board",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Replace Me3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch MOEX Data1": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Board1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items2": {
      "main": [
        [
          {
            "node": "Replace Me1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find Board1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Replace Me20",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Currency Rates from MOEX": {
      "main": [
        [
          {
            "node": "Code Kurs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code Kurs": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code_SECID&market": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SecID → Security Info1": {
      "main": [
        [
          {
            "node": "Code_SECID&market",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [
          {
            "node": "Insert row SECID_Portfolio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SecID → Security Info1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Replace Me1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calc: Invested Amount1": {
      "main": [
        [
          {
            "node": "Replace Me2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me2": {
      "main": [
        [
          {
            "node": "Replace Me4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me4": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me5": {
      "main": [
        [
          {
            "node": "STANDART-Get rows",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Currency Rates from MOEX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Replace Me5",
            "type": "main",
            "index": 0
          },
          {
            "node": "Replace Me11",
            "type": "main",
            "index": 0
          },
          {
            "node": "Replace Me17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge12": {
      "main": [
        [
          {
            "node": "Merge13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me18": {
      "main": [
        [
          {
            "node": "Merge12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me19": {
      "main": [
        [
          {
            "node": "Merge12",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Replace Me20": {
      "main": [
        [
          {
            "node": "Merge13",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge13": {
      "main": [
        [
          {
            "node": "Unik_SCEID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unik_SCEID": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calc: Invested Amount": {
      "main": [
        [
          {
            "node": "Replace Me8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STANDART-Get rows1": {
      "main": [
        [
          {
            "node": "Calc: Invested Amount",
            "type": "main",
            "index": 0
          },
          {
            "node": "Calc: Portfolio Composition1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calc: Portfolio Composition1": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge5",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Loop Over Items4": {
      "main": [
        [
          {
            "node": "Replace Me6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch MOEX Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Board2": {
      "main": [
        [
          {
            "node": "Parse Boards1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Boards1": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Replace Me9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items5": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find Board2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch MOEX Data": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Board3": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript4": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items6": {
      "main": [
        [
          {
            "node": "Replace Me7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find Board3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge5": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 0
          },
          {
            "node": "Replace Me19",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Currency Rates from MOEX1": {
      "main": [
        [
          {
            "node": "Code Kurs1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge6": {
      "main": [
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code Kurs1": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Replace Me6": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Replace Me7": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me8": {
      "main": [
        [
          {
            "node": "Replace Me10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge7": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me10": {
      "main": [
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me11": {
      "main": [
        [
          {
            "node": "STANDART-Get rows1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Currency Rates from MOEX1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calc: Invested Amount2": {
      "main": [
        [
          {
            "node": "Replace Me14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STANDART-Get rows2": {
      "main": [
        [
          {
            "node": "Calc: Invested Amount2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Calc: Portfolio Composition2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calc: Portfolio Composition2": {
      "main": [
        [
          {
            "node": "Loop Over Items8",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge9",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Loop Over Items7": {
      "main": [
        [
          {
            "node": "Replace Me12",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch MOEX Data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Board4": {
      "main": [
        [
          {
            "node": "Parse Boards2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Boards2": {
      "main": [
        [
          {
            "node": "Loop Over Items8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Loop Over Items7",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Items9",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Replace Me15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items8": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find Board4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript6": {
      "main": [
        [
          {
            "node": "Loop Over Items7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch MOEX Data2": {
      "main": [
        [
          {
            "node": "Code in JavaScript6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Board5": {
      "main": [
        [
          {
            "node": "Code in JavaScript7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript7": {
      "main": [
        [
          {
            "node": "Loop Over Items9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items9": {
      "main": [
        [
          {
            "node": "Replace Me13",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find Board5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge8": {
      "main": [
        [
          {
            "node": "Merge9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge9": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 0
          },
          {
            "node": "Replace Me18",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Currency Rates from MOEX2": {
      "main": [
        [
          {
            "node": "Code Kurs2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge10": {
      "main": [
        [
          {
            "node": "Merge11",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code Kurs2": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Replace Me12": {
      "main": [
        [
          {
            "node": "Merge8",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Replace Me13": {
      "main": [
        [
          {
            "node": "Merge8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me14": {
      "main": [
        [
          {
            "node": "Replace Me16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge11": {
      "main": [
        [
          {
            "node": "Code in JavaScript8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me16": {
      "main": [
        [
          {
            "node": "Merge11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me17": {
      "main": [
        [
          {
            "node": "STANDART-Get rows2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Currency Rates from MOEX2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript8": {
      "main": [
        [
          {
            "node": "Insert row ANALIZ_Portfolio1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge14",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete row(s)4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "Insert row ANALIZ_Portfolio",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge14",
            "type": "main",
            "index": 1
          },
          {
            "node": "Delete row(s)3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Insert row ANALIZ_Portfolio2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge15",
            "type": "main",
            "index": 1
          },
          {
            "node": "Delete row(s)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge14": {
      "main": [
        [
          {
            "node": "Merge15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge15": {
      "main": [
        [
          {
            "node": "Final Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Final Code": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a text message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message2": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c1703a85-a70f-4270-b29e-badf358346d6",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d166ce8727f20d161e3bd52d65ba171c04dab9070977d2e6555d1cb327e0c832"
  },
  "id": "R8Qf8BO5NQQCCyhQ",
  "tags": []
}