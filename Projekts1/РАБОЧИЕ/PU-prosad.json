{
  "name": "PU-prosad",
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "00 20 * * 1-5"
            }
          ]
        }
      },
      "id": "798188be-56e5-435b-aaac-449c06474d5d",
      "name": "Cron",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        -2624,
        528
      ]
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2064,
        528
      ],
      "id": "254072ae-47ac-47c6-bdfb-0c7ac8865454",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "jsCode": "const out = [];\n\nfor (const item of items) {\n  try {\n    console.log(`=== –û–ë–†–ê–ë–û–¢–ö–ê SECID: ${item.json.SECID || '–ù–ï –ù–ê–ô–î–ï–ù'} ===`);\n    \n    const securities = item.json.securities;\n    if (!securities || !securities.data || !securities.data.length) {\n      console.log(`‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${item.json.SECID}`);\n      continue;\n    }\n\n    // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ SECID (–º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ö–æ–∂–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)\n    let targetData = null;\n    const columns = securities.columns;\n    const secidIndex = columns.indexOf(\"secid\");\n    \n    if (secidIndex !== -1) {\n      targetData = securities.data.find(row => row[secidIndex] === item.json.SECID);\n    }\n    \n    // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n    if (!targetData) {\n      targetData = securities.data[0];\n      console.log(`‚ö†Ô∏è –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è ${item.json.SECID}, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç`);\n    }\n\n    const boardIndex = columns.indexOf(\"marketprice_boardid\");\n    const nameIndex = columns.indexOf(\"name\");  \n    const typeIndex = columns.indexOf(\"type\");\n    const marketIndex = columns.indexOf(\"market\");\n\n    const secid = targetData[secidIndex];\n    const boardid = targetData[boardIndex];\n    const name = targetData[nameIndex] || secid;\n    const type = targetData[typeIndex] || '';\n    const market = targetData[marketIndex] || '';\n\n    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π market –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏\n    let instrumentType = '–û–±–ª–∏–≥–∞—Ü–∏—è';\n    let historyMarket = 'bonds'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±–ª–∏–≥–∞—Ü–∏–π\n    \n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ñ–æ–Ω–¥–æ–º/ETF\n    if (secid === 'TPAY' || secid === 'SPAY' || \n        type.includes('fund') || type.includes('etf') || \n        market === 'shares') {\n      instrumentType = '–§–æ–Ω–¥/ETF';\n      historyMarket = 'shares';\n    }\n\n    console.log(`‚úÖ ${secid} (${instrumentType}) - ${name} | market: ${historyMarket} | board: ${boardid}`);\n\n    out.push({\n      json: {\n        SECID: secid,\n        BOARDID: boardid,\n        INSTRUMENT_TYPE: instrumentType,\n        NAME: name,\n        HISTORY_MARKET: historyMarket // –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ MOEX History\n      }\n    });\n\n  } catch (e) {\n    console.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${item.json?.SECID}:`, e.message);\n  }\n}\n\nconsole.log(`=== –ò–¢–û–ì–û –û–ë–†–ê–ë–û–¢–ê–ù–û: ${out.length} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ ===`);\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        576
      ],
      "id": "da49d642-85ee-4673-9461-2b99e58d1289",
      "name": "Code_SECID&market"
    },
    {
      "parameters": {
        "jsCode": "const out = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  \n  try {\n    const history = item.json.history;\n    \n    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å SECID –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n    let secid = 'UNKNOWN';\n    let name = 'UNKNOWN';\n    \n    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)\n    if (history && history.data && history.data.length > 0) {\n      const cols = history.columns || [];\n      const firstRow = history.data[0] || [];\n      \n      const secidIdx = cols.indexOf(\"SECID\");\n      const shortnameIdx = cols.indexOf(\"SHORTNAME\");\n      const nameIdx = cols.indexOf(\"NAME\");\n      const titleIdx = shortnameIdx !== -1 ? shortnameIdx : (nameIdx !== -1 ? nameIdx : 2);\n      \n      if (secidIdx !== -1 && firstRow[secidIdx]) {\n        secid = firstRow[secidIdx];\n      }\n      if (titleIdx !== -1 && firstRow[titleIdx] && firstRow[titleIdx] !== secid) {\n        name = firstRow[titleIdx];\n      }\n    }\n    \n    // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏, –ø—Ä–æ–±—É–µ–º –∏–∑ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π –æ—Ç–≤–µ—Ç–∞\n    if (secid === 'UNKNOWN') {\n      secid = item.json.SECID || item.json.secid || 'UNKNOWN';\n    }\n    if (name === 'UNKNOWN' || name === secid) {\n      name = item.json.NAME || item.json.name || secid;\n    }\n    \n    console.log(`=== –û–ë–†–ê–ë–û–¢–ö–ê: ${secid} (${name}) ===`);\n    \n    if (!history || !history.data || history.data.length === 0) {\n      console.log(`‚ùå –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è ${secid}`);\n      \n      out.push({\n        json: {\n          SECID: secid,\n          NAME: name,\n          WARNING: \"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ—Ä–≥–æ–≤\",\n          DIFF: 0\n        }\n      });\n      continue;\n    }\n\n    const cols = history.columns;\n    const data = history.data;\n    \n    console.log(\"Columns:\", cols);\n    console.log(`Rows count: ${data.length}`);\n    \n    const closeIdx = cols.indexOf(\"CLOSE\");\n    const dateIdx = cols.indexOf(\"TRADEDATE\");\n    const secidIdx = cols.indexOf(\"SECID\");\n    const shortnameIdx = cols.indexOf(\"SHORTNAME\");\n    const nameIdx = cols.indexOf(\"NAME\");\n    \n    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç SHORTNAME, –ø–æ—Ç–æ–º NAME)\n    const titleIdx = shortnameIdx !== -1 ? shortnameIdx : (nameIdx !== -1 ? nameIdx : 2);\n\n    if (closeIdx === -1) {\n      console.log(`‚ùå –ù–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ CLOSE –¥–ª—è ${secid}`);\n      \n      out.push({\n        json: {\n          SECID: secid,\n          NAME: name,\n          WARNING: \"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∞ CLOSE –≤ –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–∏\",\n          DIFF: 0\n        }\n      });\n      continue;\n    }\n\n    // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ —Ü–µ–Ω—ã\n    const validRows = data.filter(row => {\n      const price = row[closeIdx];\n      return price !== null && price !== undefined && price > 0 && !isNaN(parseFloat(price));\n    });\n\n    if (validRows.length < 2) {\n      console.log(`‚ùå –ú–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${secid}: ${validRows.length} –≤–∞–ª–∏–¥–Ω—ã—Ö –∏–∑ ${data.length} —Å—Ç—Ä–æ–∫`);\n      \n      out.push({\n        json: {\n          SECID: secid,\n          NAME: name,\n          WARNING: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π —Å —Ü–µ–Ω–∞–º–∏ (${validRows.length} –∏–∑ ${data.length})`,\n          DIFF: 0\n        }\n      });\n      continue;\n    }\n\n    const todayRow = validRows[0];\n    const yesterdayRow = validRows[1];\n    \n    const today = parseFloat(todayRow[closeIdx]);\n    const yesterday = parseFloat(yesterdayRow[closeIdx]);\n    \n    if (isNaN(today) || isNaN(yesterday) || yesterday === 0) {\n      console.log(`‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è ${secid}: today=${today}, yesterday=${yesterday}`);\n      \n      out.push({\n        json: {\n          SECID: secid,\n          NAME: name,\n          WARNING: `–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ü–µ–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è (—Å–µ–≥–æ–¥–Ω—è: ${today}, –≤—á–µ—Ä–∞: ${yesterday})`,\n          DIFF: 0\n        }\n      });\n      continue;\n    }\n    \n    const diff = ((today - yesterday) / yesterday) * 100;\n    \n    // –û–±–Ω–æ–≤–ª—è–µ–º SECID –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–∏\n    const actualSecid = todayRow[secidIdx] || secid;\n    const actualName = todayRow[titleIdx] || name;\n    \n    console.log(`‚úÖ ${actualSecid} (${actualName}): ${yesterday} ‚Üí ${today} = ${diff.toFixed(2)}%`);\n\n    out.push({\n      json: {\n        SECID: actualSecid,\n        NAME: actualName,\n        DATE_TODAY: todayRow[dateIdx],\n        DATE_YESTERDAY: yesterdayRow[dateIdx],\n        CLOSE_TODAY: today,\n        CLOSE_YESTERDAY: yesterday,\n        DIFF: Number(diff.toFixed(2))\n      }\n    });\n\n  } catch (e) {\n    console.log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:`, e.message);\n    console.log(\"Stack trace:\", e.stack);\n    \n    // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Ö–æ—Ç—å –∫–∞–∫—É—é-—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ\n    let errorSecid = 'ERROR';\n    let errorName = 'ERROR';\n    \n    try {\n      if (item && item.json) {\n        errorSecid = item.json.SECID || item.json.secid || 'ERROR';\n        errorName = item.json.NAME || item.json.name || errorSecid;\n        \n        // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å\n        if (item.json.history && item.json.history.data && item.json.history.data.length > 0) {\n          const cols = item.json.history.columns || [];\n          const firstRow = item.json.history.data[0] || [];\n          const secidIdx = cols.indexOf(\"SECID\");\n          const shortnameIdx = cols.indexOf(\"SHORTNAME\");\n          const nameIdx = cols.indexOf(\"NAME\");\n          \n          if (secidIdx !== -1 && firstRow[secidIdx]) {\n            errorSecid = firstRow[secidIdx];\n          }\n          if (shortnameIdx !== -1 && firstRow[shortnameIdx]) {\n            errorName = firstRow[shortnameIdx];\n          } else if (nameIdx !== -1 && firstRow[nameIdx]) {\n            errorName = firstRow[nameIdx];\n          }\n        }\n      }\n    } catch (ex) {\n      console.log(\"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ:\", ex.message);\n    }\n    \n    out.push({\n      json: {\n        SECID: errorSecid,\n        NAME: errorName,\n        ERROR: `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${e.message}`,\n        DIFF: 0\n      }\n    });\n  }\n}\n\nconsole.log(`=== –û–ë–†–ê–ë–û–¢–ê–ù–û: ${out.length} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ ===`);\nconsole.log(`–£—Å–ø–µ—à–Ω—ã—Ö: ${out.filter(x => x.json.DIFF !== 0 || (!x.json.WARNING && !x.json.ERROR)).length}`);\nconsole.log(`–° –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏: ${out.filter(x => x.json.WARNING).length}`);\nconsole.log(`–° –æ—à–∏–±–∫–∞–º–∏: ${out.filter(x => x.json.ERROR).length}`);\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        448
      ],
      "id": "3f2e507a-26d7-4884-af65-8c17bf221201",
      "name": "Procent",
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/history/engines/stock/markets/{{ $json.HISTORY_MARKET }}/securities/{{ $json.SECID }}.json",
        "options": {},
        "queryParametersUi": {
          "parameter": [
            {
              "name": "iss.only",
              "value": "history"
            },
            {
              "name": "limit",
              "value": "5"
            },
            {
              "name": "sort_order",
              "value": "desc"
            }
          ]
        }
      },
      "id": "356eefd9-5b99-4397-8200-d25627631077",
      "name": "MOEX History",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -1680,
        448
      ]
    },
    {
      "parameters": {
        "jsCode": "const threshold = -5;  // –ø–æ—Ä–æ–≥ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö\nconst all = $input.all();\n\nif (!all || all.length === 0) {\n  return [\n    {\n      json: {\n        count: 0,\n        messageDrops: null,\n        messageNone: \"‚úÖ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\",\n        summary: \"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: 0\"\n      }\n    }\n  ];\n}\n\nconst drops = [];\nconst warnings = [];\nconst errors = [];\nconst processed = all.length;\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –¥–ª–∏–Ω–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è\nfunction getShortName(fullName, secid) {\n  if (!fullName || fullName === secid) {\n    return null;\n  }\n  \n  let shortName = fullName\n    .replace(/^(–ü–ê–û |–ê–û |–û–û–û |–ë–ü–ò–§ |ETF |–§–æ–Ω–¥ )/gi, '')\n    .replace(/( –æ–±–ª–∏–≥–∞—Ü–∏–∏?| –±–æ–Ω–¥| bond| —Å–µ—Ä–∏—è .+| –≤—ã–ø—É—Å–∫ .+| –ë–û-.+)$/gi, '')\n    .replace(/(\\d{2}-\\d{2}|\\d{4})$/, '')\n    .trim();\n  \n  // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 3 —Å–ª–æ–≤–∞\n  const words = shortName.split(' ');\n  if (words.length > 3) {\n    shortName = words.slice(0, 3).join(' ');\n  }\n  \n  // –ú–∞–∫—Å–∏–º—É–º 30 —Å–∏–º–≤–æ–ª–æ–≤\n  if (shortName.length > 30) {\n    shortName = shortName.substring(0, 30) + '...';\n  }\n  \n  return shortName;\n}\n\nfor (const item of all) {\n  const j = item.json;\n  const diff = parseFloat(j.DIFF);\n  const secid = j.SECID || 'UNKNOWN';\n  const fullName = j.NAME || secid;\n  const shortName = getShortName(fullName, secid);\n  \n  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ\n  const instrumentInfo = fullName !== secid && fullName !== 'UNKNOWN' ? \n    `${secid} (${shortName || fullName})` : secid;\n  \n  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏\n  if (j.WARNING) {\n    warnings.push(`${instrumentInfo}: ${j.WARNING}`);\n    continue;\n  }\n  \n  if (j.ERROR) {\n    errors.push(`${instrumentInfo}: ${j.ERROR}`);\n    continue;\n  }\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å–∞–¥–∫–∏\n  if (!isNaN(diff) && diff <= threshold) {\n    drops.push({ \n      secid, \n      diff: diff.toFixed(2), \n      shortName: shortName,\n      fullName: fullName,\n      closeToday: j.CLOSE_TODAY,\n      closeYesterday: j.CLOSE_YESTERDAY\n    });\n  }\n}\n\nlet message = '';\nlet summaryInfo = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: ${processed}`;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Å–∞–¥–∫–∞—Ö\nif (drops.length > 0) {\n  const dropParts = drops.map(d => {\n    // –§–æ—Ä–º–∞—Ç: SECID –Ω–∞–∑–≤–∞–Ω–∏–µ -X.XX%\n    const nameStr = d.shortName ? ` ${d.shortName}` : '';\n    return `${d.secid}${nameStr} ${d.diff}%`;\n  });\n  \n  message = `üìâ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ—Å–∞–¥–∫–∏ ‚â• ${Math.abs(threshold)}%:\\n${dropParts.join('\\n')}`;\n  summaryInfo += `, –ø—Ä–æ—Å–∞–¥–æ–∫: ${drops.length}`;\n} else {\n  message = `‚úÖ –ü—Ä–æ—Å–∞–¥–æ–∫ ‚â• ${Math.abs(threshold)}% –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ`;\n}\n\n// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è—Ö —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤\nif (warnings.length > 0) {\n  message += `\\n\\n‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (${warnings.length}):\\n${warnings.slice(0, 3).join('\\n')}`;\n  if (warnings.length > 3) {\n    message += `\\n... –∏ –µ—â–µ ${warnings.length - 3}`;\n  }\n  summaryInfo += `, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: ${warnings.length}`;\n}\n\n// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤\nif (errors.length > 0) {\n  message += `\\n\\n‚ùå –û—à–∏–±–∫–∏ (${errors.length}):\\n${errors.slice(0, 2).join('\\n')}`;\n  if (errors.length > 2) {\n    message += `\\n... –∏ –µ—â–µ ${errors.length - 2}`;\n  }\n  summaryInfo += `, –æ—à–∏–±–æ–∫: ${errors.length}`;\n}\n\nconsole.log(\"=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê ===\");\nconsole.log(`–ü—Ä–æ—Å–∞–¥–æ–∫: ${drops.length}`);\nconsole.log(`–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: ${warnings.length}`);\nconsole.log(`–û—à–∏–±–æ–∫: ${errors.length}`);\n\nreturn [\n  {\n    json: {\n      count: drops.length,\n      messageDrops: drops.length > 0 ? message : null,\n      messageNone: drops.length === 0 ? message : null,\n      summary: summaryInfo,\n      warningsCount: warnings.length,\n      errorsCount: errors.length,\n      processedCount: processed,\n      dropsData: drops\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1184,
        448
      ],
      "id": "add37969-c893-499a-949b-9e6d382610b3",
      "name": "Aggregate Drops1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "14ee6f21-1861-4736-b483-322f286b152b",
              "leftValue": "={{$json[\"count\"]}}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -960,
        448
      ],
      "id": "ba1746c2-a7a5-4bdf-b7d7-108b173ab808",
      "name": "Any Drops?"
    },
    {
      "parameters": {
        "chatId": "7732944652",
        "text": "={{ $json.messageNone }}\n\nüìä {{ $json.summary }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -528,
        624
      ],
      "id": "f73ec3c1-ff85-475b-bd47-1247cd1a456f",
      "name": "No_5%",
      "webhookId": "7ded956d-a1d8-4862-a645-179161537447",
      "credentials": {
        "telegramApi": {
          "id": "NV6qSdB3UEcUDjxB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "7732944652",
        "text": "={{ $json.messageDrops }}\n\nüìä {{ $json.summary }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -544,
        240
      ],
      "id": "d418168d-4d94-47e7-8d76-d1ec1193bba3",
      "name": "Yes_5%",
      "webhookId": "d685361e-4d84-4b54-b7b9-226a5502afc0",
      "credentials": {
        "telegramApi": {
          "id": "NV6qSdB3UEcUDjxB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities.json?iss.only=securities,boards,description",
        "allowUnauthorizedCerts": true,
        "options": {},
        "queryParametersUi": {
          "parameter": [
            {
              "name": "q",
              "value": "={{ $json.SCEID }}"
            },
            {
              "name": "iss.meta",
              "value": "off"
            }
          ]
        }
      },
      "id": "478d3e57-4750-4a9f-b196-c878062f0372",
      "name": "SecID ‚Üí Security Info1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -1680,
        576
      ],
      "retryOnFail": false
    },
    {
      "parameters": {
        "fieldToSplitOut": "dropsData",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -560,
        -112
      ],
      "id": "214ac9c2-585c-41bf-9f50-fa1a254cb709",
      "name": "Split Out"
    },
    {
      "parameters": {
        "url": "=https://iss.moex.com/iss/securities.json?q={{ $json.secid }}&iss.only=securities",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -352,
        -112
      ],
      "id": "b339aa9f-bd0b-4c17-ba58-603725b9b8f1",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "const out = [];\n\nfor (const item of items) {\n  try {\n    const sec = item.json.securities;\n    if (!sec || !sec.data || !sec.data.length) continue;\n\n    const cols = sec.columns;\n    const data = sec.data[0];\n\n    const res = {\n      secid: data[cols.indexOf(\"secid\")],\n      emitent_title: data[cols.indexOf(\"emitent_title\")],\n      emitent_inn: data[cols.indexOf(\"emitent_inn\")],\n    };\n\n    out.push({ json: res });\n  } catch (e) {\n    out.push({ json: { error: e.message } });\n  }\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        -112
      ],
      "id": "bea16830-e6b7-4abe-bffb-17789fb7082f",
      "name": "Emitent Info"
    },
    {
      "parameters": {
        "chatId": "7732944652",
        "text": "={{ $json.choices[0].message.content }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        400,
        -112
      ],
      "id": "76522d07-a0d8-4535-8c06-cae58cf97890",
      "name": "Send a text message",
      "webhookId": "1d28b9e9-4014-4132-a712-91bf3004e16b",
      "credentials": {
        "telegramApi": {
          "id": "NV6qSdB3UEcUDjxB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "messages": {
          "message": [
            {
              "content": "=–ù–∞–π–¥–∏ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–Ω–µ–Ω–∏—è –∏ –æ—Ç–∑—ã–≤—ã –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏ —ç–º–∏—Ç–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–∞ {{ $('Emitent Info').item.json.secid }} –∏ –æ —Å–∞–º–æ–º –≤—ã–ø—É—Å–∫–µ –æ–±–ª–∏–≥–∞—Ü–∏–π, –∏—Å–ø–æ–ª—å–∑—É—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ –Ω–æ–≤–æ—Å—Ç–∏, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–∑–æ—Ä—ã, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã –∏ —Ñ–æ—Ä—É–º—ã –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤, —á—Ç–æ –±—ã –¥–∞—Ç—å –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –æ—Ü–µ–Ω–∫—É –µ–≥–æ –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞, —Ä–µ–ø—É—Ç–∞—Ü–∏–∏, —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤ —ç—Ç–æ–≥–æ –≤—ã–ø—É—Å–∫–∞.\n–∫–æ–Ω–µ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤—å –≤ –≤–∏–¥–µ —É–¥–æ–±–Ω–æ–º –¥–ª—è –ø–æ—Å—Ç–∞ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ Telegram. –í —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑—ã–≤–∞–π —Å–Ω–æ—Å–∫–∏ –Ω–∞ –Ω–æ–º–µ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."
            }
          ]
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.perplexity",
      "typeVersion": 1,
      "position": [
        112,
        -112
      ],
      "id": "55401105-5ec4-476f-9f1f-7b633b353c7c",
      "name": "Message a model",
      "credentials": {
        "perplexityApi": {
          "id": "NImkfKb8e3xH7xYl",
          "name": "Perplexity account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "wrAvyTKEv5CPA0RM",
          "mode": "list",
          "cachedResultName": "SCEID_PORTFOLIO",
          "cachedResultUrl": "/projects/Q8U5Lyg2aQMd2T9K/datatables/wrAvyTKEv5CPA0RM"
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -2368,
        528
      ],
      "id": "fc5982f4-6cf6-4c7f-bb80-a908cf9dd6e9",
      "name": "Get row(s)"
    }
  ],
  "pinData": {},
  "connections": {
    "Cron": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "MOEX History",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SecID ‚Üí Security Info1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code_SECID&market": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procent": {
      "main": [
        [
          {
            "node": "Aggregate Drops1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MOEX History": {
      "main": [
        [
          {
            "node": "Procent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Drops1": {
      "main": [
        [
          {
            "node": "Any Drops?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any Drops?": {
      "main": [
        [
          {
            "node": "Yes_5%",
            "type": "main",
            "index": 0
          },
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No_5%",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SecID ‚Üí Security Info1": {
      "main": [
        [
          {
            "node": "Code_SECID&market",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Emitent Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Emitent Info": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "da604bb4-9acc-423a-90a2-bc33745970d5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d166ce8727f20d161e3bd52d65ba171c04dab9070977d2e6555d1cb327e0c832"
  },
  "id": "eFcyWqjstZvu3fvc",
  "tags": []
}